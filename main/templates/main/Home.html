{% extends 'main/base.html' %}
{% load static %}
{% block title %}Kids Learning ‚Äî Full Interactive Edition{% endblock %}
{% block head %}
<link rel="manifest" href="{% static 'main/manifest.json' %}" />
<style>
    /* NEW: Login System Styles - Kid Friendly */
    .login-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #ff6b6b, #ffd166, #6ee7b7, #4da6ff);
        background-size: 400% 400%;
        animation: gradientBG 8s ease infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: var(--kidfont);
        overflow: hidden;
    }

    .login-container::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        background-image:
            radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    }

    @keyframes gradientBG {
        0% {
            background-position: 0% 50%
        }

        50% {
            background-position: 100% 50%
        }

        100% {
            background-position: 0% 50%
        }
    }

    .login-box {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 25px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 400px;
        width: 90%;
        border: 8px solid #ffd166;
        position: relative;
        z-index: 1;
        animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(40px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .login-title {
        font-size: 2.5rem;
        margin-bottom: 20px;
        color: #ff6b6b;
        text-shadow: 2px 2px 0px #ffd166;
        animation: titleGlow 2s ease-in-out infinite;
    }

    @keyframes titleGlow {

        0%,
        100% {
            text-shadow: 2px 2px 0px #ffd166, 0 0 10px rgba(255, 107, 107, 0);
        }

        50% {
            text-shadow: 2px 2px 0px #ffd166, 0 0 20px rgba(255, 107, 107, 0.4);
        }
    }

    .login-input {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: 3px solid #ffd166;
        border-radius: 20px;
        font-size: 1.2rem;
        font-family: var(--kidfont);
        text-align: center;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: rgba(255, 255, 255, 0.8);
    }

    .login-input:hover {
        border-color: #6ee7b7;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 5px 15px rgba(110, 231, 183, 0.2);
    }

    .login-input:focus {
        border-color: #ff6b6b;
        outline: none;
        transform: scale(1.08);
        box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        background: rgba(255, 255, 255, 1);
    }

    .login-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(90deg, #ff6b6b, #ffd166);
        border: none;
        border-radius: 20px;
        color: white;
        font-size: 1.3rem;
        font-weight: bold;
        cursor: pointer;
        margin: 15px 0;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        position: relative;
        overflow: hidden;
    }

    .login-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.2);
        transition: left 0.5s;
    }

    .login-btn:hover::before {
        left: 100%;
    }

    .login-btn:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
    }

    .login-btn:active {
        transform: translateY(-2px) scale(0.98);
    }

    .login-switch {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 15px;
        text-decoration: none;
        font-family: var(--kidfont);
        transition: all 0.3s;
        position: relative;
        padding-bottom: 3px;
    }

    .login-switch::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #ff6b6b, #ffd166);
        transition: width 0.3s;
    }

    .login-switch:hover {
        color: #ffd166;
        transform: scale(1.05);
    }

    .login-switch:hover::after {
        width: 100%;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--card);
        padding: 8px 15px;
        border-radius: 20px;
        margin-left: auto;
        border: 3px solid #ffd166;
        animation: slideInRight 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b, #ffd166);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        animation: avatarPulse 2s ease-in-out infinite;
    }

    @keyframes avatarPulse {

        0%,
        100% {
            box-shadow: 0 0 0px rgba(255, 107, 107, 0);
        }

        50% {
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
    }

    .logout-btn {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 0.8rem;
        font-family: var(--kidfont);
        transition: all 0.3s;
    }

    .logout-btn:hover {
        color: #ff3333;
        transform: scale(1.1);
    }

    .character-selection {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .floating-element {
        position: absolute;
        font-size: 2rem;
        opacity: 0.6;
        animation: float 3s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px) rotate(0deg);
        }

        50% {
            transform: translateY(-20px) rotate(2deg);
        }
    }

    .character-option {
        width: 90px;
        height: 110px;
        border-radius: 20px;
        background: linear-gradient(135deg, #fff7d6, #ffe0e0);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        cursor: pointer;
        border: 4px solid transparent;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        padding: 8px;
    }

    .character-option::after {
        content: attr(data-label);
        position: absolute;
        bottom: 8px;
        font-size: 0.75rem;
        font-weight: 700;
        color: #333;
        text-transform: capitalize;
    }

    .character-option:hover {
        transform: scale(1.12) translateY(-5px);
        box-shadow: 0 10px 25px rgba(255, 107, 107, 0.2);
        background: linear-gradient(135deg, #ffd166, #ff6b6b);
    }

    .character-option.selected {
        border-color: #ff6b6b;
        transform: scale(1.15) rotate(3deg);
        box-shadow: 0 0 30px rgba(255, 107, 107, 0.5), inset 0 0 10px rgba(255, 107, 107, 0.2);
        background: linear-gradient(135deg, #ffd166, #ff6b6b);
        animation: pulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes pulse {
        0% {
            transform: scale(1.15) rotate(3deg);
        }

        50% {
            transform: scale(1.25) rotate(3deg);
        }

        100% {
            transform: scale(1.15) rotate(3deg);
        }
    }

    .login-emoji {
        font-size: 4rem;
        margin-bottom: 10px;
        animation: bounce 2s infinite, spin 4s linear infinite;
        display: inline-block;
    }

    @keyframes bounce {

        0%,
        100% {
            transform: translateY(0) rotateZ(0deg);
        }

        50% {
            transform: translateY(-15px) rotateZ(5deg);
        }
    }

    @keyframes spin {
        0% {
            filter: hue-rotate(0deg);
        }

        100% {
            filter: hue-rotate(360deg);
        }
    }

    /* Your existing CSS */
    :root {
        --bg1: #ffdede;
        --bg2: #fff7d6;
        --card: #ffffffcc;
        --accent: #ff6b6b;
        --radius: 18px;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        --kidfont: "Baloo 2", "Comic Sans MS", system-ui, sans-serif;
        --dyslexia-font: "OpenDyslexic", "Comic Sans MS", sans-serif;
    }

    * {
        box-sizing: border-box
    }

    html,
    body {
        height: 100%
    }

    body {
        margin: 0;
        font-family: var(--kidfont);
        background: linear-gradient(135deg, var(--bg1), var(--bg2));
        -webkit-font-smoothing: antialiased;
        color: #222;
        padding-bottom: 100px;
    }

    body.dyslexia-mode {
        font-family: var(--dyslexia-font);
    }

    body.colorblind-mode {
        --accent: #0066cc;
        --bg1: #e6f2ff;
        --bg2: #fff0e6;
    }

    body.simplified-ui .tab {
        padding: 12px 16px;
        font-size: 1.2rem;
    }

    body.simplified-ui .tile {
        padding: 16px;
    }

    header {
        padding: 18px;
        text-align: center
    }

    header h1 {
        font-size: 2rem;
        margin: 0;
        color: #fff;
        text-shadow: 0 6px 18px rgba(0, 0, 0, 0.12)
    }

    .wrap {
        max-width: 1200px;
        margin: 10px auto;
        padding: 12px
    }

    .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center
    }

    .tab {
        padding: 8px 12px;
        border-radius: 14px;
        background: linear-gradient(180deg, #fff, #fff7);
        cursor: pointer;
        font-weight: 800;
        border: 3px solid rgba(255, 107, 107, 0.06)
    }

    .tab.active {
        background: linear-gradient(90deg, #ff9da0, #a0e7d6);
        transform: translateY(-4px);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08)
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 12px
    }

    .tile {
        background: var(--card);
        border-radius: 16px;
        padding: 12px;
        text-align: center;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: transform .12s;
        user-select: none
    }

    .tile:active {
        transform: scale(.98)
    }

    .emoji {
        font-size: 42px;
        margin-bottom: 8px
    }

    .big {
        font-size: 1.05rem;
        font-weight: 900
    }

    .panel {
        background: var(--card);
        border-radius: 18px;
        padding: 14px;
        box-shadow: var(--shadow)
    }

    .flash-card {
        min-height: 120px;
        border-radius: 12px;
        background: linear-gradient(180deg, #fff, #fffbf0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        font-size: 1.2rem;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06)
    }

    .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center
    }

    .mini {
        font-size: .9rem;
        color: #444
    }

    .quiz-option {
        padding: 8px;
        border-radius: 12px;
        background: linear-gradient(180deg, #fff, #fff);
        cursor: pointer;
        border: 3px solid transparent;
        font-weight: 800;
        text-align: center
    }

    .quiz-option.correct {
        border-color: #6ee7b7;
        background: linear-gradient(180deg, #e6fff2, #fff)
    }

    .quiz-option.wrong {
        border-color: #ff9fa6;
        background: linear-gradient(180deg, #fff2f2, #fff)
    }

    .trace-canvas {
        width: 100%;
        height: 260px;
        border-radius: 12px;
        border: 6px solid #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background: #fff;
        touch-action: none
    }

    .badge {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 16px;
        background: linear-gradient(90deg, #ffd166, #ff6b6b);
        font-weight: 900;
        color: #fff
    }

    .carousel {
        display: flex;
        gap: 10px;
        overflow: hidden;
        touch-action: pan-y
    }

    .card-item {
        min-width: 260px;
        flex: 0 0 260px
    }

    .drag-box {
        min-height: 110px;
        border: 2px dashed rgba(0, 0, 0, 0.06);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-content: flex-start
    }

    .draggable {
        padding: 8px 10px;
        border-radius: 12px;
        background: #fff;
        border: 2px solid rgba(0, 0, 0, 0.04);
        cursor: grab
    }

    .sticker {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08)
    }

    /* NEW STYLES FOR ADDED FEATURES */
    .emoji-rain {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9998;
    }

    .emoji-drop {
        position: absolute;
        font-size: 24px;
        animation: fall linear forwards;
    }

    @keyframes fall {
        to {
            transform: translateY(100vh);
        }
    }

    .mascot {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 80px;
        height: 80px;
        z-index: 9997;
        cursor: pointer;
        transition: transform 0.3s;
    }

    .mascot:hover {
        transform: scale(1.1);
    }

    .mascot-speech {
        position: absolute;
        bottom: 90px;
        right: 0;
        background: white;
        padding: 10px 15px;
        border-radius: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        max-width: 200px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .mascot:hover .mascot-speech {
        opacity: 1;
    }

    .highlight-text {
        background-color: yellow;
        padding: 2px 4px;
        border-radius: 4px;
        transition: background-color 0.5s;
    }

    .hindi-word {
        font-family: "Noto Sans Devanagari", sans-serif;
        font-size: 1.2em;
    }

    .balloon {
        width: 60px;
        height: 80px;
        background: #ff6b6b;
        border-radius: 50%;
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin: 10px;
        transition: transform 0.2s;
    }

    .balloon:after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 10px solid #ff6b6b;
    }

    .balloon:hover {
        transform: scale(1.1);
    }

    .balloon-pop {
        animation: pop 0.3s forwards;
    }

    @keyframes pop {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(0);
            opacity: 0;
        }
    }

    .jigsaw-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        width: 300px;
        height: 300px;
        margin: 0 auto;
    }

    .jigsaw-piece {
        border: 1px solid #ccc;
        background-size: 300px 300px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .jigsaw-piece:hover {
        transform: scale(1.05);
    }

    .simon-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

    .simon-button {
        border-radius: 20px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s, transform 0.2s;
    }

    .simon-button.active {
        opacity: 1;
        transform: scale(1.05);
    }

    .simon-red {
        background: #ff6b6b;
    }

    .simon-blue {
        background: #4da6ff;
    }

    .simon-green {
        background: #2ecc71;
    }

    .simon-yellow {
        background: #ffd166;
    }

    .progress-badge {
        display: inline-block;
        padding: 8px 12px;
        margin: 5px;
        border-radius: 20px;
        background: linear-gradient(45deg, #ff9da0, #a0e7d6);
        color: white;
        font-weight: bold;
    }

    .reward-wheel {
        width: 300px;
        height: 300px;
        border-radius: 50%;
        background: conic-gradient(#ff6b6b 0deg 60deg,
                #4da6ff 60deg 120deg,
                #2ecc71 120deg 180deg,
                #ffd166 180deg 240deg,
                #9b59b6 240deg 300deg,
                #ff9f43 300deg 360deg);
        margin: 0 auto;
        position: relative;
        cursor: pointer;
        transition: transform 3s cubic-bezier(0.2, 0.8, 0.3, 1);
    }

    .wheel-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .wallpaper-item {
        width: 150px;
        height: 100px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: border-color 0.3s;
    }

    .wallpaper-item.unlocked {
        border-color: #ff6b6b;
    }

    .wallpaper-item.locked {
        opacity: 0.5;
        filter: grayscale(1);
    }

    .wallpaper-preview {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
    }

    .slow-mode-btn {
        background: #6ee7b7;
        border: none;
        border-radius: 20px;
        padding: 5px 10px;
        font-weight: bold;
        cursor: pointer;
        margin-left: 10px;
    }

    .correct-gif {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        pointer-events: none;
    }

    /* NEW: Chapter Score Display Styles */
    .chapter-score-display {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
        justify-content: center;
    }

    .chapter-score {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 15px;
        padding: 8px 12px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        border: 2px solid #ffd166;
        min-width: 120px;
    }

    .chapter-score-icon {
        font-size: 1.5rem;
        margin-right: 8px;
    }

    .chapter-score-details {
        display: flex;
        flex-direction: column;
    }

    .chapter-score-name {
        font-size: 0.8rem;
        font-weight: bold;
        color: #555;
    }

    .chapter-score-value {
        font-size: 1rem;
        font-weight: bold;
        color: #ff6b6b;
    }

    /* NEW STYLES FOR CREATIVE FEATURES */
    .dashboard-panel {
        background: white;
        border-radius: 20px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .skill-meter {
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 10px 0;
        overflow: hidden;
        position: relative;
    }

    .skill-meter-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffd166);
        border-radius: 10px;
        transition: width 1s ease-in-out;
    }

    .story-builder {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
    }

    .story-parts {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
        justify-content: center;
    }

    .story-parts select {
        padding: 10px;
        border-radius: 10px;
        border: 3px solid #ffd166;
        font-family: var(--kidfont);
        font-size: 1rem;
    }

    .music-studio {
        text-align: center;
        padding: 20px;
    }

    .music-keys {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin: 20px 0;
    }

    .music-key {
        width: 50px;
        height: 150px;
        background: white;
        border: 2px solid #333;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 10px;
        font-weight: bold;
        transition: background 0.1s;
    }

    .music-key:active {
        background: #ffd166;
    }

    .music-key.playing {
        animation: musicGlow 0.3s ease-in-out;
    }

    .virtual-pet {
        text-align: center;
        padding: 20px;
    }

    .pet-display {
        font-size: 4rem;
        margin: 20px 0;
        transition: all 0.3s;
    }

    .pet-stats {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 15px 0;
    }

    .pet-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .voice-answer-btn {
        background: linear-gradient(90deg, #6ee7b7, #4da6ff) !important;
    }

    .ar-scanner {
        text-align: center;
        padding: 20px;
    }

    .camera-placeholder {
        width: 100%;
        height: 300px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin: 15px 0;
    }

    .emotion-characters {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .emotion-character {
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s;
        padding: 10px;
        border-radius: 10px;
        background: white;
    }

    .emotion-character:hover {
        transform: scale(1.1);
    }

    .character-face {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    .real-world-challenges {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
    }

    .challenge {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        border-left: 5px solid #ffd166;
    }

    .challenge h4 {
        margin-top: 0;
        color: #ff6b6b;
    }

    /* NEW: Settings Panel Styles */
    .settings-panel {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
    }

    .setting-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: #ff6b6b;
    }

    input:checked+.slider:before {
        transform: translateX(26px);
    }

    /* NEW: Science Explorer Styles */
    .science-experiment {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
        text-align: center;
    }

    .magnet-area {
        width: 100%;
        height: 200px;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 15px 0;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .magnet-object {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ff6b6b;
        position: absolute;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .plant-growth {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        height: 200px;
        margin: 15px 0;
    }

    .plant-stage {
        width: 80px;
        text-align: center;
        margin: 0 10px;
    }

    .plant-img {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    /* NEW: Geography Styles */
    .world-map {
        width: 100%;
        height: 300px;
        background: #e8f4f8;
        border-radius: 10px;
        margin: 15px 0;
        position: relative;
    }

    .continent {
        position: absolute;
        background: rgba(255, 107, 107, 0.7);
        border-radius: 5px;
        padding: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }

    .asia {
        top: 20%;
        left: 65%;
        width: 25%;
        height: 30%;
    }

    .europe {
        top: 15%;
        left: 45%;
        width: 15%;
        height: 15%;
    }

    .africa {
        top: 35%;
        left: 45%;
        width: 15%;
        height: 30%;
    }

    .north-america {
        top: 20%;
        left: 15%;
        width: 20%;
        height: 25%;
    }

    .south-america {
        top: 45%;
        left: 25%;
        width: 15%;
        height: 25%;
    }

    .australia {
        top: 55%;
        left: 75%;
        width: 15%;
        height: 15%;
    }

    /* NEW: Time & Clocks Styles */
    .clock-container {
        text-align: center;
        margin: 20px 0;
    }

    .clock-face {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: white;
        border: 10px solid #ffd166;
        position: relative;
        margin: 0 auto;
    }

    .clock-hand {
        position: absolute;
        background: #333;
        transform-origin: bottom center;
        left: 50%;
        top: 10%;
    }

    .hour-hand {
        width: 6px;
        height: 60px;
        margin-left: -3px;
    }

    .minute-hand {
        width: 4px;
        height: 80px;
        margin-left: -2px;
    }

    .second-hand {
        width: 2px;
        height: 90px;
        margin-left: -1px;
        background: #ff6b6b;
    }

    .clock-center {
        position: absolute;
        width: 12px;
        height: 12px;
        background: #333;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        margin-left: -6px;
        margin-top: -6px;
        z-index: 10;
    }

    /* NEW: Money & Currency Styles */
    .money-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 15px 0;
    }

    .coin {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: gold;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    .bill {
        width: 160px;
        height: 70px;
        background: green;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border-radius: 5px;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    /* NEW: Pattern Recognition Styles */
    .pattern-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .pattern-item {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: white;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
    }

    .pattern-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 15px 0;
    }

    /* NEW: Parent Dashboard Styles */
    .parent-dashboard {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
    }

    .progress-chart {
        width: 100%;
        height: 200px;
        background: #f9f9f9;
        border-radius: 10px;
        margin: 15px 0;
        position: relative;
    }

    .session-timer {
        font-size: 2rem;
        text-align: center;
        margin: 15px 0;
        font-weight: bold;
        color: #ff6b6b;
    }

    /* Animation for new features */
    @keyframes petHappy {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    .pet-display.level-up {
        animation: petHappy 0.5s ease-in-out;
    }

    @keyframes musicGlow {

        0%,
        100% {
            box-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
        }

        50% {
            box-shadow: 0 0 20px rgba(255, 107, 107, 1);
        }
    }

    @keyframes seasonalChange {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 1;
        }
    }

    .seasonal-theme {
        animation: seasonalChange 1s ease-in-out;
    }

    @media(max-width:720px) {
        .grid {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr))
        }

        .emoji {
            font-size: 34px
        }

        .card-item {
            min-width: 200px;
            flex: 0 0 200px
        }

        .mascot {
            width: 60px;
            height: 60px;
        }

        .chapter-score {
            min-width: 100px;
        }

        .story-parts {
            flex-direction: column;
        }

        .music-keys {
            flex-wrap: wrap;
        }

        .music-key {
            width: 40px;
            height: 120px;
        }

        .clock-face {
            width: 150px;
            height: 150px;
        }

        .continent {
            font-size: 0.8rem;
        }
    }

    #confettiCanvas {
        position: fixed;
        left: 0;
        top: 0;
        pointer-events: none;
        z-index: 9999
    }

    small.note {
        display: block;
        color: #555;
        margin-top: 6px
    }
</style>
{% endblock %}
{% block content %}
<!-- NEW: Login System -->
<div id="loginContainer" class="login-container">
    <div class="login-box">
        <div class="login-emoji">üë∂üéìüåü</div>
        <div class="login-title">Kids Learning Adventure</div>

        <div id="loginForm">
            <input type="text" id="loginUsername" class="login-input" placeholder="üë§ Your Name" required
                onkeypress="if(event.key==='Enter') login()">
            <input type="password" id="loginPassword" class="login-input" placeholder="üîí Secret Code" required
                onkeypress="if(event.key==='Enter') login()">

            <div style="display:flex;gap:12px;margin:16px 0;flex-wrap:wrap">
                <div style="flex:1;min-width:140px;text-align:center">
                    <div class="character-option" data-char="üë¶" data-label="boy" onclick="selectCharacter(this)"
                        style="margin-bottom:10px">üë¶</div>
                </div>
                <div style="flex:1;min-width:140px;text-align:center">
                    <div class="character-option" data-char="üëß" data-label="girl" onclick="selectCharacter(this)"
                        style="margin-bottom:10px">üëß</div>
                </div>
            </div>

            <button class="login-btn" onclick="login()">Let's Play! üéÆ</button>
            <button class="login-switch" onclick="showRegister()">New Friend? Join Here!</button>
        </div>

        <div id="registerForm" style="display: none;">
            <input type="text" id="registerUsername" class="login-input" placeholder="üë§ Choose Your Name" required>
            <input type="password" id="registerPassword" class="login-input" placeholder="üîí Create Secret Code"
                required>
            <input type="password" id="confirmPassword" class="login-input" placeholder="üîí Repeat Secret Code"
                required>

            <div class="character-selection">
                <div class="character-option" data-char="üë¶" data-label="boy" onclick="selectCharacter(this)">üë¶</div>
                <div class="character-option" data-char="üëß" data-label="girl" onclick="selectCharacter(this)">üëß</div>
            </div>

            <div style="display:flex;gap:10px;margin:12px 0;flex-wrap:wrap">
                <div style="flex:1;min-width:150px">
                    <label style="display:block;margin-bottom:6px;font-weight:700">üé§ Voice Type:</label>
                    <select id="registerVoice" style="width:100%;padding:8px;border-radius:6px;border:2px solid #ddd">
                        <option value="default">Default</option>
                        <option value="cheerful">Cheerful</option>
                        <option value="calm">Calm</option>
                        <option value="energetic">Energetic</option>
                    </select>
                </div>
            </div>

            <button class="login-btn" onclick="register()">Create My Account! ‚ú®</button>
            <button class="login-switch" onclick="showLogin()">Back to Login</button>
        </div>
    </div>
</div>

<!-- Modified Header with User Info -->
<header>
    <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 20px;">
        <h1>üåü Kids Learning Adventure ‚Äî Full Edition</h1>
        <div class="user-info" id="userInfo" style="display: none;">
            <div class="user-avatar" id="userAvatar">üë§</div>
            <div>
                <div class="mini" id="userName">Friend</div>
                <button class="logout-btn" onclick="logout()">Switch Friend</button>
            </div>
        </div>
    </div>
    <div class="mini" style="color:#fff">Cartoon, interactive, multi-games, phonics & more ‚Äî all offline</div>
</header>

<!-- Main Content (only shown when logged in) -->
<div class="wrap" id="mainContent" style="display: none;">
    <!-- NEW: Chapter Scores Display -->
    <div class="panel">
        <h3>My Learning Progress</h3>
        <div class="chapter-score-display" id="chapterScoreDisplay"></div>
    </div>

    <div class="tabs" id="mainTabs">
        <div class="tab active" data-tab="home" onclick="switchTab('home',this)">Home</div>
        <div class="tab" data-tab="alphabet" onclick="switchTab('alphabet',this)">Alphabet</div>
        <div class="tab" data-tab="numbers" onclick="switchTab('numbers',this)">Numbers</div>
        <div class="tab" data-tab="colors" onclick="switchTab('colors',this)">Colors</div>
        <div class="tab" data-tab="shapes" onclick="switchTab('shapes',this)">Shapes</div>
        <div class="tab" data-tab="fruits" onclick="switchTab('fruits',this)">Fruits</div>
        <div class="tab" data-tab="body" onclick="switchTab('body',this)">Body Parts</div>
        <div class="tab" data-tab="vehicles" onclick="switchTab('vehicles',this)">Vehicles</div>
        <div class="tab" data-tab="season" onclick="switchTab('season',this)">Seasons/Weather</div>
        <div class="tab" data-tab="classroom" onclick="switchTab('classroom',this)">Classroom</div>
        <div class="tab" data-tab="games" onclick="switchTab('games',this)">Games</div>
        <div class="tab" data-tab="trace" onclick="switchTab('trace',this)">Trace</div>
        <div class="tab" data-tab="poems" onclick="switchTab('poems',this)">Poems</div>
        <div class="tab" data-tab="stories" onclick="switchTab('stories',this)">Moral Stories</div>
        <div class="tab" data-tab="store" onclick="switchTab('store',this)">Sticker Store</div>
        <div class="tab" data-tab="rewards" onclick="switchTab('rewards',this)">Rewards</div>
        <div class="tab" data-tab="hindi" onclick="switchTab('hindi',this)">Hindi</div>
        <div class="tab" data-tab="opposites" onclick="switchTab('opposites',this)">Opposites</div>
        <div class="tab" data-tab="animals" onclick="switchTab('animals',this)">Farm Animals</div>
        <!-- NEW CREATIVE TABS -->
        <div class="tab" data-tab="dashboard" onclick="switchTab('dashboard',this)">My Dashboard</div>
        <div class="tab" data-tab="storymaker" onclick="switchTab('storymaker',this)">Story Maker</div>
        <div class="tab" data-tab="music" onclick="switchTab('music',this)">Music Fun</div>
        <div class="tab" data-tab="multiplication" onclick="switchTab('multiplication',this)">√ó Multiplication</div>
        <div class="tab" data-tab="reading" onclick="switchTab('reading',this)">üìñ Reading</div>
        <div class="tab" data-tab="grade_math" onclick="switchTab('grade_math',this)">üî¢ Grade Math</div>
        <div class="tab" data-tab="timedquiz" onclick="switchTab('timedquiz',this)">‚è±Ô∏è Timed Quiz</div>
        <div class="tab" data-tab="emotions" onclick="switchTab('emotions',this)">Feelings</div>
        <div class="tab" data-tab="challenges" onclick="switchTab('challenges',this)">Home Adventures</div>
        <!-- NEW LEARNING MODULES -->
        <div class="tab" data-tab="science" onclick="switchTab('science',this)">Science Explorer</div>
        <div class="tab" data-tab="geography" onclick="switchTab('geography',this)">Geography</div>
        <div class="tab" data-tab="time" onclick="switchTab('time',this)">Time & Clocks</div>
        <div class="tab" data-tab="money" onclick="switchTab('money',this)">Money & Currency</div>
        <div class="tab" data-tab="patterns" onclick="switchTab('patterns',this)">Patterns</div>
        <!-- NEW ACCESSIBILITY & PARENT FEATURES -->
        <div class="tab" data-tab="settings" onclick="switchTab('settings',this)">Settings</div>
        <div class="tab" data-tab="parent" onclick="switchTab('parent',this)">Parent Dashboard</div>
        <div class="tab" data-tab="translator" onclick="switchTab('translator',this)">üåç Translator</div>
        <!-- NEW GAMES & TOOLS -->
        <div class="tab" data-tab="drawing" onclick="switchTab('drawing',this)">üé® Drawing</div>
        <div class="tab" data-tab="mathquiz" onclick="switchTab('mathquiz',this)">üßÆ Math Quiz</div>
        <div class="tab" data-tab="voicerecord" onclick="switchTab('voicerecord',this)">üé§ Voice</div>
        <div class="tab" data-tab="storyread" onclick="switchTab('storyread',this)">üìö Stories</div>
        <div class="tab" data-tab="puzzle" onclick="switchTab('puzzle',this)">üéÆ Puzzle</div>
        <div class="tab" data-tab="achievements" onclick="switchTab('achievements',this)">üèÖ Badges</div>
        <div class="tab" data-tab="challenges_daily" onclick="switchTab('challenges_daily',this)">üéØ Daily</div>
        <div class="tab" data-tab="spelling" onclick="switchTab('spelling',this)">‚úèÔ∏è Spelling</div>
        <div class="tab" data-tab="wordmatch" onclick="switchTab('wordmatch',this)">üî§ Words</div>
        <div class="tab" data-tab="truefals" onclick="switchTab('truefals',this)">‚ùì True/False</div>
        <div class="tab" data-tab="counting" onclick="switchTab('counting',this)">üî¢ Counting</div>
        <div class="tab" data-tab="shapes_sort" onclick="switchTab('shapes_sort',this)">üìê Shapes</div>
        <div class="tab" data-tab="spotdiff" onclick="switchTab('spotdiff',this)">üîç Spot It</div>
        <div class="tab" data-tab="features" onclick="switchTab('features',this)">üåü Features</div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin:12px 0">
        <div class="panel" style="flex:1">
            <div style="display:flex;gap:12px;align-items:center">
                <div class="badge" id="pointsBadge">Stars: 0</div>
                <div class="mini" style="margin-left:8px">Earn stars for learning & games</div>
            </div>
        </div>
        <div style="display:flex;gap:8px">
            <button class="tab" onclick="speakText('Hello friend! Tap anything to hear and learn')">Help</button>
            <button class="tab" onclick="resetProgress()">Reset</button>
        </div>
    </div>

    <!-- HOME -->
    <div id="home" class="panel">
        <h3>Welcome, <span id="welcomeName">Friend</span>! <span id="userCharacter">üë§</span></h3>
        <div class="grid" id="homeGrid"></div>
        <hr />
        <h4>Quick play</h4>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="tile" onclick="switchTab('alphabet', document.querySelector('.tab[data-tab=alphabet]'))">
                <div class="emoji">üî§</div>
                <div class="big">Alphabet</div>
            </div>
            <div class="tile" onclick="switchTab('numbers', document.querySelector('.tab[data-tab=numbers]'))">
                <div class="emoji">üî¢</div>
                <div class="big">Numbers</div>
            </div>
            <div class="tile" onclick="switchTab('games', document.querySelector('.tab[data-tab=games]'))">
                <div class="emoji">üéÆ</div>
                <div class="big">Games</div>
            </div>
        </div>
    </div>

    <!-- Alphabet -->
    <div id="alphabet" class="panel" style="display:none;margin-top:12px">
        <h3>Alphabet ‚Äî Tap a letter (with phonics & examples)</h3>
        <small class="note">Phonics show approximate sound and 2 example words per letter</small>
        <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
            <div style="flex:1">
                <div class="grid" id="alphabetGrid"></div>
            </div>
            <div style="width:320px">
                <div class="panel flash-card" id="alphaBig">A ‚Äî Apple üçé</div>
                <div class="mini" id="alphaPhonics"></div>
                <div style="margin-top:10px" class="controls">
                    <button class="tab" onclick="alphaPrev()">‚óÄ</button>
                    <button class="tab" onclick="alphaSpeak()">üîä</button>
                    <button class="tab slow-mode-btn" onclick="alphaSpeakSlow()">Slow üîä</button>
                    <button class="tab" onclick="alphaNext()">‚ñ∂</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Numbers -->
    <div id="numbers" class="panel" style="display:none;margin-top:12px">
        <h3>Numbers ‚Äî Count to 100</h3>
        <small class="note">Tap multiples to hear / play math mini-game</small>
        <div class="controls" style="margin-bottom:10px">
            <button class="tab" onclick="speakAllNumbers()">Speak 1‚Äì20</button>
            <button class="tab" onclick="playCountingSong()">Counting Song</button>
            <button class="tab" onclick="openMathGame()">Math Game</button>
        </div>
        <div id="numbersGridLarge" class="grid"></div>
        <div id="countPictures" style="margin-top:12px"></div>
    </div>

    <!-- Colors -->
    <div id="colors" class="panel" style="display:none;margin-top:12px">
        <h3>Colors ‚Äî Tap to hear & see</h3>
        <div class="grid" id="colorsGrid"></div>
    </div>

    <!-- Shapes -->
    <div id="shapes" class="panel" style="display:none;margin-top:12px">
        <h3>Shapes</h3>
        <div class="grid" id="shapesGrid"></div>
    </div>

    <!-- Fruits & Vegetables -->
    <div id="fruits" class="panel" style="display:none;margin-top:12px">
        <h3>Fruits & Vegetables</h3>
        <div class="grid" id="fruitsGrid"></div>
    </div>

    <!-- Body parts -->
    <div id="body" class="panel" style="display:none;margin-top:12px">
        <h3>Body Parts</h3>
        <div class="grid" id="bodyGrid"></div>
    </div>

    <!-- Vehicles -->
    <div id="vehicles" class="panel" style="display:none;margin-top:12px">
        <h3>Vehicles</h3>
        <div class="grid" id="vehiclesGrid"></div>
    </div>

    <!-- Season/Weather -->
    <div id="season" class="panel" style="display:none;margin-top:12px">
        <h3>Seasons & Weather</h3>
        <div class="grid" id="seasonGrid"></div>
    </div>

    <!-- Classroom -->
    <div id="classroom" class="panel" style="display:none;margin-top:12px">
        <h3>Classroom Objects</h3>
        <div class="grid" id="classGrid"></div>
    </div>

    <!-- MY DASHBOARD -->
    <div id="dashboard" class="panel" style="display:none;margin-top:12px">
        <h3>üìä My Dashboard ‚Äî Your Learning Progress</h3>
        <div id="dashboardContent" style="padding: 12px 0;">
            <div style="text-align: center; padding: 20px;">
                <p style="color: #999;">Loading your dashboard...</p>
            </div>
        </div>
        <script>
            function initDashboard() {
                if (!currentUser || !users[currentUser]) return;
                const user = users[currentUser];
                const stats = {
                    'stars': user.stars || 0,
                    'chapters': Object.keys(user.chapters || {}).length,
                    'score': Math.round((user.stars || 0) / 10),
                    'streak': user.streak || 0
                };
                const dashboard = document.getElementById('dashboardContent');
                dashboard.innerHTML = '';
                dashboard.appendChild(ProgressVisualization.createStatsDashboard(stats));

                const progressContainer = document.createElement('div');
                progressContainer.style.marginTop = '20px';
                const chapters = user.chapters || {};
                ProgressVisualization.createProgressBar(progressContainer, Object.keys(chapters).length, 50, 'üìö Chapters Completed');
                dashboard.appendChild(progressContainer);

                const badgeSection = document.createElement('div');
                badgeSection.style.marginTop = '20px';
                badgeSection.innerHTML = '<h4 style="margin-top: 0;">üèÜ Your Badges</h4>';
                badgeSection.appendChild(AchievementDisplay.createBadgeCollection());
                dashboard.appendChild(badgeSection);
            }
            document.querySelectorAll('.tab[data-tab="dashboard"]').forEach(tab => {
                tab.addEventListener('click', () => setTimeout(initDashboard, 100));
            });
        </script>
    </div>

    <!-- FEATURES SHOWCASE -->
    <div id="features" class="panel" style="display:none;margin-top:12px">
        <h3>üåü Features ‚Äî Complete Guide</h3>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
            <div
                style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(110, 231, 183, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">üîä</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Pronunciation</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Learn correct sounds with voice customization and
                    proficiency tracking.</p>
            </div>
            <div
                style="background: linear-gradient(135deg, rgba(255, 209, 102, 0.1), rgba(76, 218, 255, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">üèÜ</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Achievements</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Unlock badges as you learn and complete
                    challenges. 10+ achievement types!</p>
            </div>
            <div
                style="background: linear-gradient(135deg, rgba(110, 231, 183, 0.1), rgba(255, 107, 107, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">‚≠ê</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Star System</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Earn stars for completing lessons and games. Trade
                    stars for rewards!</p>
            </div>
            <div
                style="background: linear-gradient(135deg, rgba(76, 218, 255, 0.1), rgba(255, 209, 102, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">üéÆ</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Interactive Games</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Match, drag-drop, spelling, puzzles, and more! 50+
                    learning activities.</p>
            </div>
            <div
                style="background: linear-gradient(135deg, rgba(255, 209, 102, 0.1), rgba(110, 231, 183, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">‚ú®</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Animations</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Smooth animations, particle effects, and visual
                    feedback for every action.</p>
            </div>
            <div
                style="background: linear-gradient(135deg, rgba(76, 218, 255, 0.1), rgba(255, 107, 107, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">üì±</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Responsive Design</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Works perfectly on phones, tablets, and computers.
                    Touch-friendly!</p>
            </div>
            <div
                style="background: linear-gradient(135deg, rgba(110, 231, 183, 0.1), rgba(255, 209, 102, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid #ffd166;">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">üé®</div>
                <h4 style="margin: 0 0 8px 0; color: #333;">Creative Tools</h4>
                <p style="margin: 0; font-size: 0.9rem; color: #666;">Drawing, story maker, music, and more creative
                    activities for expression.</p>
            </div>
        </div>
        <div
            style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #ffd166, #ff6b6b); border-radius: 12px; text-align: center; color: white;">
            <h3 style="margin: 0 0 10px 0;">üöÄ Ready to Learn?</h3>
            <p style="margin: 0 0 15px 0; font-size: 0.95rem;">Choose any chapter above to start your amazing learning
                journey!</p>
            <button
                onclick="switchTab('alphabet', document.querySelector('.tab[data-tab=alphabet]')); ParticleEffects.celebrationConfetti();"
                style="
                padding: 12px 24px;
                background: white;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                color: #ff6b6b;
                cursor: pointer;
                font-size: 1rem;
                font-family: var(--kidfont);
            ">Start Learning Now! üìö</button>
        </div>
    </div>

    <!-- Games -->
    <div id="games" class="panel" style="display:none;margin-top:12px">
        <h3>Games ‚Äî Matching, Drag-Drop, Spelling, Puzzle, Find & Quiz</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:320px" class="panel">
                <h4>Memory Matching (flip)</h4>
                <div id="matchBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px"></div>
                <div class="controls"><button class="tab" onclick="startMatch()">Start</button>
                    <div id="matchScore" class="mini" style="margin-left:auto"></div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Drag & Drop ‚Äî Word ‚Üí Picture</h4>
                <div class="drag-box" id="dragTargets"></div>
                <div class="drag-box" id="dragPool" style="margin-top:8px"></div>
                <div class="controls"><button class="tab" onclick="startDragDrop()">Start</button>
                    <div id="dragScore" class="mini" style="margin-left:auto"></div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Spelling Game</h4>
                <div id="spellWord" class="flash-card">Press Start</div>
                <div id="spellLetters" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
                <div class="controls"><button class="tab" onclick="startSpelling()">Start</button>
                    <div id="spellScore" class="mini" style="margin-left:auto"></div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Puzzle (shuffle pieces)</h4>
                <div id="puzzleArea" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px"></div>
                <div class="controls"><button class="tab" onclick="startPuzzle()">Shuffle</button>
                    <div id="puzzleStatus" class="mini" style="margin-left:auto"></div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Find the object</h4>
                <div id="findArea" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
                <div class="controls"><button class="tab" onclick="startFind()">New</button>
                    <div id="findStatus" class="mini" style="margin-left:auto"></div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Quick MCQ Quiz</h4>
                <div id="quizQ" class="mini" style="font-weight:900">Tap the Cat</div>
                <div class="grid" id="quizOptions"></div>
                <div class="controls"><button class="tab" onclick="generateQuiz()">New Quiz</button>
                    <div id="quizScore" class="mini" style="margin-left:auto">Score:0</div>
                </div>
            </div>
        </div>

        <!-- NEW GAMES SECTION -->
        <h3 style="margin-top: 20px;">New Games</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:320px" class="panel">
                <h4>Balloon Pop Quiz</h4>
                <div id="balloonContainer" style="display:flex;flex-wrap:wrap;justify-content:center"></div>
                <div class="controls"><button class="tab" onclick="startBalloonGame()">Start</button>
                    <div id="balloonScore" class="mini" style="margin-left:auto">Score:0</div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Odd One Out</h4>
                <div id="oddOneContainer" style="display:flex;flex-wrap:wrap;justify-content:center"></div>
                <div class="controls"><button class="tab" onclick="startOddOneOut()">New</button>
                    <div id="oddOneScore" class="mini" style="margin-left:auto">Score:0</div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Jigsaw Puzzle</h4>
                <div id="jigsawContainer" class="jigsaw-container"></div>
                <div class="controls"><button class="tab" onclick="startJigsaw()">Shuffle</button>
                    <div id="jigsawStatus" class="mini" style="margin-left:auto"></div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Fast Flash Quiz (10 sec)</h4>
                <div id="flashQuizQuestion" class="flash-card">Ready?</div>
                <div id="flashQuizOptions" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px"></div>
                <div class="controls">
                    <button class="tab" onclick="startFlashQuiz()">Start</button>
                    <div id="flashTimer" class="mini" style="margin-left:auto">Time: 10s</div>
                </div>
            </div>

            <div style="flex:1;min-width:320px" class="panel">
                <h4>Simon Memory Game</h4>
                <div class="simon-container" id="simonContainer">
                    <div class="simon-button simon-red" data-color="red"></div>
                    <div class="simon-button simon-blue" data-color="blue"></div>
                    <div class="simon-button simon-green" data-color="green"></div>
                    <div class="simon-button simon-yellow" data-color="yellow"></div>
                </div>
                <div class="controls">
                    <button class="tab" onclick="startSimon()">Start</button>
                    <div id="simonLevel" class="mini" style="margin-left:auto">Level: 1</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trace -->
    <div id="trace" class="panel" style="display:none;margin-top:12px">
        <h3>Trace Letters A‚ÄìZ</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1"><canvas id="traceCanvas" class="trace-canvas" width="840" height="260"></canvas>
            </div>
            <div style="width:220px">
                <div style="margin-bottom:8px">Choose letter</div>
                <div id="traceButtons" style="display:flex;flex-wrap:wrap;gap:8px"></div>
                <div class="controls" style="margin-top:12px"><button class="tab"
                        onclick="clearTrace()">Clear</button><button class="tab" onclick="saveTrace()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Poems -->
    <div id="poems" class="panel" style="display:none;margin-top:12px">
        <h3>Poems & Rhymes ‚Äî Auto read line-by-line</h3>
        <div class="grid" id="poemGrid"></div>
        <div id="poemPlayArea" class="panel mini" style="margin-top:12px"></div>
    </div>

    <!-- Stories -->
    <div id="stories" class="panel" style="display:none;margin-top:12px">
        <h3>Moral Short Stories</h3>
        <div id="storiesList"></div>
    </div>

    <!-- Sticker store -->
    <div id="store" class="panel" style="display:none;margin-top:12px">
        <h3>Sticker Store</h3>
        <div id="storeItems" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        <div class="panel mini" id="inventory" style="margin-top:8px">Your stickers:</div>
    </div>

    <!-- Rewards -->
    <div id="rewards" class="panel" style="display:none;margin-top:12px">
        <h3>Rewards & Progress</h3>
        <div id="progressBadges" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px"></div>

        <h4>Daily Reward Wheel</h4>
        <div style="text-align:center">
            <div class="reward-wheel" id="rewardWheel">
                <div class="wheel-center">SPIN</div>
            </div>
            <div id="wheelResult" style="margin-top:10px;font-weight:bold"></div>
        </div>

        <h4 style="margin-top:20px;">Unlockable Wallpapers</h4>
        <div id="wallpaperCollection" style="display:flex;flex-wrap:wrap;justify-content:center"></div>
    </div>

    <!-- Hindi -->
    <div id="hindi" class="panel" style="display:none;margin-top:12px">
        <h3>Hindi Words & Sentences</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
            <div>
                <label for="hindiVoice">Voice:</label>
                <select id="hindiVoice"></select>
            </div>
            <div>
                <label for="hindiSpeed">Speed:</label>
                <input id="hindiSpeed" type="range" min="0.5" max="1.2" step="0.05" value="0.85" />
            </div>
            <div>
                <button class="tab" id="playSample">üîä Play Sample Sentence</button>
                <button class="tab" id="pronounceToggle">üìù Toggle Transliteration</button>
            </div>
        </div>

        <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
                <h4>Words</h4>
                <div class="grid" id="hindiGrid"></div>
            </div>
            <div style="flex:1;min-width:260px">
                <h4>Sentences</h4>
                <div id="hindiSentences" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>
        </div>
    </div>

    <!-- Opposites -->
    <div id="opposites" class="panel" style="display:none;margin-top:12px">
        <h3>Opposites</h3>
        <div class="grid" id="oppositesGrid"></div>
    </div>

    <!-- Farm Animals -->
    <div id="animals" class="panel" style="display:none;margin-top:12px">
        <h3>Farm Animals</h3>
        <div class="grid" id="animalsGrid"></div>
    </div>

    <!-- Memory Match Game -->
    <div id="memory" class="panel" style="display:none;margin-top:12px">
        <h3>üß© Memory Match</h3>
        <div id="memoryArea" style="display:flex;flex-direction:column;align-items:center;gap:12px">
            <div id="memoryBoard" style="display:grid;grid-template-columns:repeat(4,120px);gap:12px"></div>
            <div style="display:flex;gap:8px">
                <button class="tab" id="memoryRestart">Restart</button>
                <div id="memoryScore" style="align-self:center">Score: 0</div>
            </div>
        </div>
    </div>

    <!-- Translator -->
    <div id="translator" class="panel" style="display:none;margin-top:12px">
        <h3>üåç Multi-Language Translator</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <div>
                    <label for="transFrom">From:</label>
                    <select id="transFrom" style="padding:6px">
                        <option value="en">English</option>
                        <option value="hi">Hindi</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div>
                    <label for="transTo">To:</label>
                    <select id="transTo" style="padding:6px">
                        <option value="hi">Hindi</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <button class="tab" id="swapLangs">üîÑ Swap</button>
            </div>
            <textarea id="transInput" placeholder="Type text to translate..."
                style="padding:10px;border-radius:8px;border:2px solid #ccc;font-size:16px;height:100px;font-family:Arial"></textarea>
            <div style="display:flex;gap:8px">
                <button class="tab" id="doTranslate">üìù Translate</button>
                <button class="tab" id="clearTrans">Clear</button>
            </div>
            <div id="transResult"
                style="background:#f0f0f0;padding:12px;border-radius:8px;min-height:60px;border-left:4px solid #4da6ff">
                <strong>Translation:</strong>
                <div id="transOutput" style="margin-top:8px;font-size:1.1rem;color:#333"></div>
                <button class="tab" id="speakTrans" style="margin-top:8px;display:none">üîä Speak</button>
            </div>
        </div>
    </div>

    <!-- Drawing & Coloring Tool -->
    <div id="drawing" class="panel" style="display:none;margin-top:12px">
        <h3>üé® Drawing & Coloring</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <label>Color: <input type="color" id="drawColor" value="#ff0000" style="cursor:pointer"></label>
                <label>Brush: <input type="range" id="drawSize" min="1" max="30" value="5"></label>
                <button class="tab" id="drawClear">Clear</button>
                <button class="tab" id="drawSave">üíæ Save</button>
            </div>
            <canvas id="drawCanvas"
                style="border:2px solid #ddd;border-radius:8px;background:white;cursor:crosshair;width:100%;height:300px"></canvas>
        </div>
    </div>

    <!-- Math Quiz Game -->
    <div id="mathquiz" class="panel" style="display:none;margin-top:12px">
        <h3>üßÆ Math Quiz</h3>
        <div id="mathQuizContent" style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;gap:8px">
                <label>Level: <select id="mathLevel" style="padding:6px">
                        <option value="easy">Easy (1-10)</option>
                        <option value="medium">Medium (1-50)</option>
                        <option value="hard">Hard (1-100)</option>
                    </select></label>
                <button class="tab" id="mathStart">Start Quiz</button>
            </div>
            <div id="mathQuestion" style="font-size:1.3rem;font-weight:700;color:#333"></div>
            <input type="text" id="mathAnswer" placeholder="Enter answer"
                style="padding:10px;border:2px solid #ccc;border-radius:8px;font-size:16px">
            <div style="display:flex;gap:8px">
                <button class="tab" id="mathSubmit">Submit</button>
                <div id="mathScore" style="align-self:center">Score: 0/0</div>
            </div>
            <div id="mathFeedback" style="padding:10px;border-radius:8px;background:#e8f5e9;display:none"></div>
        </div>
    </div>

    <!-- Voice Recording -->
    <div id="voicerecord" class="panel" style="display:none;margin-top:12px">
        <h3>üé§ Voice Recording & Pronunciation</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <select id="voicePhrase" style="padding:6px">
                    <option value="">Choose a phrase...</option>
                    <option value="hello">Hello</option>
                    <option value="thank you">Thank you</option>
                    <option value="apple">Apple</option>
                    <option value="water">Water</option>
                    <option value="rainbow">Rainbow</option>
                </select>
                <button class="tab" id="voicePlay">üîä Hear</button>
                <button class="tab" id="voiceRecord">üéôÔ∏è Record Me</button>
                <button class="tab" id="voiceStop">‚èπÔ∏è Stop</button>
            </div>
            <canvas id="voiceWaveform"
                style="border:2px solid #ddd;border-radius:8px;background:#f9f9f9;width:100%;height:80px"></canvas>
            <div id="voicePlayback" style="padding:10px;background:#e3f2fd;border-radius:8px;display:none">
                <p><strong>Your Recording:</strong></p>
                <audio id="voiceAudio" style="width:100%"></audio>
            </div>
        </div>
    </div>

    <!-- Story Reading -->
    <div id="storyread" class="panel" style="display:none;margin-top:12px">
        <h3>üìö Story Reading with Audio</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <select id="storySelect" style="padding:8px">
                <option value="">Select a story...</option>
                <option value="littleseed">The Little Seed</option>
                <option value="kindchild">The Kind Child</option>
                <option value="adventure">Adventure in Forest</option>
            </select>
            <div id="storyText"
                style="background:#fff9e6;padding:15px;border-radius:8px;min-height:150px;line-height:1.6;font-size:1.1rem;border-left:4px solid #ffc107">
            </div>
            <div style="display:flex;gap:8px">
                <button class="tab" id="storyRead">üìñ Read Aloud</button>
                <button class="tab" id="storyPause">‚è∏Ô∏è Pause</button>
                <label>Speed: <input type="range" id="storySpeed" min="0.5" max="1.5" step="0.1" value="1"
                        style="width:100px"></label>
            </div>
        </div>
    </div>

    <!-- Puzzle Game -->
    <div id="puzzle" class="panel" style="display:none;margin-top:12px">
        <h3>üéÆ Puzzle Game</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;gap:8px">
                <select id="puzzleType" style="padding:6px">
                    <option value="pattern">Pattern Match</option>
                    <option value="slide">Sliding Puzzle</option>
                    <option value="memory">Memory Match</option>
                </select>
                <button class="tab" id="puzzleStart">Start Game</button>
            </div>
            <div id="puzzleBoard"
                style="display:grid;grid-template-columns:repeat(3,100px);gap:10px;justify-content:center"></div>
            <div style="text-align:center;font-size:1.2rem;font-weight:700">
                Moves: <span id="puzzleMoves">0</span> | Time: <span id="puzzleTime">0</span>s
            </div>
        </div>
    </div>

    <!-- Achievement Badges -->
    <div id="achievements" class="panel" style="display:none;margin-top:12px">
        <h3>üèÖ Achievement Badges</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <p style="color:#666">Unlock badges by completing challenges!</p>
            <div id="badgesGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px">
            </div>
            <div style="background:#f0f0f0;padding:12px;border-radius:8px;margin-top:10px">
                <strong>Total Badges: <span id="badgeCount">0</span>/12</strong>
                <div id="badgeProgress"
                    style="width:100%;height:20px;background:#ddd;border-radius:10px;margin-top:8px">
                    <div id="badgeProgressBar"
                        style="width:0%;height:100%;background:#4caf50;border-radius:10px;transition:width 0.3s"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Challenges -->
    <div id="challenges_daily" class="panel" style="display:none;margin-top:12px">
        <h3>üéØ Daily Challenges</h3>
        <div style="display:flex;flex-direction:column;gap:12px">
            <div style="background:#fff3e0;padding:12px;border-radius:8px;border-left:4px solid #ff9800">
                <p><strong>Today's Challenges:</strong></p>
                <div id="dailyChallenges"></div>
            </div>
            <div style="background:#f3e5f5;padding:12px;border-radius:8px">
                <h4>Weekly Progress</h4>
                <div id="weeklyProgress" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px"></div>
            </div>
            <div style="text-align:center;font-size:1.3rem;font-weight:700">
                Streak: <span id="streakCount">0</span> üî•
            </div>
        </div>
    </div>

    <!-- NEW CREATIVE FEATURES -->

    <!-- Dashboard -->
    <div id="dashboard" class="panel" style="display:none;margin-top:12px">
        <h3>üìä My Learning Dashboard</h3>
        <div id="dashboardContent"></div>
    </div>

    <!-- Story Maker -->
    <div id="storymaker" class="panel" style="display:none;margin-top:12px">
        <h3>‚úçÔ∏è Create Your Own Story!</h3>
        <div id="storyBuilderContent"></div>
    </div>

    <!-- Music Fun -->
    <div id="music" class="panel" style="display:none;margin-top:12px">
        <h3>üéµ Music Maker</h3>
        <div id="musicStudioContent"></div>
    </div>

    <!-- Emotions -->
    <div id="emotions" class="panel" style="display:none;margin-top:12px">
        <h3>üòä Feelings & Friends</h3>
        <div id="emotionsContent"></div>
    </div>

    <!-- Home Adventures -->
    <div id="challenges" class="panel" style="display:none;margin-top:12px">
        <h3>üåç Learning Adventures in Your Home!</h3>
        <div id="challengesContent"></div>
    </div>

    <!-- NEW LEARNING MODULES -->

    <!-- Science Explorer -->
    <div id="science" class="panel" style="display:none;margin-top:12px">
        <h3>üî¨ Science Explorer</h3>
        <div id="scienceContent"></div>
    </div>

    <!-- Geography Adventure -->
    <div id="geography" class="panel" style="display:none;margin-top:12px">
        <h3>üåç Geography Adventure</h3>
        <div id="geographyContent"></div>
    </div>

    <!-- Time & Clocks -->
    <div id="time" class="panel" style="display:none;margin-top:12px">
        <h3>‚è∞ Time & Clocks</h3>
        <div id="timeContent"></div>
    </div>

    <!-- Money & Currency -->
    <div id="money" class="panel" style="display:none;margin-top:12px">
        <h3>üí∞ Money & Currency</h3>
        <div id="moneyContent"></div>
    </div>

    <!-- Pattern Recognition -->
    <div id="patterns" class="panel" style="display:none;margin-top:12px">
        <h3>üîÅ Pattern Recognition</h3>
        <div id="patternsContent"></div>
    </div>

    <!-- MULTIPLICATION MODULE -->
    <div id="multiplication" class="panel" style="display:none;margin-top:12px">
        <h3>√ó Multiplication Practice</h3>
        <p style="color:#666;margin:10px 0">Practice times tables with quick questions</p>
        <div id="multiplicationModule"></div>
    </div>

    <!-- READING MODULE -->
    <div id="reading" class="panel" style="display:none;margin-top:12px">
        <h3>üìñ Reading ‚Äî Leveled</h3>
        <p style="color:#666;margin:10px 0">Short leveled passages with read-aloud</p>
        <div id="readingModule"></div>
    </div>

    <!-- GRADE MATH -->
    <div id="grade_math" class="panel" style="display:none;margin-top:12px">
        <h3>üî¢ Grade Math</h3>
        <p style="color:#666;margin:10px 0">Choose grade level and try a sample activity</p>
        <div id="gradeMathModule"></div>
    </div>

    <!-- TIMED QUIZ -->
    <div id="timedquiz" class="panel" style="display:none;margin-top:12px">
        <h3>‚è±Ô∏è Timed Quiz</h3>
        <p style="color:#666;margin:10px 0">Short timed questions to build fluency</p>
        <div id="timedQuiz"></div>
    </div>

    <!-- SPELLING CHALLENGE -->
    <div id="spelling" class="panel" style="display:none;margin-top:12px">
        <h3>‚úèÔ∏è Spelling Challenge</h3>
        <p style="color:#666;margin:10px 0">Listen to the word and tap the correct spelling</p>
        <div id="spellingQuiz" style="display:grid;gap:15px"></div>
    </div>

    <!-- WORD MATCHING -->
    <div id="wordmatch" class="panel" style="display:none;margin-top:12px">
        <h3>üî§ Word Matching</h3>
        <p style="color:#666;margin:10px 0">Match the picture to the correct word</p>
        <div id="wordmatchGame" style="display:grid;gap:15px"></div>
    </div>

    <!-- TRUE OR FALSE -->
    <div id="truefals" class="panel" style="display:none;margin-top:12px">
        <h3>‚ùì True or False</h3>
        <p style="color:#666;margin:10px 0">Read the statement and decide if it's true or false</p>
        <div id="truefalseGame" style="display:grid;gap:15px"></div>
    </div>

    <!-- COUNTING GAME -->
    <div id="counting" class="panel" style="display:none;margin-top:12px">
        <h3>üî¢ Counting Game</h3>
        <p style="color:#666;margin:10px 0">Count the items and tap the correct number</p>
        <div id="countingGame" style="display:grid;gap:15px"></div>
    </div>

    <!-- SHAPE SORTING -->
    <div id="shapes_sort" class="panel" style="display:none;margin-top:12px">
        <h3>üìê Shape Sorter</h3>
        <p style="color:#666;margin:10px 0">Sort shapes into their correct categories</p>
        <div id="shapeSortGame" style="display:grid;grid-template-columns:1fr 1fr;gap:15px"></div>
    </div>

    <!-- SPOT THE DIFFERENCE -->
    <div id="spotdiff" class="panel" style="display:none;margin-top:12px">
        <h3>üîç Spot the Difference</h3>
        <p style="color:#666;margin:10px 0">Find the differences between the two images</p>
        <div id="spotDiffGame" style="display:grid;grid-template-columns:1fr 1fr;gap:15px"></div>
    </div>

    <!-- NEW: Settings Panel -->
    <div id="settings" class="panel" style="display:none;margin-top:12px">
        <h3>‚öôÔ∏è Settings</h3>
        <div id="settingsContent"></div>
    </div>

    <!-- NEW: Parent Dashboard -->
    <div id="parent" class="panel" style="display:none;margin-top:12px">
        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h3>
        <div id="parentContent"></div>
    </div>

    <!-- NEW: Features Showcase -->
    <div id="features" class="panel" style="display:none;margin-top:12px">
        <h3>üåü Platform Features & Showcase</h3>
        <div id="featuresContent"></div>
    </div>
</div>

<!-- VISUAL EFFECTS -->
<canvas id="confettiCanvas"></canvas>
<div id="emojiRain" class="emoji-rain"></div>

<!-- MASCOT -->
<div class="mascot" id="mascot" style="display: none;">
    <div class="mascot-speech">Hello! I'm your learning buddy!</div>
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="45" fill="#ffd166" />
        <circle cx="35" cy="40" r="5" fill="#333" />
        <circle cx="65" cy="40" r="5" fill="#333" />
        <path d="M 35,65 Q 50,75 65,65" stroke="#333" stroke-width="3" fill="transparent" />
    </svg>
</div>

<footer style="position:fixed;left:0;right:0;bottom:0;padding:8px;text-align:center;color:#fff;background:transparent">
    Made with ‚ù§Ô∏è ‚Äî Full Interactive Offline App</footer>
{% endblock %}
{% block scripts %}
<script>
    // Service Worker Registration for PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
            navigator.serviceWorker.register("{% static 'main/sw.js' %}").then(function (registration) {
                console.log('ServiceWorker registration successful');
            }, function (err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }

    // Manifest for PWA
    const manifest = {
        "name": "Kids Learning Adventure",
        "short_name": "Kids Learning",
        "description": "Interactive educational app for children",
        "start_url": "/",
        "display": "standalone",
        "background_color": "#ffdede",
        "theme_color": "#ff6b6b",
        "icons": [
            {
                "src": "icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
            },
            {
                "src": "icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
            }
        ]
    };

    /* ========== NEW LOGIN SYSTEM ========== */
    let currentUser = null;
    let users = {};
    let selectedCharacter = 'üë§';

    // Initialize login page on page load
    function initLoginPage() {
        // Add voice buttons hover effects
        const voiceButtons = document.querySelectorAll('button[onclick*="previewVoice"]');
        voiceButtons.forEach(btn => {
            btn.addEventListener('mouseenter', function () {
                this.style.transform = 'scale(1.1)';
                this.style.background = 'linear-gradient(90deg, #6ee7b7, #4da6ff)';
            });
            btn.addEventListener('mouseleave', function () {
                this.style.transform = 'scale(1)';
                this.style.background = '';
            });
        });

        // Add input field focus animations
        const inputs = document.querySelectorAll('.login-input');
        inputs.forEach(input => {
            input.addEventListener('focus', function () {
                this.parentElement.style.transform = 'scale(1.02)';
            });
            input.addEventListener('blur', function () {
                this.parentElement.style.transform = 'scale(1)';
            });
        });

        // Add welcome sound on page load
        setTimeout(() => {
            playSound('click');
        }, 500);
    }

    // Run on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLoginPage);
    } else {
        initLoginPage();
    }

    // Enhanced Chapter data with icons for display
    const chapters = [
        { id: 'alphabet', name: 'Alphabet', icon: 'üî§' },
        { id: 'numbers', name: 'Numbers', icon: 'üî¢' },
        { id: 'colors', name: 'Colors', icon: 'üé®' },
        { id: 'shapes', name: 'Shapes', icon: 'üî∫' },
        { id: 'fruits', name: 'Fruits', icon: 'üçé' },
        { id: 'body', name: 'Body Parts', icon: 'üß†' },
        { id: 'vehicles', name: 'Vehicles', icon: 'üöó' },
        { id: 'season', name: 'Weather', icon: 'üå§Ô∏è' },
        { id: 'classroom', name: 'Classroom', icon: 'üìö' },
        { id: 'games', name: 'Games', icon: 'üéÆ' },
        { id: 'trace', name: 'Tracing', icon: '‚úèÔ∏è' },
        { id: 'poems', name: 'Poems', icon: 'üìñ' },
        { id: 'stories', name: 'Stories', icon: 'üìö' },
        { id: 'hindi', name: 'Hindi', icon: 'ü™î' },
        { id: 'opposites', name: 'Opposites', icon: 'üîÑ' },
        { id: 'animals', name: 'Animals', icon: 'üêæ' },
        // NEW LEARNING MODULES
        { id: 'science', name: 'Science', icon: 'üî¨' },
        { id: 'geography', name: 'Geography', icon: 'üåç' },
        { id: 'time', name: 'Time', icon: '‚è∞' },
        { id: 'money', name: 'Money', icon: 'üí∞' },
        { id: 'patterns', name: 'Patterns', icon: 'üîÅ' }
    ];

    // Load users from localStorage
    function loadUsers() {
        const savedUsers = localStorage.getItem('kids_learning_users');
        if (savedUsers) {
            users = JSON.parse(savedUsers);
        }
    }

    // Save users to localStorage
    function saveUsers() {
        localStorage.setItem('kids_learning_users', JSON.stringify(users));
    }

    // Select character for registration
    function selectCharacter(element) {
        // Remove selection from all characters
        document.querySelectorAll('.character-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        // Add selection to clicked character
        element.classList.add('selected');
        selectedCharacter = element.getAttribute('data-char');

        // Add visual feedback
        playSound('click');
        element.style.animation = 'none';
        setTimeout(() => {
            element.style.animation = 'pulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
        }, 10);
    }

    // Show login form
    function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        speakText("Welcome back! Enter your name and secret code");
        // Add fade-in animation
        document.getElementById('loginForm').style.animation = 'fadeIn 0.5s';
    }

    // Show register form
    function showRegister() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        speakText("Create your new learning account!");
        // Add fade-in animation
        document.getElementById('registerForm').style.animation = 'fadeIn 0.5s';
    }

    // Add fade-in animation style
    const fadeInStyle = document.createElement('style');
    fadeInStyle.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    `;
    document.head.appendChild(fadeInStyle);

    // Register new user
    function register() {
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const voice = document.getElementById('registerVoice')?.value || 'default';

        // Auto-detect gender from selected character
        let gender = 'boy';
        if (selectedCharacter === 'üëß') {
            gender = 'girl';
        }

        if (!username) {
            alert('Please enter your name!');
            speakText("Please enter your name");
            return;
        }

        if (!password) {
            alert('Please create a secret code!');
            speakText("Please create a secret code");
            return;
        }

        if (password !== confirmPassword) {
            alert('Secret codes do not match!');
            speakText("Your secret codes don't match. Try again!");
            return;
        }

        if (users[username]) {
            alert('This name is already taken! Try another one.');
            speakText("This name is already taken. Choose a different name!");
            return;
        }

        // Create new user with chapter scores
        const chapterScores = {};
        chapters.forEach(chapter => {
            chapterScores[chapter.id] = 0;
        });

        users[username] = {
            password: password,
            character: selectedCharacter,
            gender: gender,
            voiceType: voice,
            createdAt: new Date().toISOString(),
            stars: 0,
            progress: {
                alphabet: [],
                numbers: [],
                games: [],
                stories: []
            },
            chapterScores: chapterScores,
            settings: {
                dyslexiaMode: false,
                colorblindMode: false,
                simplifiedUI: false,
                sessionTimer: 30,
                language: 'en',
                voiceGender: gender,
                voiceType: voice,
                voicePitch: gender === 'girl' ? 1.4 : 1.1,
                voiceRate: 1.0
            }
        };

        saveUsers();
        speakText(`Yay! Welcome to Kids Learning Adventure, ${username}!`);
        showLogin();

        // Clear form
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    }

    // Login user
    function login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const loginBtn = event.target;

        if (!username) {
            alert('Please enter your name!');
            speakText("Please enter your name");
            shakeElement(document.getElementById('loginUsername'));
            return;
        }

        if (!password) {
            alert('Please enter your secret code!');
            speakText("Please enter your secret code");
            shakeElement(document.getElementById('loginPassword'));
            return;
        }

        const user = users[username];

        if (!user) {
            alert('Friend not found! Check your name or create a new account.');
            speakText("I don't know that name. Would you like to create a new account?");
            shakeElement(document.getElementById('loginForm'));
            return;
        }

        if (user.password !== password) {
            alert('Wrong secret code! Try again.');
            speakText("That's not the right secret code. Try again!");
            shakeElement(document.getElementById('loginPassword'));
            return;
        }

        // Login successful - add animation
        loginBtn.style.pointerEvents = 'none';
        loginBtn.textContent = '‚ú® Loading Adventure...';
        showConfetti();

        setTimeout(() => {
            // Hide login, show main content
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('mascot').style.display = 'block';

            // Update UI with user info
            currentUser = username;
            localStorage.setItem('kids_current_user', username);
            document.getElementById('userName').textContent = username;
            document.getElementById('userAvatar').textContent = user.character;
            document.getElementById('welcomeName').textContent = username;
            document.getElementById('userCharacter').textContent = user.character;

            // Apply user settings
            applyUserSettings();

            // Load user-specific stars
            loadUserStars();

            // Initialize the app
            initializeApp();
            // Show the home tab
            const homeTab = document.querySelector('.tab[data-tab=home]');
            if (homeTab) {
                switchTab('home', homeTab);
            }


            speakText(`Welcome back, ${username}! Ready for some fun learning?`);
        }, 800);
    }

    // Add shake animation on error
    function shakeElement(element) {
        element.style.animation = 'shake 0.5s';
        setTimeout(() => {
            element.style.animation = '';
        }, 500);
    }

    // Add shake keyframe if not exists
    let hasShake = false;
    const styles = document.querySelectorAll('style');
    for (let s of styles) {
        if (s.textContent.includes('@keyframes shake')) {
            hasShake = true;
            break;
        }
    }
    if (!hasShake) {
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);
    }

    // Input validation feedback
    function validateUsername(input) {
        if (input.value.trim().length > 0) {
            input.style.borderColor = '#6ee7b7';
            input.style.boxShadow = '0 0 10px rgba(110, 231, 183, 0.3)';
        } else {
            input.style.borderColor = '#ffd166';
            input.style.boxShadow = '';
        }
    }

    function validatePassword(input) {
        if (input.value.length > 0) {
            input.style.borderColor = '#6ee7b7';
            input.style.boxShadow = '0 0 10px rgba(110, 231, 183, 0.3)';
        } else {
            input.style.borderColor = '#ffd166';
            input.style.boxShadow = '';
        }
    }

    // Add validation listeners
    const loginUsernameInput = document.getElementById('loginUsername');
    const loginPasswordInput = document.getElementById('loginPassword');

    if (loginUsernameInput) {
        loginUsernameInput.addEventListener('input', function () {
            validateUsername(this);
        });
    }

    if (loginPasswordInput) {
        loginPasswordInput.addEventListener('input', function () {
            validatePassword(this);
        });
    }

    // Apply user settings
    function applyUserSettings() {
        if (!currentUser || !users[currentUser]) return;

        const settings = users[currentUser].settings || {};
        const body = document.body;

        // Dyslexia mode
        if (settings.dyslexiaMode) {
            body.classList.add('dyslexia-mode');
        } else {
            body.classList.remove('dyslexia-mode');
        }

        // Colorblind mode
        if (settings.colorblindMode) {
            body.classList.add('colorblind-mode');
        } else {
            body.classList.remove('colorblind-mode');
        }

        // Simplified UI
        if (settings.simplifiedUI) {
            body.classList.add('simplified-ui');
        } else {
            body.classList.remove('simplified-ui');
        }

        // Initialize voices for the user
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
        }
    }

    // Logout user
    function logout() {
        if (confirm('Do you want to switch to a different friend?')) {
            currentUser = null;
            localStorage.removeItem('kids_current_user');

            // Show login, hide main content
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('mascot').style.display = 'none';

            // Clear login form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';

            showLogin();
        }
    }

    // Check if user is already logged in
    function checkExistingLogin() {
        loadUsers();
        const savedUser = localStorage.getItem('kids_current_user');

        if (savedUser && users[savedUser]) {
            // Auto-login
            currentUser = savedUser;
            const user = users[savedUser];

            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('mascot').style.display = 'block';
            document.getElementById('userName').textContent = savedUser;
            document.getElementById('userAvatar').textContent = user.character;
            document.getElementById('welcomeName').textContent = savedUser;
            document.getElementById('userCharacter').textContent = user.character;

            // Apply user settings
            applyUserSettings();

            loadUserStars();
            initializeApp();
        } else {
            // Show login screen
            document.getElementById('loginContainer').style.display = 'flex';
            speakText("Welcome to Kids Learning Adventure! Create your account or login!");
        }
    }

    // NEW: Update chapter scores display
    function updateChapterScoresDisplay() {
        if (!currentUser || !users[currentUser]) return;

        const container = document.getElementById('chapterScoreDisplay');
        container.innerHTML = '';

        const user = users[currentUser];
        const chapterScores = user.chapterScores || {};

        chapters.forEach(chapter => {
            const score = chapterScores[chapter.id] || 0;
            const scoreElement = document.createElement('div');
            scoreElement.className = 'chapter-score';
            scoreElement.innerHTML = `
                    <div class="chapter-score-icon">${chapter.icon}</div>
                    <div class="chapter-score-details">
                        <div class="chapter-score-name">${chapter.name}</div>
                        <div class="chapter-score-value">${score}</div>
                    </div>
                `;
            container.appendChild(scoreElement);
        });
    }

    // Modified: Load user-specific stars
    function loadUserStars() {
        if (!currentUser || !users[currentUser]) return;
        const userStars = users[currentUser].stars || 0;
        document.getElementById('pointsBadge').innerText = 'Stars: ' + userStars;

        // Update chapter scores display
        updateChapterScoresDisplay();
    }

    // NEW: Add stars to a specific chapter
    function addChapterStars(chapterId, n) {
        if (!currentUser || !users[currentUser]) return;

        const user = users[currentUser];
        if (!user.chapterScores) {
            user.chapterScores = {};
        }

        if (!user.chapterScores[chapterId]) {
            user.chapterScores[chapterId] = 0;
        }

        user.chapterScores[chapterId] += n;

        // Save to users database
        saveUsers();

        // Update display
        updateChapterScoresDisplay();
    }

    // Modified: Add stars with user-specific saving
    function addStars(n, chapterId = null) {
        if (!currentUser || !users[currentUser]) return;

        const user = users[currentUser];
        user.stars = (user.stars || 0) + n;

        // Update display
        document.getElementById('pointsBadge').innerText = 'Stars: ' + user.stars;

        // If chapter is specified, add to chapter score
        if (chapterId) {
            addChapterStars(chapterId, n);
        }

        // Save to users database
        saveUsers();

        if (n > 0) {
            showEmojiRain();
        }
    }

    // Modified: Get stars for current user
    function getStars() {
        if (!currentUser || !users[currentUser]) return 0;
        return users[currentUser].stars || 0;
    }

    // Modified: Reset progress for current user
    function resetProgress() {
        if (!currentUser || !users[currentUser]) return;

        if (confirm('Are you sure you want to reset all your stars and progress?')) {
            users[currentUser].stars = 0;
            users[currentUser].progress = {
                alphabet: [],
                numbers: [],
                games: [],
                stories: []
            };

            // Reset chapter scores
            users[currentUser].chapterScores = {};
            chapters.forEach(chapter => {
                users[currentUser].chapterScores[chapter.id] = 0;
            });

            saveUsers();
            updateStars();
            updateChapterScoresDisplay();
            alert('Your progress has been reset!');
            speakText("All clean! Let's start fresh!");
        }
    }

    // NEW: Create Learning Dashboard
    function createLearningDashboard() {
        if (!currentUser || !users[currentUser]) return '';

        const user = users[currentUser];
        const chapterScores = user.chapterScores || {};

        // Calculate progress percentages
        let totalScore = 0;
        let maxScore = chapters.length * 100;

        chapters.forEach(chapter => {
            totalScore += chapterScores[chapter.id] || 0;
        });

        const overallProgress = Math.min(100, Math.round((totalScore / maxScore) * 100));

        return `
                <div class="dashboard-panel">
                    <h3>${currentUser}'s Learning Journey</h3>
                    <div class="progress-overview">
                        <div class="big" style="text-align:center; margin:15px 0; font-size:1.5rem;">
                            Overall Progress: ${overallProgress}%
                        </div>
                        <div class="skill-meter">
                            <div class="skill-meter-fill" style="width: ${overallProgress}%"></div>
                        </div>
                    </div>
                    <div class="progress-chart">
                        ${chapters.map(chapter => {
            const score = chapterScores[chapter.id] || 0;
            const progress = Math.min(100, score);
            return `
                                <div style="margin:10px 0;">
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>${chapter.icon} ${chapter.name}</span>
                                        <span>${progress}%</span>
                                    </div>
                                    <div class="skill-meter">
                                        <div class="skill-meter-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            `;
        }).join('')}
                    </div>
                    <div class="weekly-goals" style="margin-top:20px;">
                        <h4>This Week's Goals</h4>
                        <div class="goal-item" style="padding:5px;">‚úì Learn 5 new letters</div>
                        <div class="goal-item" style="padding:5px;">‚óã Complete 3 games</div>
                        <div class="goal-item" style="padding:5px;">‚óã Earn 20 stars</div>
                    </div>
                </div>
            `;
    }

    // NEW: Create Settings Panel
    function createSettingsPanel() {
        if (!currentUser || !users[currentUser]) return '';

        const settings = users[currentUser].settings || {};
        const voiceGender = settings.voiceGender || 'boy';
        const voicePitch = settings.voicePitch || 1.2;
        const voiceRate = settings.voiceRate || 1.0;

        return `
                <div class="settings-panel">
                    <h3>üé§ Voice Settings</h3>
                    <div class="setting-option">
                        <div>
                            <div class="big">Voice Gender</div>
                            <div class="mini">Choose boy or girl voice</div>
                        </div>
                        <div style="display:flex;gap:10px">
                            <button class="tab" style="flex:1;background:${voiceGender === 'boy' ? '#4da6ff' : '#ddd'}" onclick="updateVoiceGender('boy')">üë¶ Boy Voice</button>
                            <button class="tab" style="flex:1;background:${voiceGender === 'girl' ? '#ff9db6' : '#ddd'}" onclick="updateVoiceGender('girl')">üëß Girl Voice</button>
                        </div>
                    </div>

                    <div class="setting-option">
                        <div>
                            <div class="big">Voice Pitch (${voicePitch.toFixed(1)})</div>
                            <div class="mini">Higher = more childlike, Lower = deeper</div>
                        </div>
                        <input type="range" id="voicePitch" min="0.5" max="2.0" step="0.1" value="${voicePitch}" onchange="updateVoicePitch(this.value)" style="width:100%">
                    </div>

                    <div class="setting-option">
                        <div>
                            <div class="big">Voice Speed (${voiceRate.toFixed(1)}x)</div>
                            <div class="mini">Faster or slower speech</div>
                        </div>
                        <input type="range" id="voiceRate" min="0.5" max="1.5" step="0.1" value="${voiceRate}" onchange="updateVoiceRate(this.value)" style="width:100%">
                    </div>

                    <div class="setting-option">
                        <button class="tab" onclick="testVoice()" style="width:100%;padding:12px">üîä Test Voice</button>
                    </div>

                    <hr style="margin:20px 0">
                    <h3>Accessibility Settings</h3>
                    <div class="setting-option">
                        <div>
                            <div class="big">Dyslexia-Friendly Font</div>
                            <div class="mini">Easier to read font for dyslexia</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dyslexiaToggle" ${settings.dyslexiaMode ? 'checked' : ''} onchange="toggleDyslexiaMode(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-option">
                        <div>
                            <div class="big">Colorblind Mode</div>
                            <div class="mini">Color schemes for color vision deficiency</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="colorblindToggle" ${settings.colorblindMode ? 'checked' : ''} onchange="toggleColorblindMode(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-option">
                        <div>
                            <div class="big">Simplified UI</div>
                            <div class="mini">Larger buttons and text for younger children</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="simplifiedToggle" ${settings.simplifiedUI ? 'checked' : ''} onchange="toggleSimplifiedUI(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-option">
                        <div>
                            <div class="big">Session Timer (minutes)</div>
                            <div class="mini">Reminder to take breaks</div>
                        </div>
                        <select id="sessionTimer" onchange="updateSessionTimer(this.value)">
                            <option value="15" ${settings.sessionTimer === 15 ? 'selected' : ''}>15</option>
                            <option value="30" ${settings.sessionTimer === 30 ? 'selected' : ''}>30</option>
                            <option value="45" ${settings.sessionTimer === 45 ? 'selected' : ''}>45</option>
                            <option value="60" ${settings.sessionTimer === 60 ? 'selected' : ''}>60</option>
                        </select>
                    </div>
                    
                    <div class="setting-option">
                        <div>
                            <div class="big">Language</div>
                            <div class="mini">App language</div>
                        </div>
                        <select id="languageSelect" onchange="updateLanguage(this.value)">
                            <option value="en" ${settings.language === 'en' ? 'selected' : ''}>English</option>
                            <option value="es" ${settings.language === 'es' ? 'selected' : ''}>Spanish</option>
                            <option value="fr" ${settings.language === 'fr' ? 'selected' : ''}>French</option>
                        </select>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Parent Controls</h3>
                    <div class="setting-option">
                        <div>
                            <div class="big">Content Filter</div>
                            <div class="mini">Age-appropriate content only</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="login-btn" onclick="exportProgress()" style="width: auto; padding: 10px 20px;">Export Progress Report</button>
                    </div>
                </div>
            `;
    }

    // Voice control functions
    function updateVoiceGender(gender) {
        if (!currentUser || !users[currentUser]) return;
        users[currentUser].settings.voiceGender = gender;
        saveUsers();
        speakText(gender === 'girl' ? "Voice changed to girl" : "Voice changed to boy");
        switchTab('settings', document.querySelector('.tab[data-tab=settings]'));
    }

    function updateVoicePitch(value) {
        if (!currentUser || !users[currentUser]) return;
        users[currentUser].settings.voicePitch = parseFloat(value);
        saveUsers();
        testVoice();
    }

    function updateVoiceRate(value) {
        if (!currentUser || !users[currentUser]) return;
        users[currentUser].settings.voiceRate = parseFloat(value);
        saveUsers();
        testVoice();
    }

    function testVoice() {
        const messages = [
            "Hello! I'm your new voice!",
            "Learning is fun and exciting!",
            "Let's explore together!"
        ];
        const msg = messages[Math.floor(Math.random() * messages.length)];
        speakText(msg);
    }

    // Preview voice on login page
    function previewVoice(gender) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const greetings = {
                'boy': "Hi! I'm the boy voice. Let's learn together!",
                'girl': "Hello! I'm the girl voice. Are you ready to explore?"
            };
            const message = greetings[gender] || "Hello!";
            const u = new SpeechSynthesisUtterance(message);
            u.lang = 'en-US';

            const voices = window.speechSynthesis.getVoices();
            let selectedVoice = null;

            if (gender === 'girl') {
                selectedVoice = voices.find(v => v.name.includes('female') || v.name.includes('woman') || v.name.includes('samantha') || v.name.includes('victoria'));
                if (!selectedVoice) selectedVoice = voices.find(v => v.name.includes('Google US English Female'));
                if (!selectedVoice) selectedVoice = voices[1];
                u.pitch = 1.4;
                u.rate = 0.95;
            } else {
                selectedVoice = voices.find(v => v.name.includes('male') || v.name.includes('man') || v.name.includes('google us english'));
                if (!selectedVoice) selectedVoice = voices[0];
                u.pitch = 1.1;
                u.rate = 0.95;
            }

            if (selectedVoice) u.voice = selectedVoice;
            window.speechSynthesis.speak(u);
        }
    }

    // NEW: Toggle Dyslexia Mode
    function toggleDyslexiaMode(enabled) {
        if (!currentUser || !users[currentUser]) return;

        users[currentUser].settings.dyslexiaMode = enabled;
        saveUsers();
        applyUserSettings();
        speakText(enabled ? "Dyslexia friendly font enabled" : "Dyslexia friendly font disabled");
    }

    // NEW: Toggle Colorblind Mode
    function toggleColorblindMode(enabled) {
        if (!currentUser || !users[currentUser]) return;

        users[currentUser].settings.colorblindMode = enabled;
        saveUsers();
        applyUserSettings();
        speakText(enabled ? "Colorblind mode enabled" : "Colorblind mode disabled");
    }

    // NEW: Toggle Simplified UI
    function toggleSimplifiedUI(enabled) {
        if (!currentUser || !users[currentUser]) return;

        users[currentUser].settings.simplifiedUI = enabled;
        saveUsers();
        applyUserSettings();
        speakText(enabled ? "Simplified interface enabled" : "Simplified interface disabled");
    }

    // NEW: Update Session Timer
    function updateSessionTimer(minutes) {
        if (!currentUser || !users[currentUser]) return;

        users[currentUser].settings.sessionTimer = parseInt(minutes);
        saveUsers();
        speakText(`Session timer set to ${minutes} minutes`);
    }

    // NEW: Update Language
    function updateLanguage(lang) {
        if (!currentUser || !users[currentUser]) return;

        users[currentUser].settings.language = lang;
        saveUsers();
        speakText(`Language changed to ${lang}`);
    }

    // NEW: Export Progress
    function exportProgress() {
        if (!currentUser || !users[currentUser]) return;

        const user = users[currentUser];
        const chapterScores = user.chapterScores || {};

        let report = `Learning Progress Report for ${currentUser}\n\n`;
        report += `Total Stars: ${user.stars || 0}\n\n`;
        report += "Chapter Progress:\n";

        chapters.forEach(chapter => {
            const score = chapterScores[chapter.id] || 0;
            report += `${chapter.name}: ${score} points\n`;
        });

        // Create a blob and download link
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentUser}-learning-progress.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        speakText("Progress report downloaded");
    }

    // NEW: Create Parent Dashboard
    function createParentDashboard() {
        if (!currentUser || !users[currentUser]) return '';

        const user = users[currentUser];
        const chapterScores = user.chapterScores || {};

        // Calculate total learning time (simulated)
        const totalLearningTime = Math.floor(Object.values(chapterScores).reduce((a, b) => a + b, 0) / 10);

        // Find strongest and weakest areas
        let strongestArea = { name: 'None', score: 0 };
        let weakestArea = { name: 'None', score: 100 };

        chapters.forEach(chapter => {
            const score = chapterScores[chapter.id] || 0;
            if (score > strongestArea.score) {
                strongestArea = { name: chapter.name, score: score };
            }
            if (score < weakestArea.score) {
                weakestArea = { name: chapter.name, score: score };
            }
        });

        return `
                <div class="parent-dashboard">
                    <h3>Learning Analytics for ${currentUser}</h3>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0;">
                        <div class="panel" style="flex: 1; min-width: 200px;">
                            <h4>Total Learning Time</h4>
                            <div class="big" style="font-size: 2rem; text-align: center;">${totalLearningTime} min</div>
                        </div>
                        
                        <div class="panel" style="flex: 1; min-width: 200px;">
                            <h4>Stars Earned</h4>
                            <div class="big" style="font-size: 2rem; text-align: center;">${user.stars || 0}</div>
                        </div>
                        
                        <div class="panel" style="flex: 1; min-width: 200px;">
                            <h4>Activities Completed</h4>
                            <div class="big" style="font-size: 2rem; text-align: center;">${Object.values(chapterScores).filter(score => score > 0).length}</div>
                        </div>
                    </div>
                    
                    <div class="progress-chart">
                        <h4>Progress by Category</h4>
                        ${chapters.map(chapter => {
            const score = chapterScores[chapter.id] || 0;
            const progress = Math.min(100, score);
            return `
                                <div style="margin:10px 0;">
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>${chapter.icon} ${chapter.name}</span>
                                        <span>${progress}%</span>
                                    </div>
                                    <div class="skill-meter">
                                        <div class="skill-meter-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            `;
        }).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <div class="panel" style="flex: 1;">
                            <h4>Strongest Area</h4>
                            <div class="big" style="text-align: center;">${strongestArea.name}</div>
                            <div class="mini" style="text-align: center;">Score: ${strongestArea.score}</div>
                        </div>
                        
                        <div class="panel" style="flex: 1;">
                            <h4>Area to Improve</h4>
                            <div class="big" style="text-align: center;">${weakestArea.name}</div>
                            <div class="mini" style="text-align: center;">Score: ${weakestArea.score}</div>
                        </div>
                    </div>
                    
                    <div class="session-timer" id="sessionTimerDisplay">
                        Session Timer: ${user.settings?.sessionTimer || 30}:00
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="login-btn" onclick="startSessionTimer()" style="width: auto; padding: 10px 20px;">Start Session Timer</button>
                        <button class="tab" onclick="resetSessionTimer()" style="margin-left: 10px;">Reset Timer</button>
                    </div>
                </div>
            `;
    }

    // NEW: Session Timer
    let sessionTimerInterval;
    function startSessionTimer() {
        if (!currentUser || !users[currentUser]) return;

        const sessionTime = users[currentUser].settings?.sessionTimer || 30;
        let timeLeft = sessionTime * 60; // Convert to seconds

        clearInterval(sessionTimerInterval);

        sessionTimerInterval = setInterval(() => {
            timeLeft--;

            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            document.getElementById('sessionTimerDisplay').textContent =
                `Session Timer: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(sessionTimerInterval);
                speakText("Time's up! Great job learning! Take a break!");
                alert("Session complete! Time for a break!");
            }
        }, 1000);
    }

    function resetSessionTimer() {
        clearInterval(sessionTimerInterval);
        if (!currentUser || !users[currentUser]) return;

        const sessionTime = users[currentUser].settings?.sessionTimer || 30;
        document.getElementById('sessionTimerDisplay').textContent =
            `Session Timer: ${sessionTime.toString().padStart(2, '0')}:00`;
    }

    // NEW: Create Science Explorer
    function createScienceExplorer() {
        return `
                <div class="science-explorer">
                    <h3>üî¨ Science Explorer</h3>
                    
                    <div class="science-experiment">
                        <h4>Magnetism Experiment</h4>
                        <div class="magnet-area" id="magnetArea">
                            <div class="magnet-object" id="magnet1" style="left: 30%;">N</div>
                            <div class="magnet-object" id="magnet2" style="left: 70%;">S</div>
                        </div>
                        <div class="controls">
                            <button class="tab" onclick="magnetExperiment()">See Magnetism</button>
                            <button class="tab" onclick="resetMagnets()">Reset</button>
                        </div>
                        <div class="mini" id="magnetResult"></div>
                    </div>
                    
                    <div class="science-experiment">
                        <h4>Plant Growth</h4>
                        <div class="plant-growth">
                            <div class="plant-stage">
                                <div class="plant-img">üå±</div>
                                <div>Seed</div>
                            </div>
                            <div class="plant-stage">
                                <div class="plant-img">ü™¥</div>
                                <div>Sprout</div>
                            </div>
                            <div class="plant-stage">
                                <div class="plant-img">üåø</div>
                                <div>Plant</div>
                            </div>
                            <div class="plant-stage">
                                <div class="plant-img">üåª</div>
                                <div>Flower</div>
                            </div>
                        </div>
                        <div class="controls">
                            <button class="tab" onclick="growPlant()">Grow Plant</button>
                        </div>
                    </div>
                    
                    <div class="science-experiment">
                        <h4>States of Matter</h4>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 15px 0;">
                            <div class="tile" onclick="showMatterState('ice')">
                                <div class="emoji">üßä</div>
                                <div class="big">Solid</div>
                            </div>
                            <div class="tile" onclick="showMatterState('water')">
                                <div class="emoji">üíß</div>
                                <div class="big">Liquid</div>
                            </div>
                            <div class="tile" onclick="showMatterState('steam')">
                                <div class="emoji">üí®</div>
                                <div class="big">Gas</div>
                            </div>
                        </div>
                        <div id="matterInfo" class="mini" style="text-align: center;"></div>
                    </div>
                </div>
            `;
    }

    // NEW: Science Experiment Functions
    function magnetExperiment() {
        const magnet1 = document.getElementById('magnet1');
        const magnet2 = document.getElementById('magnet2');
        const result = document.getElementById('magnetResult');

        // Animate magnets moving toward each other
        magnet1.style.transition = 'left 2s';
        magnet2.style.transition = 'left 2s';
        magnet1.style.left = '45%';
        magnet2.style.left = '55%';

        result.innerHTML = "Magnets attract! Opposite poles pull together.";
        speakText("Magnets attract when opposite poles face each other");
        addStars(2, 'science');
    }

    function resetMagnets() {
        const magnet1 = document.getElementById('magnet1');
        const magnet2 = document.getElementById('magnet2');
        const result = document.getElementById('magnetResult');

        magnet1.style.left = '30%';
        magnet2.style.left = '70%';
        result.innerHTML = "";
    }

    let plantStage = 0;
    function growPlant() {
        const plantStages = document.querySelectorAll('.plant-stage');

        if (plantStage < plantStages.length) {
            plantStages[plantStage].style.transform = 'scale(1.2)';
            plantStages[plantStage].style.transition = 'transform 0.5s';

            setTimeout(() => {
                plantStages[plantStage].style.transform = 'scale(1)';
            }, 500);

            plantStage = (plantStage + 1) % plantStages.length;

            speakText("Plants need water, sunlight, and soil to grow");
            addStars(1, 'science');
        }
    }

    function showMatterState(state) {
        const info = document.getElementById('matterInfo');
        let message = "";

        switch (state) {
            case 'ice':
                message = "Solid: Has a fixed shape and volume. Molecules are packed tightly together.";
                break;
            case 'water':
                message = "Liquid: Takes the shape of its container. Molecules can move around.";
                break;
            case 'steam':
                message = "Gas: Fills all available space. Molecules move freely and quickly.";
                break;
        }

        info.innerHTML = message;
        speakText(message);
        addStars(1, 'science');
    }

    // NEW: Create Geography Adventure
    function createGeographyAdventure() {
        return `
                <div class="geography-adventure">
                    <h3>üåç Geography Adventure</h3>
                    
                    <div class="world-map">
                        <div class="continent asia" onclick="learnAboutContinent('Asia')">Asia</div>
                        <div class="continent europe" onclick="learnAboutContinent('Europe')">Europe</div>
                        <div class="continent africa" onclick="learnAboutContinent('Africa')">Africa</div>
                        <div class="continent north-america" onclick="learnAboutContinent('North America')">N America</div>
                        <div class="continent south-america" onclick="learnAboutContinent('South America')">S America</div>
                        <div class="continent australia" onclick="learnAboutContinent('Australia')">Australia</div>
                    </div>
                    
                    <div id="continentInfo" class="panel" style="margin-top: 15px; display: none;">
                        <h4 id="continentName"></h4>
                        <div id="continentDetails" class="mini"></div>
                    </div>
                    
                    <div class="geography-quiz" style="margin-top: 20px;">
                        <h4>Flag Match Game</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0;">
                            <div class="tile" onclick="guessCountry('üá∫üá∏', 'United States')">
                                <div class="emoji">üá∫üá∏</div>
                                <div class="big">?</div>
                            </div>
                            <div class="tile" onclick="guessCountry('üá¨üáß', 'United Kingdom')">
                                <div class="emoji">üá¨üáß</div>
                                <div class="big">?</div>
                            </div>
                            <div class="tile" onclick="guessCountry('üáØüáµ', 'Japan')">
                                <div class="emoji">üáØüáµ</div>
                                <div class="big">?</div>
                            </div>
                            <div class="tile" onclick="guessCountry('üáßüá∑', 'Brazil')">
                                <div class="emoji">üáßüá∑</div>
                                <div class="big">?</div>
                            </div>
                        </div>
                        <div id="flagResult" class="mini" style="text-align: center;"></div>
                    </div>
                </div>
            `;
    }

    // NEW: Geography Functions
    function learnAboutContinent(continent) {
        const info = {
            'Asia': "Asia is the largest continent. It has the highest population. Famous for the Great Wall of China and Mount Everest.",
            'Europe': "Europe has many countries close together. Famous for the Eiffel Tower in France and Colosseum in Italy.",
            'Africa': "Africa is the second largest continent. It has many amazing animals like lions, elephants, and giraffes.",
            'North America': "North America has countries like the United States, Canada, and Mexico. Famous for the Grand Canyon.",
            'South America': "South America has the Amazon rainforest. Famous for soccer and carnival celebrations.",
            'Australia': "Australia is both a country and a continent. Famous for kangaroos, koalas, and the Great Barrier Reef."
        };

        document.getElementById('continentInfo').style.display = 'block';
        document.getElementById('continentName').textContent = continent;
        document.getElementById('continentDetails').textContent = info[continent];

        speakText(`This is ${continent}. ${info[continent]}`);
        addStars(1, 'geography');
    }

    function guessCountry(flag, country) {
        const result = document.getElementById('flagResult');
        const correct = Math.random() > 0.5; // Simulate correct/incorrect for demo

        if (correct) {
            result.innerHTML = `Correct! ${flag} is the flag of ${country}`;
            result.style.color = 'green';
            speakText(`Correct! This is the flag of ${country}`);
            addStars(2, 'geography');
            showConfetti();
        } else {
            result.innerHTML = `Try again! This is not ${country}'s flag`;
            result.style.color = 'red';
            speakText("Try again!");
        }
    }

    // NEW: Create Time & Clocks
    function createTimeAndClocks() {
        return `
                <div class="time-clocks">
                    <h3>‚è∞ Time & Clocks</h3>
                    
                    <div class="clock-container">
                        <h4>Interactive Clock</h4>
                        <div class="clock-face" id="interactiveClock">
                            <div class="clock-hand hour-hand" id="hourHand"></div>
                            <div class="clock-hand minute-hand" id="minuteHand"></div>
                            <div class="clock-hand second-hand" id="secondHand"></div>
                            <div class="clock-center"></div>
                        </div>
                        <div class="controls" style="margin-top: 15px;">
                            <button class="tab" onclick="setClockTime(3, 0)">3:00</button>
                            <button class="tab" onclick="setClockTime(6, 30)">6:30</button>
                            <button class="tab" onclick="setClockTime(9, 45)">9:45</button>
                            <button class="tab" onclick="setClockTime(12, 15)">12:15</button>
                        </div>
                        <div id="clockTime" class="big" style="text-align: center; margin-top: 10px;"></div>
                    </div>
                    
                    <div class="time-quiz" style="margin-top: 20px;">
                        <h4>Time Matching Game</h4>
                        <div id="timeQuizQuestion" class="flash-card">What time is it?</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0;">
                            <div class="tile" onclick="checkTimeAnswer('morning')">
                                <div class="emoji">üåÖ</div>
                                <div class="big">Morning</div>
                            </div>
                            <div class="tile" onclick="checkTimeAnswer('afternoon')">
                                <div class="emoji">‚òÄÔ∏è</div>
                                <div class="big">Afternoon</div>
                            </div>
                            <div class="tile" onclick="checkTimeAnswer('evening')">
                                <div class="emoji">üåá</div>
                                <div class="big">Evening</div>
                            </div>
                            <div class="tile" onclick="checkTimeAnswer('night')">
                                <div class="emoji">üåô</div>
                                <div class="big">Night</div>
                            </div>
                        </div>
                        <div id="timeQuizResult" class="mini" style="text-align: center;"></div>
                    </div>
                </div>
            `;
    }

    // NEW: Time & Clock Functions
    function setClockTime(hours, minutes) {
        const hourHand = document.getElementById('hourHand');
        const minuteHand = document.getElementById('minuteHand');
        const clockTime = document.getElementById('clockTime');

        // Calculate angles
        const hourAngle = (hours % 12) * 30 + minutes * 0.5;
        const minuteAngle = minutes * 6;

        // Apply rotations
        hourHand.style.transform = `rotate(${hourAngle}deg)`;
        minuteHand.style.transform = `rotate(${minuteAngle}deg)`;

        // Display time
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        clockTime.textContent = `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;

        speakText(`The time is ${displayHours} ${minutes} ${period}`);
        addStars(1, 'time');
    }

    function checkTimeAnswer(time) {
        const result = document.getElementById('timeQuizResult');
        const correct = Math.random() > 0.5; // Simulate correct/incorrect for demo

        if (correct) {
            result.innerHTML = `Correct! This is the ${time}`;
            result.style.color = 'green';
            speakText(`Correct! This is the ${time}`);
            addStars(2, 'time');
            showConfetti();
        } else {
            result.innerHTML = `Try again! This is not the ${time}`;
            result.style.color = 'red';
            speakText("Try again!");
        }
    }

    // NEW: Create Money & Currency
    function createMoneyAndCurrency() {
        return `
                <div class="money-currency">
                    <h3>üí∞ Money & Currency</h3>
                    
                    <div class="money-lesson">
                        <h4>Learn About Money</h4>
                        <div class="money-container">
                            <div class="coin" onclick="learnAboutCoin('penny')">1¬¢</div>
                            <div class="coin" onclick="learnAboutCoin('nickel')">5¬¢</div>
                            <div class="coin" onclick="learnAboutCoin('dime')">10¬¢</div>
                            <div class="coin" onclick="learnAboutCoin('quarter')">25¬¢</div>
                            <div class="bill" onclick="learnAboutBill('dollar')">$1</div>
                            <div class="bill" style="background: blue;" onclick="learnAboutBill('five')">$5</div>
                        </div>
                        <div id="moneyInfo" class="mini" style="text-align: center; margin-top: 10px;"></div>
                    </div>
                    
                    <div class="money-game" style="margin-top: 20px;">
                        <h4>Counting Money Game</h4>
                        <div id="moneyQuestion" class="flash-card">How much money?</div>
                        <div class="money-container" id="moneyDisplay"></div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0;">
                            <div class="tile" onclick="checkMoneyAnswer(0.25)">
                                <div class="big">25¬¢</div>
                            </div>
                            <div class="tile" onclick="checkMoneyAnswer(0.50)">
                                <div class="big">50¬¢</div>
                            </div>
                            <div class="tile" onclick="checkMoneyAnswer(0.75)">
                                <div class="big">75¬¢</div>
                            </div>
                            <div class="tile" onclick="checkMoneyAnswer(1.00)">
                                <div class="big">$1.00</div>
                            </div>
                        </div>
                        <div id="moneyResult" class="mini" style="text-align: center;"></div>
                        <div class="controls">
                            <button class="tab" onclick="generateMoneyQuestion()">New Question</button>
                        </div>
                    </div>
                </div>
            `;
    }

    // NEW: Money & Currency Functions
    function learnAboutCoin(coin) {
        const info = {
            'penny': "A penny is worth 1 cent. It's brown and has Abraham Lincoln on it.",
            'nickel': "A nickel is worth 5 cents. It's silver and has Thomas Jefferson on it.",
            'dime': "A dime is worth 10 cents. It's the smallest coin and has Franklin Roosevelt on it.",
            'quarter': "A quarter is worth 25 cents. It's the largest coin and has George Washington on it."
        };

        document.getElementById('moneyInfo').textContent = info[coin];
        speakText(info[coin]);
        addStars(1, 'money');
    }

    function learnAboutBill(bill) {
        const info = {
            'dollar': "A one dollar bill has George Washington on it. It's green.",
            'five': "A five dollar bill has Abraham Lincoln on it. It's also green."
        };

        document.getElementById('moneyInfo').textContent = info[bill];
        speakText(info[bill]);
        addStars(1, 'money');
    }

    let currentMoneyValue = 0;
    function generateMoneyQuestion() {
        const moneyDisplay = document.getElementById('moneyDisplay');
        const question = document.getElementById('moneyQuestion');
        const result = document.getElementById('moneyResult');

        // Clear previous result
        result.innerHTML = "";

        // Generate random coins
        const coins = [
            { value: 0.01, symbol: '1¬¢', count: 0 },
            { value: 0.05, symbol: '5¬¢', count: 0 },
            { value: 0.10, symbol: '10¬¢', count: 0 },
            { value: 0.25, symbol: '25¬¢', count: 0 }
        ];

        currentMoneyValue = 0;
        moneyDisplay.innerHTML = "";

        // Add 2-4 random coins
        const numCoins = Math.floor(Math.random() * 3) + 2;
        for (let i = 0; i < numCoins; i++) {
            const randomCoin = coins[Math.floor(Math.random() * coins.length)];
            randomCoin.count++;
            currentMoneyValue += randomCoin.value;

            const coinEl = document.createElement('div');
            coinEl.className = 'coin';
            coinEl.textContent = randomCoin.symbol;
            moneyDisplay.appendChild(coinEl);
        }

        question.textContent = "How much money is shown?";
    }

    function checkMoneyAnswer(answer) {
        const result = document.getElementById('moneyResult');

        if (Math.abs(answer - currentMoneyValue) < 0.01) {
            result.innerHTML = "Correct! Great job counting money!";
            result.style.color = 'green';
            speakText("Correct! Great job counting money!");
            addStars(3, 'money');
            showConfetti();
        } else {
            result.innerHTML = `Try again! The correct amount is $${currentMoneyValue.toFixed(2)}`;
            result.style.color = 'red';
            speakText("Try again!");
        }
    }

    // NEW: Create Pattern Recognition
    function createPatternRecognition() {
        return `
                <div class="pattern-recognition">
                    <h3>üîÅ Pattern Recognition</h3>
                    
                    <div class="pattern-game">
                        <h4>Complete the Pattern</h4>
                        <div class="pattern-container" id="patternSequence"></div>
                        <div class="pattern-options" id="patternOptions"></div>
                        <div id="patternResult" class="mini" style="text-align: center; margin-top: 10px;"></div>
                        <div class="controls">
                            <button class="tab" onclick="generatePattern()">New Pattern</button>
                        </div>
                    </div>
                    
                    <div class="pattern-lesson" style="margin-top: 20px;">
                        <h4>Pattern Types</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0;">
                            <div class="tile" onclick="showPatternType('AB')">
                                <div class="pattern-item">üî¥</div>
                                <div class="pattern-item">üîµ</div>
                                <div class="big">AB Pattern</div>
                            </div>
                            <div class="tile" onclick="showPatternType('ABC')">
                                <div class="pattern-item">üî¥</div>
                                <div class="pattern-item">üîµ</div>
                                <div class="pattern-item">üü¢</div>
                                <div class="big">ABC Pattern</div>
                            </div>
                            <div class="tile" onclick="showPatternType('AAB')">
                                <div class="pattern-item">üî¥</div>
                                <div class="pattern-item">üî¥</div>
                                <div class="pattern-item">üîµ</div>
                                <div class="big">AAB Pattern</div>
                            </div>
                        </div>
                        <div id="patternTypeInfo" class="mini" style="text-align: center;"></div>
                    </div>
                </div>
            `;
    }

    // NEW: Pattern Recognition Functions
    function generatePattern() {
        const patternSequence = document.getElementById('patternSequence');
        const patternOptions = document.getElementById('patternOptions');
        const result = document.getElementById('patternResult');

        // Clear previous
        patternSequence.innerHTML = "";
        patternOptions.innerHTML = "";
        result.innerHTML = "";

        // Pattern types
        const patterns = [
            { type: 'AB', sequence: ['üî¥', 'üîµ', 'üî¥', 'üîµ', 'üî¥'] },
            { type: 'ABC', sequence: ['üî¥', 'üîµ', 'üü¢', 'üî¥', 'üîµ'] },
            { type: 'AAB', sequence: ['üî¥', 'üî¥', 'üîµ', 'üî¥', 'üî¥'] },
            { type: 'ABB', sequence: ['üî¥', 'üîµ', 'üîµ', 'üî¥', 'üîµ'] }
        ];

        const randomPattern = patterns[Math.floor(Math.random() * patterns.length)];
        const correctNext = randomPattern.sequence[randomPattern.sequence.length - 1];

        // Display pattern (hide last element)
        for (let i = 0; i < randomPattern.sequence.length - 1; i++) {
            const item = document.createElement('div');
            item.className = 'pattern-item';
            item.textContent = randomPattern.sequence[i];
            patternSequence.appendChild(item);
        }

        // Add question mark for missing element
        const question = document.createElement('div');
        question.className = 'pattern-item';
        question.textContent = '?';
        question.style.background = '#f0f0f0';
        patternSequence.appendChild(question);

        // Generate options (include correct answer and 2-3 distractors)
        const options = [correctNext];
        const allShapes = ['üî¥', 'üîµ', 'üü¢', 'üü°', 'üü£'];

        while (options.length < 4) {
            const randomShape = allShapes[Math.floor(Math.random() * allShapes.length)];
            if (!options.includes(randomShape)) {
                options.push(randomShape);
            }
        }

        // Shuffle options
        shuffle(options);

        // Display options
        options.forEach(option => {
            const optionEl = document.createElement('div');
            optionEl.className = 'pattern-item';
            optionEl.textContent = option;
            optionEl.style.cursor = 'pointer';
            optionEl.addEventListener('click', () => checkPatternAnswer(option, correctNext));
            patternOptions.appendChild(optionEl);
        });
    }

    function checkPatternAnswer(selected, correct) {
        const result = document.getElementById('patternResult');

        if (selected === correct) {
            result.innerHTML = "Correct! You completed the pattern!";
            result.style.color = 'green';
            speakText("Correct! You completed the pattern!");
            addStars(3, 'patterns');
            showConfetti();
        } else {
            result.innerHTML = "Try again! Look carefully at the pattern.";
            result.style.color = 'red';
            speakText("Try again!");
        }
    }

    function showPatternType(type) {
        const info = document.getElementById('patternTypeInfo');
        let message = "";

        switch (type) {
            case 'AB':
                message = "AB Pattern: Two items that alternate, like red, blue, red, blue.";
                break;
            case 'ABC':
                message = "ABC Pattern: Three different items that repeat, like red, blue, green, red, blue, green.";
                break;
            case 'AAB':
                message = "AAB Pattern: Two of the same followed by one different, like red, red, blue, red, red, blue.";
                break;
        }

        info.innerHTML = message;
        speakText(message);
        addStars(1, 'patterns');
    }

    // Initialize the app after login
    function initializeApp() {
        // Your existing initialization code
        updateStars();
        showAlpha();
        populateTraceButtons();
        renderStore();
        startMatch();
        startDragDrop();
        startSpelling();
        generateQuiz();

        // Initialize new games
        startBalloonGame();
        startOddOneOut();
        startJigsaw();
        setupRewardWheel();

        // Update chapter scores display
        updateChapterScoresDisplay();

        // Initialize new learning modules
        generatePattern();
        generateMoneyQuestion();
        setClockTime(3, 0);

        // NEW: Initialize creative features
        applySeasonalTheme();
        selectInstrument('piano'); // Default to piano
        setupEmotionScenario();

        // Speak welcome message
        setTimeout(() => {
            speakText(`Welcome to Kids Learning Adventure, ${currentUser}! Complete challenges and track your progress!`);
            mascotSpeak();
        }, 1000);
    }

    // Check for existing login when page loads
    document.addEventListener('DOMContentLoaded', function () {
        checkExistingLogin();
    });

    // NEW: Switch Tab with Creative Features
    function switchTab(name, btn) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if (btn) btn.classList.add('active');
        document.querySelectorAll('#home,#alphabet,#numbers,#colors,#shapes,#fruits,#body,#vehicles,#season,#classroom,#games,#trace,#poems,#stories,#store,#rewards,#hindi,#opposites,#animals,#dashboard,#storymaker,#music,#emotions,#challenges,#science,#geography,#time,#money,#patterns,#spelling,#wordmatch,#truefals,#counting,#shapes_sort,#spotdiff,#settings,#parent,#translator,#memory,#drawing,#mathquiz,#voicerecord,#storyread,#puzzle,#achievements,#challenges_daily,#features').forEach(p => p.style.display = 'none');
        const pane = document.getElementById(name);
        if (pane) {
            pane.style.display = 'block';

            // Load creative feature content when tab is selected
            if (name === 'dashboard') {
                document.getElementById('dashboardContent').innerHTML = createLearningDashboard();
            } else if (name === 'storymaker') {
                document.getElementById('storyBuilderContent').innerHTML = createStoryBuilder();
            } else if (name === 'music') {
                document.getElementById('musicStudioContent').innerHTML = createMusicStudio();
            } else if (name === 'emotions') {
                document.getElementById('emotionsContent').innerHTML = createEmotionsCenter();
            } else if (name === 'challenges') {
                document.getElementById('challengesContent').innerHTML = createRealWorldChallenges();
            } else if (name === 'science') {
                document.getElementById('scienceContent').innerHTML = createScienceExplorer();
            } else if (name === 'geography') {
                document.getElementById('geographyContent').innerHTML = createGeographyAdventure();
            } else if (name === 'time') {
                document.getElementById('timeContent').innerHTML = createTimeAndClocks();
            } else if (name === 'money') {
                document.getElementById('moneyContent').innerHTML = createMoneyAndCurrency();
            } else if (name === 'patterns') {
                document.getElementById('patternsContent').innerHTML = createPatternRecognition();
            } else if (name === 'settings') {
                document.getElementById('settingsContent').innerHTML = createSettingsPanel();
            } else if (name === 'hindi') {
                // Initialize Hindi panel (populates voices, words and sentences)
                initHindi();
            } else if (name === 'memory') {
                // Initialize Memory Match game board and handlers
                initMemory();
            } else if (name === 'translator') {
                // Initialize translator with language controls and translation logic
                initTranslator();
            } else if (name === 'drawing') {
                initDrawing();
            } else if (name === 'mathquiz') {
                initMathQuiz();
            } else if (name === 'voicerecord') {
                initVoiceRecord();
            } else if (name === 'storyread') {
                initStoryRead();
            } else if (name === 'puzzle') {
                initPuzzle();
            } else if (name === 'achievements') {
                initAchievements();
            } else if (name === 'challenges_daily') {
                initDailyChallenges();
            } else if (name === 'spelling') {
                initSpelling();
            } else if (name === 'wordmatch') {
                initWordMatch();
            } else if (name === 'truefals') {
                initTrueFalse();
            } else if (name === 'counting') {
                initCounting();
            } else if (name === 'shapes_sort') {
                initShapeSorting();
            } else if (name === 'spotdiff') {
                initSpotDifference();
            } else if (name === 'multiplication') {
                initMultiplication();
            } else if (name === 'reading') {
                initReadingModule();
            } else if (name === 'grade_math') {
                initGradeMath();
            } else if (name === 'timedquiz') {
                initTimedQuiz();
            } else if (name === 'parent') {
                document.getElementById('parentContent').innerHTML = createParentDashboard();
            } else if (name === 'features') {
                document.getElementById('featuresContent').innerHTML = createFeaturesShowcase();
            }
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if (name === 'trace') { drawTemplate(curLetter); populateTraceButtons(); }
        if (name === 'store') { renderStore(); }
        if (name === 'rewards') {
            renderProgressBadges();
            setupRewardWheel();
            renderWallpaperCollection();
        }
    }

    /* ========== YOUR EXISTING JAVASCRIPT CODE ========== */
    /* ---------------- DATA: big content sets ---------------- */
    const alphabet = [
        { L: 'A', words: ['Apple', 'Ant'], phonics: '/√¶/', art: 'üçé' },
        { L: 'B', words: ['Ball', 'Bat'], phonics: '/b/', art: '‚öΩ' },
        { L: 'C', words: ['Cat', 'Cow'], phonics: '/k/ or /s/', art: 'üê±' },
        { L: 'D', words: ['Dog', 'Duck'], phonics: '/d/', art: 'üê∂' },
        { L: 'E', words: ['Elephant', 'Egg'], phonics: '/…õ/', art: 'üêò' },
        { L: 'F', words: ['Fish', 'Fan'], phonics: '/f/', art: 'üêü' },
        { L: 'G', words: ['Giraffe', 'Goat'], phonics: '/g/ or /d í/', art: 'ü¶í' },
        { L: 'H', words: ['Hat', 'Horse'], phonics: '/h/', art: 'üëí' },
        { L: 'I', words: ['Ice cream', 'Igloo'], phonics: '/…™/', art: 'üç¶' },
        { L: 'J', words: ['Jug', 'Jam'], phonics: '/d í/', art: 'üé∑' },
        { L: 'K', words: ['Kite', 'Key'], phonics: '/k/', art: 'ü™Å' },
        { L: 'L', words: ['Lion', 'Leaf'], phonics: '/l/', art: 'ü¶Å' },
        { L: 'M', words: ['Mango', 'Mouse'], phonics: '/m/', art: 'ü•≠' },
        { L: 'N', words: ['Nest', 'Nose'], phonics: '/n/', art: 'ü™∫' },
        { L: 'O', words: ['Orange', 'Octopus'], phonics: '/…í/ or /o ä/', art: 'üçä' },
        { L: 'P', words: ['Parrot', 'Pen'], phonics: '/p/', art: 'ü¶ú' },
        { L: 'Q', words: ['Queen', 'Quilt'], phonics: '/kw/', art: 'üëë' },
        { L: 'R', words: ['Rabbit', 'Rainbow'], phonics: '/r/', art: 'üê∞' },
        { L: 'S', words: ['Sun', 'Snake'], phonics: '/s/', art: '‚òÄÔ∏è' },
        { L: 'T', words: ['Tiger', 'Tap'], phonics: '/t/', art: 'üêØ' },
        { L: 'U', words: ['Umbrella', 'Unicorn'], phonics: '/ å/', art: '‚òÇÔ∏è' },
        { L: 'V', words: ['Van', 'Violin'], phonics: '/v/', art: 'üöê' },
        { L: 'W', words: ['Watch', 'Whale'], phonics: '/w/', art: '‚åö' },
        { L: 'X', words: ['Xylophone', 'Box'], phonics: '/ks/', art: 'üéπ' },
        { L: 'Y', words: ['Yacht', 'Yak'], phonics: '/j/', art: '‚õµ' },
        { L: 'Z', words: ['Zebra', 'Zip'], phonics: '/z/', art: 'ü¶ì' }
    ];

    // ENHANCED DATA SETS WITH MORE SYMBOLS AND CONTENT

    // Shapes with appropriate symbols
    const shapes = [
        { name: 'Circle', art: '‚≠ï' },
        { name: 'Square', art: '‚¨ú' },
        { name: 'Triangle', art: 'üî∫' },
        { name: 'Rectangle', art: 'üìè' },
        { name: 'Star', art: '‚≠ê' },
        { name: 'Heart', art: '‚ù§Ô∏è' },
        { name: 'Oval', art: 'ü•ö' },
        { name: 'Diamond', art: 'üíé' },
        { name: 'Crescent', art: 'üåô' },
        { name: 'Pentagon', art: 'üè†' }
    ];

    // More fruits and vegetables with symbols
    const fruits = [
        { name: 'Apple', art: 'üçé' },
        { name: 'Banana', art: 'üçå' },
        { name: 'Mango', art: 'ü•≠' },
        { name: 'Orange', art: 'üçä' },
        { name: 'Grapes', art: 'üçá' },
        { name: 'Tomato', art: 'üçÖ' },
        { name: 'Carrot', art: 'ü•ï' },
        { name: 'Potato', art: 'ü•î' },
        { name: 'Strawberry', art: 'üçì' },
        { name: 'Pineapple', art: 'üçç' },
        { name: 'Watermelon', art: 'üçâ' },
        { name: 'Cherry', art: 'üçí' },
        { name: 'Lemon', art: 'üçã' },
        { name: 'Cucumber', art: 'ü•í' },
        { name: 'Broccoli', art: 'ü•¶' },
        { name: 'Pepper', art: 'ü´ë' },
        { name: 'Corn', art: 'üåΩ' },
        { name: 'Avocado', art: 'ü•ë' }
    ];

    // Body parts with figure symbols
    const bodyParts = [
        { name: 'Head', art: 'üë§' },
        { name: 'Eye', art: 'üëÅÔ∏è' },
        { name: 'Ear', art: 'üëÇ' },
        { name: 'Nose', art: 'üëÉ' },
        { name: 'Mouth', art: 'üëÑ' },
        { name: 'Hand', art: '‚úã' },
        { name: 'Leg', art: 'ü¶µ' },
        { name: 'Foot', art: 'ü¶∂' },
        { name: 'Stomach', art: 'ü§∞' },
        { name: 'Heart', art: '‚ù§Ô∏è' },
        { name: 'Brain', art: 'üß†' },
        { name: 'Bones', art: 'ü¶¥' },
        { name: 'Tooth', art: 'ü¶∑' },
        { name: 'Lungs', art: 'ü´Å' }
    ];

    // Vehicles with appropriate symbols
    const vehicles = [
        { name: 'Car', art: 'üöó' },
        { name: 'Bus', art: 'üöå' },
        { name: 'Bike', art: 'üö≤' },
        { name: 'Train', art: 'üöÇ' },
        { name: 'Plane', art: '‚úàÔ∏è' },
        { name: 'Boat', art: '‚õµ' },
        { name: 'Truck', art: 'üöö' },
        { name: 'Ship', art: 'üö¢' },
        { name: 'Helicopter', art: 'üöÅ' },
        { name: 'Rocket', art: 'üöÄ' },
        { name: 'Ambulance', art: 'üöë' },
        { name: 'Police Car', art: 'üöì' },
        { name: 'Fire Truck', art: 'üöí' },
        { name: 'Tractor', art: 'üöú' }
    ];

    // Seasons and weather with appropriate symbols
    const seasons = [
        { name: 'Spring', art: 'üå±' },
        { name: 'Summer', art: '‚òÄÔ∏è' },
        { name: 'Autumn', art: 'üçÇ' },
        { name: 'Winter', art: '‚õÑ' }
    ];

    const weather = [
        { name: 'Sunny', art: '‚òÄÔ∏è' },
        { name: 'Rainy', art: 'üåßÔ∏è' },
        { name: 'Cloudy', art: '‚òÅÔ∏è' },
        { name: 'Snowy', art: '‚ùÑÔ∏è' },
        { name: 'Windy', art: 'üí®' },
        { name: 'Stormy', art: '‚õàÔ∏è' },
        { name: 'Foggy', art: 'üå´Ô∏è' },
        { name: 'Rainbow', art: 'üåà' }
    ];

    // Classroom objects with appropriate symbols
    const classroom = [
        { name: 'Book', art: 'üìö' },
        { name: 'Pencil', art: '‚úèÔ∏è' },
        { name: 'Table', art: 'ü™ë' },
        { name: 'Chair', art: 'üí∫' },
        { name: 'Ruler', art: 'üìè' },
        { name: 'Eraser', art: 'üßº' },
        { name: 'Bag', art: 'üéí' },
        { name: 'Globe', art: 'üåç' },
        { name: 'Microscope', art: 'üî¨' },
        { name: 'Calculator', art: 'üßÆ' },
        { name: 'Clock', art: '‚è∞' },
        { name: 'Scissors', art: '‚úÇÔ∏è' },
        { name: 'Paint', art: 'üé®' },
        { name: 'Computer', art: 'üíª' }
    ];

    // More complete poems
    const poems = {
        'Twinkle Twinkle': [
            "Twinkle, twinkle, little star,",
            "How I wonder what you are!",
            "Up above the world so high,",
            "Like a diamond in the sky.",
            "Twinkle, twinkle, little star,",
            "How I wonder what you are!"
        ],
        'Wheels on the Bus': [
            "The wheels on the bus go round and round,",
            "Round and round, round and round.",
            "The wheels on the bus go round and round,",
            "All through the town.",
            "",
            "The wipers on the bus go swish, swish, swish,",
            "Swish, swish, swish, swish, swish, swish.",
            "The wipers on the bus go swish, swish, swish,",
            "All through the town."
        ],
        'ABC Song': [
            "A B C D E F G",
            "H I J K L M N O P",
            "Q R S T U V",
            "W X Y and Z",
            "Now I know my ABCs,",
            "Next time won't you sing with me?"
        ],
        'Itsy Bitsy Spider': [
            "The itsy bitsy spider climbed up the water spout.",
            "Down came the rain and washed the spider out.",
            "Out came the sun and dried up all the rain,",
            "And the itsy bitsy spider climbed up the spout again."
        ],
        'Humpty Dumpty': [
            "Humpty Dumpty sat on a wall,",
            "Humpty Dumpty had a great fall.",
            "All the king's horses and all the king's men,",
            "Couldn't put Humpty together again."
        ],
        'Baa Baa Black Sheep': [
            "Baa, baa, black sheep, have you any wool?",
            "Yes sir, yes sir, three bags full.",
            "One for my master, one for my dame,",
            "And one for the little boy who lives down the lane."
        ]
    };

    // More Hindi words
    const hindiWords = [
        { english: "Apple", hindi: "‡§∏‡•á‡§¨", pronunciation: "seb", art: "üçé" },
        { english: "Ball", hindi: "‡§ó‡•á‡§Ç‡§¶", pronunciation: "gend", art: "‚öΩ" },
        { english: "Cat", hindi: "‡§¨‡§ø‡§≤‡•ç‡§≤‡•Ä", pronunciation: "billi", art: "üê±" },
        { english: "Dog", hindi: "‡§ï‡•Å‡§§‡•ç‡§§‡§æ", pronunciation: "kutta", art: "üê∂" },
        { english: "Elephant", hindi: "‡§π‡§æ‡§•‡•Ä", pronunciation: "hathi", art: "üêò" },
        { english: "Fish", hindi: "‡§Æ‡§õ‡§≤‡•Ä", pronunciation: "machli", art: "üêü" },
        { english: "Grapes", hindi: "‡§Ö‡§Ç‡§ó‡•Ç‡§∞", pronunciation: "angur", art: "üçá" },
        { english: "House", hindi: "‡§ò‡§∞", pronunciation: "ghar", art: "üè†" },
        { english: "Ice", hindi: "‡§¨‡§∞‡•ç‡§´", pronunciation: "barf", art: "‚ùÑÔ∏è" },
        { english: "Jug", hindi: "‡§ú‡§ó", pronunciation: "jag", art: "üè∫" },
        { english: "King", hindi: "‡§∞‡§æ‡§ú‡§æ", pronunciation: "raja", art: "üëë" },
        { english: "Lion", hindi: "‡§∂‡•á‡§∞", pronunciation: "sher", art: "ü¶Å" },
        { english: "Moon", hindi: "‡§ö‡§æ‡§Å‡§¶", pronunciation: "chand", art: "üåô" },
        { english: "Sun", hindi: "‡§∏‡•Ç‡§∞‡§ú", pronunciation: "suraj", art: "‚òÄÔ∏è" },
        { english: "Water", hindi: "‡§™‡§æ‡§®‡•Ä", pronunciation: "pani", art: "üíß" },
        { english: "Book", hindi: "‡§ï‡§ø‡§§‡§æ‡§¨", pronunciation: "kitaab", art: "üìö" },
        { english: "Pen", hindi: "‡§ï‡§≤‡§Æ", pronunciation: "kalam", art: "‚úèÔ∏è" },
        { english: "Mother", hindi: "‡§Æ‡§æ‡§Å", pronunciation: "maa", art: "üë©" },
        { english: "Father", hindi: "‡§™‡§ø‡§§‡§æ", pronunciation: "pita", art: "üë®" },
        { english: "Friend", hindi: "‡§¶‡•ã‡§∏‡•ç‡§§", pronunciation: "dost", art: "üë´" }
    ];

    const opposites = [
        { pair: ["Hot", "Cold"], arts: ["üî•", "‚ùÑÔ∏è"] },
        { pair: ["Big", "Small"], arts: ["üêò", "üê≠"] },
        { pair: ["Up", "Down"], arts: ["‚¨ÜÔ∏è", "‚¨áÔ∏è"] },
        { pair: ["Fast", "Slow"], arts: ["üöÄ", "üêå"] },
        { pair: ["Tall", "Short"], arts: ["üå≥", "üå±"] },
        { pair: ["Heavy", "Light"], arts: ["üèãÔ∏è", "üéà"] },
        { pair: ["Day", "Night"], arts: ["‚òÄÔ∏è", "üåô"] },
        { pair: ["Happy", "Sad"], arts: ["üòä", "üò¢"] },
        { pair: ["Full", "Empty"], arts: ["üì¶", "üì≠"] },
        { pair: ["Open", "Close"], arts: ["üö™", "üîí"] }
    ];

    // Farm animals with sounds
    const farmAnimals = [
        { name: "Cow", sound: "Moo", art: "üêÑ" },
        { name: "Sheep", sound: "Baa", art: "üêë" },
        { name: "Pig", sound: "Oink", art: "üêñ" },
        { name: "Chicken", sound: "Cluck", art: "üêî" },
        { name: "Duck", sound: "Quack", art: "ü¶Ü" },
        { name: "Horse", sound: "Neigh", art: "üêé" },
        { name: "Goat", sound: "Bleat", art: "üêê" },
        { name: "Rooster", sound: "Cock-a-doodle-doo", art: "üêì" },
        { name: "Dog", sound: "Woof", art: "üêï" },
        { name: "Cat", sound: "Meow", art: "üêà" },
        { name: "Turkey", sound: "Gobble", art: "ü¶É" },
        { name: "Donkey", sound: "Hee-haw", art: "üê¥" },
        { name: "Goose", sound: "Honk", art: "ü™ø" },
        { name: "Bee", sound: "Buzz", art: "üêù" }
    ];

    const numbers = Array.from({ length: 100 }, (_, i) => i + 1);

    const colors = [
        { name: 'Red', hex: '#ff4d4d' }, { name: 'Blue', hex: '#4da6ff' }, { name: 'Green', hex: '#2ecc71' },
        { name: 'Yellow', hex: '#ffd166' }, { name: 'Orange', hex: '#ff9f43' }, { name: 'Purple', hex: '#9b59b6' },
        { name: 'Pink', hex: '#ff7ab6' }, { name: 'Brown', hex: '#b5651d' }, { name: 'Black', hex: '#333' }, { name: 'White', hex: '#fff' }
    ];

    const stories = [
        { title: "The Kind Child", text: "Once there was a child who shared food with a hungry friend. They both were happy and learned kindness matters." },
        { title: "The Little Seed", text: "A tiny seed was planted, watered and cared for. It grew into a beautiful plant. Care and patience help things grow." }
    ];

    const stickers = [
        { id: 's1', name: 'Star', art: '‚≠ê', cost: 5 }, { id: 's2', name: 'Heart', art: '‚ù§Ô∏è', cost: 8 }, { id: 's3', name: 'Smiley', art: 'üòä', cost: 10 }
    ];

    // NEW REWARDS DATA
    const progressBadges = [
        { id: 'b1', name: 'First Steps', description: 'Complete 5 activities', art: 'üë£' },
        { id: 'b2', name: 'Alphabet Master', description: 'Learn all letters', art: 'üî§' },
        { id: 'b3', name: 'Number Whiz', description: 'Count to 50', art: 'üî¢' },
        { id: 'b4', name: 'Game Champion', description: 'Win 10 games', art: 'üèÜ' },
        { id: 'b5', name: 'Star Collector', description: 'Earn 100 stars', art: '‚≠ê' }
    ];

    const wallpapers = [
        { id: 'w1', name: 'Rainbow', cost: 20, art: 'üåà' },
        { id: 'w2', name: 'Space', cost: 30, art: 'üöÄ' },
        { id: 'w3', name: 'Ocean', cost: 25, art: 'üê†' },
        { id: 'w4', name: 'Jungle', cost: 35, art: 'üêí' }
    ];

    /* ---------------- Helpers ---------------- */
    function speakText(text, slow = false, lang = 'en-US') {
        if (!text) return;
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;

            // ALWAYS get user voice settings - reads fresh from user data every time
            let voiceGender = 'boy';
            let voicePitch = 1.2;
            let voiceRate = 1.0;

            // First check if user is logged in
            if (currentUser && users[currentUser] && users[currentUser].settings) {
                const settings = users[currentUser].settings;
                voiceGender = settings.voiceGender || 'boy';
                voicePitch = settings.voicePitch !== undefined ? settings.voicePitch : 1.2;
                voiceRate = settings.voiceRate !== undefined ? settings.voiceRate : 1.0;
            }

            // Get available voices
            const voices = window.speechSynthesis.getVoices();
            let selectedVoice = null;

            // Select voice based on gender preference
            if (voiceGender === 'girl') {
                // Try multiple female voice keywords
                selectedVoice = voices.find(v =>
                    v.name.toLowerCase().includes('female') ||
                    v.name.toLowerCase().includes('woman') ||
                    v.name.toLowerCase().includes('samantha') ||
                    v.name.toLowerCase().includes('victoria') ||
                    v.name.toLowerCase().includes('karen') ||
                    (v.name.toLowerCase().includes('google') && v.name.toLowerCase().includes('female'))
                );

                // Fallback to generic female voice
                if (!selectedVoice) {
                    selectedVoice = voices.find(v => v.name.toLowerCase().includes('google us english female'));
                }

                // Final fallback to second voice (often female on most systems)
                if (!selectedVoice && voices.length > 1) {
                    selectedVoice = voices[1];
                }
            } else {
                // Try multiple male voice keywords
                selectedVoice = voices.find(v =>
                    v.name.toLowerCase().includes('male') ||
                    v.name.toLowerCase().includes('man') ||
                    v.name.toLowerCase().includes('google us english') ||
                    v.name.toLowerCase().includes('david')
                );

                // Fallback to generic male voice
                if (!selectedVoice) {
                    selectedVoice = voices.find(v => v.name.toLowerCase().includes('google us english'));
                }

                // Final fallback to first voice
                if (!selectedVoice && voices.length > 0) {
                    selectedVoice = voices[0];
                }
            }

            // Apply selected voice
            if (selectedVoice) {
                u.voice = selectedVoice;
            }

            // Apply user's pitch and rate preferences
            u.rate = slow ? voiceRate * 0.7 : voiceRate;
            u.pitch = voicePitch;

            // Ensure volume is adequate
            u.volume = 1.0;

            window.speechSynthesis.speak(u);
        }
    }

    // Special function for Hindi pronunciation
    function speakHindi(hindiText, pronunciation, slow = false) {
        if (!hindiText) return;

        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(hindiText);
            u.lang = 'hi-IN';  // Hindi India language code

            // Get user voice settings for Hindi too
            let voiceGender = 'boy', voicePitch = 1.2, voiceRate = 1.0;
            if (currentUser && users[currentUser]) {
                const settings = users[currentUser].settings || {};
                voiceGender = settings.voiceGender || 'boy';
                voicePitch = settings.voicePitch || 1.2;
                voiceRate = settings.voiceRate || 1.0;
            }

            u.rate = slow ? voiceRate * 0.6 : voiceRate * 0.85;
            u.pitch = voicePitch;

            // Get available voices and try to find Hindi voice
            const voices = window.speechSynthesis.getVoices();

            // First try to find Hindi voice
            let hindiVoice = voices.find(v => v.lang.startsWith('hi'));

            // If no Hindi voice, use gender-appropriate voice as fallback
            if (!hindiVoice) {
                if (voiceGender === 'girl') {
                    hindiVoice = voices.find(v => v.name.includes('female') || v.name.includes('woman') || v.name.includes('samantha'));
                    if (!hindiVoice) hindiVoice = voices[1];
                } else {
                    hindiVoice = voices.find(v => v.name.includes('male') || v.name.includes('man'));
                    if (!hindiVoice) hindiVoice = voices[0];
                }
            }

            if (hindiVoice) {
                u.voice = hindiVoice;
            }

            window.speechSynthesis.speak(u);

            // After Hindi audio, also show pronunciation in English (using user's voice)
            setTimeout(() => {
                const pronU = new SpeechSynthesisUtterance(`Pronounced as: ${pronunciation}`);
                pronU.lang = 'en-US';

                // Use same voice settings for pronunciation
                if (voiceGender === 'girl') {
                    const femaleVoices = voices.filter(v => v.name.includes('female') || v.name.includes('woman') || v.name.includes('samantha'));
                    if (femaleVoices.length > 0) pronU.voice = femaleVoices[0];
                } else {
                    const maleVoices = voices.filter(v => v.name.includes('male') || v.name.includes('man'));
                    if (maleVoices.length > 0) pronU.voice = maleVoices[0];
                }

                pronU.rate = voiceRate * 0.9;
                pronU.pitch = voicePitch;
                window.speechSynthesis.speak(pronU);
            }, 1500);
        }
    } function playSound(type) {
        // Simple sound effects using Web Audio API (FIXED: singleton AudioContext)
        try {
            if (!window.audioContext) {
                window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const audioContext = window.audioContext;

            // Resume if suspended
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'click') {
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            } else if (type === 'correct') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            } else if (type === 'wrong') {
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            }

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.warn('Audio playback error:', e);
        }
    }
    /* --------- Hindi & Memory initializers --------- */
    function initHindi() {
        const voiceSelect = document.getElementById('hindiVoice');
        const speedInput = document.getElementById('hindiSpeed');
        const pronounceToggle = document.getElementById('pronounceToggle');
        const playSampleBtn = document.getElementById('playSample');
        const hindiGrid = document.getElementById('hindiGrid');
        const hindiSentences = document.getElementById('hindiSentences');

        // Populate voices (may be empty until voices are loaded)
        function populateVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (!voices || voices.length === 0) return;
            if (voiceSelect.options.length === 0) {
                voices.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name;
                    opt.textContent = `${v.name} (${v.lang})`;
                    voiceSelect.appendChild(opt);
                });
            }
        }
        populateVoices();
        window.speechSynthesis.onvoiceschanged = populateVoices;

        // Play sample sentence
        playSampleBtn.onclick = () => {
            const s = '‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§ö‡§≤‡•ã ‡§Ü‡§ú ‡§ï‡•Å‡§õ ‡§®‡§Ø‡§æ ‡§∏‡•Ä‡§ñ‡§§‡•á ‡§π‡•à‡§Ç‡•§';
            const rate = parseFloat(speedInput.value || 0.85);
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(s);
            u.lang = 'hi-IN';
            u.rate = rate;
            const sel = voiceSelect.value;
            const v = window.speechSynthesis.getVoices().find(x => x.name === sel);
            if (v) u.voice = v;
            window.speechSynthesis.speak(u);
        };

        // Toggle transliteration display
        pronounceToggle.onclick = () => {
            document.querySelectorAll('.pronunciation').forEach(el => {
                el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
            });
        };

        // Render words grid
        if (hindiGrid) {
            hindiGrid.innerHTML = '';
            hindiWords.forEach(w => {
                const tile = document.createElement('div');
                tile.className = 'tile';
                const art = `<div style="font-size:34px">${w.art}</div>`;
                const en = `<div style="font-weight:700;margin-top:6px">${w.english}</div>`;
                const hi = `<div style="font-size:1.1rem;color:#222">${w.hindi}</div>`;
                const pr = `<div class="pronunciation" style="display:none;color:#666">${w.pronunciation}</div>`;
                const controls = `<div style="margin-top:8px"><button class="tab" onclick="speakHindi('${w.hindi.replace(/'/g, "\\'")}','${w.pronunciation.replace(/'/g, "\\'")}', false)">üîä</button> <button class="tab" onclick="speakHindi('${w.hindi.replace(/'/g, "\\'")}','${w.pronunciation.replace(/'/g, "\\'")}', true)">üê¢</button></div>`;
                tile.innerHTML = art + en + hi + pr + controls;
                hindiGrid.appendChild(tile);
            });
        }

        // Sample sentences
        const sampleSentences = [
            '‡§Ø‡§π ‡§è‡§ï ‡§∏‡•á‡§¨ ‡§π‡•à‡•§',
            '‡§Æ‡•Å‡§ù‡•á ‡§¨‡§≤ ‡§ï‡•Ä ‡§ó‡•á‡§Ç‡§¶ ‡§™‡§∏‡§Ç‡§¶ ‡§π‡•à‡•§',
            '‡§ö‡§≤‡•ã ‡§ó‡§æ‡§®‡§æ ‡§ó‡§æ‡§è‡§Å ‡§î‡§∞ ‡§ñ‡•á‡§≤‡•á‡§Ç‡•§'
        ];
        if (hindiSentences) {
            hindiSentences.innerHTML = '';
            sampleSentences.forEach(s => {
                const b = document.createElement('button');
                b.className = 'tab';
                b.textContent = s;
                b.onclick = () => speakHindi(s, '', false);
                hindiSentences.appendChild(b);
            });
        }
    }

    // Memory Match game
    let memoryState = { first: null, second: null, lock: false, matches: 0, score: 0 };

    function initMemory() {
        const board = document.getElementById('memoryBoard');
        const scoreEl = document.getElementById('memoryScore');
        const restart = document.getElementById('memoryRestart');
        if (!board || !scoreEl) return;

        const icons = ['üçé', 'üçå', 'üê±', 'üê∂', '‚≠ê', '‚öΩ', 'üéµ', 'üåü'];
        let cards = icons.concat(icons).map((c, i) => ({ id: i, content: c, matched: false }));
        // shuffle
        cards = cards.sort(() => Math.random() - 0.5);

        memoryState = { first: null, second: null, lock: false, matches: 0, score: 0 };
        scoreEl.textContent = 'Score: 0';
        board.innerHTML = '';

        function flipBack(a, b) {
            setTimeout(() => {
                a.classList.remove('flipped');
                b.classList.remove('flipped');
                memoryState.first = memoryState.second = null;
                memoryState.lock = false;
            }, 800);
        }

        function handleMatch(a, b) {
            a.classList.add('matched');
            b.classList.add('matched');
            memoryState.matches += 1;
            memoryState.score += 10;
            document.getElementById('memoryScore').textContent = 'Score: ' + memoryState.score;
            playSound('correct');
            memoryState.first = memoryState.second = null;
            memoryState.lock = false;
            if (memoryState.matches === icons.length) {
                setTimeout(() => { makeConfetti(); alert('You matched all cards!'); }, 300);
            }
        }

        cards.forEach((card, idx) => {
            const el = document.createElement('div');
            el.className = 'memory-card tile';
            el.dataset.content = card.content;
            el.innerHTML = `<div class="card-front" style="font-size:32px;display:none">${card.content}</div><div class="card-back" style="font-size:32px">‚ùî</div>`;
            el.style.cursor = 'pointer';
            el.onclick = () => {
                if (memoryState.lock || el.classList.contains('flipped') || el.classList.contains('matched')) return;
                el.classList.add('flipped');
                el.querySelector('.card-front').style.display = 'block';
                el.querySelector('.card-back').style.display = 'none';
                if (!memoryState.first) {
                    memoryState.first = el;
                } else if (!memoryState.second) {
                    memoryState.second = el;
                    memoryState.lock = true;
                    const a = memoryState.first, b = memoryState.second;
                    if (a.dataset.content === b.dataset.content) {
                        handleMatch(a, b);
                    } else {
                        playSound('wrong');
                        flipBack(a, b);
                    }
                }
            };
            board.appendChild(el);
        });

        restart.onclick = () => initMemory();
    }

    // Simple translation dictionary (offline support)
    const translationDict = {
        'en': {
            'hello': { 'hi': '‡§®‡§Æ‡§∏‡•ç‡§§‡•á', 'es': 'Hola', 'fr': 'Bonjour', 'de': 'Hallo' },
            'good morning': { 'hi': '‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§', 'es': 'Buenos d√≠as', 'fr': 'Bonjour', 'de': 'Guten Morgen' },
            'thank you': { 'hi': '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶', 'es': 'Gracias', 'fr': 'Merci', 'de': 'Danke' },
            'goodbye': { 'hi': '‡§Ö‡§≤‡§µ‡§ø‡§¶‡§æ', 'es': 'Adi√≥s', 'fr': 'Au revoir', 'de': 'Auf Wiedersehen' },
            'how are you': { 'hi': '‡§Ü‡§™ ‡§ï‡•à‡§∏‡•á ‡§π‡•ã', 'es': '¬øC√≥mo est√°s?', 'fr': 'Comment allez-vous?', 'de': 'Wie geht es dir?' },
            'what is your name': { 'hi': '‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à', 'es': '¬øCu√°l es tu nombre?', 'fr': 'Quel est votre nom?', 'de': 'Wie hei√üt du?' }
        },
        'hi': {
            '‡§®‡§Æ‡§∏‡•ç‡§§‡•á': { 'en': 'hello', 'es': 'Hola', 'fr': 'Bonjour', 'de': 'Hallo' },
            '‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§': { 'en': 'good morning', 'es': 'Buenos d√≠as', 'fr': 'Bonjour', 'de': 'Guten Morgen' },
            '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶': { 'en': 'thank you', 'es': 'Gracias', 'fr': 'Merci', 'de': 'Danke' }
        }
    };

    function initTranslator() {
        const input = document.getElementById('transInput');
        const output = document.getElementById('transOutput');
        const fromSelect = document.getElementById('transFrom');
        const toSelect = document.getElementById('transTo');
        const doBtn = document.getElementById('doTranslate');
        const clearBtn = document.getElementById('clearTrans');
        const swapBtn = document.getElementById('swapLangs');
        const speakBtn = document.getElementById('speakTrans');

        doBtn.onclick = () => {
            const text = input.value.trim().toLowerCase();
            const fromLang = fromSelect.value;
            const toLang = toSelect.value;

            if (!text) { alert('Please enter text to translate'); return; }
            if (fromLang === toLang) { alert('Select different source and target languages'); return; }

            let result = '';
            // Simple lookup
            if (translationDict[fromLang] && translationDict[fromLang][text]) {
                result = translationDict[fromLang][text][toLang] || '(Translation not available)';
            } else {
                result = '(Translation not found in dictionary - try: hello, thank you, goodbye, how are you)';
            }

            output.textContent = result;
            speakBtn.style.display = 'block';
            speakBtn.onclick = () => speakText(result, false, toLang === 'hi' ? 'hi-IN' : toLang === 'es' ? 'es-ES' : toLang === 'fr' ? 'fr-FR' : 'de-DE');
        };

        clearBtn.onclick = () => {
            input.value = '';
            output.textContent = '';
            speakBtn.style.display = 'none';
        };

        swapBtn.onclick = () => {
            const temp = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = temp;
        };

        // Show example phrases
        const examples = Object.keys(translationDict['en']);
        input.placeholder = `Examples: ${examples.join(', ')}...`;
    }

    /* ===== NEW FEATURE INITIALIZERS ===== */

    // Drawing & Coloring Tool
    function initDrawing() {
        const canvas = document.getElementById('drawCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const colorInput = document.getElementById('drawColor');
        const sizeInput = document.getElementById('drawSize');
        const clearBtn = document.getElementById('drawClear');
        const saveBtn = document.getElementById('drawSave');

        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        let isDrawing = false;

        canvas.addEventListener('mousedown', () => { isDrawing = true; });
        canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.lineWidth = sizeInput.value;
            ctx.lineCap = 'round';
            ctx.strokeStyle = colorInput.value;
            ctx.lineTo(x, y);
            ctx.stroke();
        });

        clearBtn.onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);
        saveBtn.onclick = () => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL();
            link.download = 'drawing_' + Date.now() + '.png';
            link.click();
            playSound('correct');
        };
    }

    // Math Quiz Game
    let mathState = { score: 0, total: 0, level: 'easy' };
    function initMathQuiz() {
        const levelSelect = document.getElementById('mathLevel');
        const startBtn = document.getElementById('mathStart');
        const questionDiv = document.getElementById('mathQuestion');
        const answerInput = document.getElementById('mathAnswer');
        const submitBtn = document.getElementById('mathSubmit');
        const scoreDiv = document.getElementById('mathScore');
        const feedbackDiv = document.getElementById('mathFeedback');

        function generateQuestion() {
            const level = levelSelect.value;
            const max = level === 'easy' ? 10 : level === 'medium' ? 50 : 100;
            const a = Math.floor(Math.random() * max) + 1;
            const b = Math.floor(Math.random() * max) + 1;
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let answer;
            if (op === '+') answer = a + b;
            else if (op === '-') answer = a - b;
            else answer = a * b;
            questionDiv.textContent = `${a} ${op} ${b} = ?`;
            return answer;
        }

        let currentAnswer = null;
        startBtn.onclick = () => {
            mathState = { score: 0, total: 0, level: levelSelect.value };
            currentAnswer = generateQuestion();
            answerInput.value = '';
            answerInput.focus();
            feedbackDiv.style.display = 'none';
            scoreDiv.textContent = `Score: 0/0`;
        };

        submitBtn.onclick = () => {
            const userAnswer = parseInt(answerInput.value);
            if (isNaN(userAnswer)) { alert('Enter a valid number'); return; }
            mathState.total++;
            if (userAnswer === currentAnswer) {
                mathState.score++;
                feedbackDiv.style.display = 'block';
                feedbackDiv.textContent = '‚úÖ Correct!';
                feedbackDiv.style.background = '#e8f5e9';
                playSound('correct');
            } else {
                feedbackDiv.style.display = 'block';
                feedbackDiv.textContent = `‚ùå Wrong! Answer was ${currentAnswer}`;
                feedbackDiv.style.background = '#ffebee';
                playSound('wrong');
            }
            scoreDiv.textContent = `Score: ${mathState.score}/${mathState.total}`;
            answerInput.value = '';
            setTimeout(() => {
                currentAnswer = generateQuestion();
                answerInput.focus();
            }, 1500);
        };
    }

    // Voice Recording
    function initVoiceRecord() {
        const phraseSelect = document.getElementById('voicePhrase');
        const playBtn = document.getElementById('voicePlay');
        const recordBtn = document.getElementById('voiceRecord');
        const stopBtn = document.getElementById('voiceStop');
        const playbackDiv = document.getElementById('voicePlayback');
        const audio = document.getElementById('voiceAudio');
        let mediaRecorder = null;
        let audioChunks = [];

        playBtn.onclick = () => {
            const phrase = phraseSelect.value || 'hello';
            speakText(phrase);
        };

        recordBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/wav' });
                    audio.src = URL.createObjectURL(blob);
                    playbackDiv.style.display = 'block';
                    playSound('correct');
                };
                mediaRecorder.start();
                recordBtn.style.background = '#ff6b6b';
                recordBtn.textContent = 'üî¥ Recording...';
            } catch (e) { alert('Microphone access denied'); }
        };

        stopBtn.onclick = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                recordBtn.style.background = '';
                recordBtn.textContent = 'üéôÔ∏è Record Me';
            }
        };
    }

    // Story Reading with TTS
    const storyContent = {
        littleseed: 'A tiny seed was planted in the ground. Every day it was watered and cared for. Slowly, the seed sprouted and grew into a beautiful green plant. It bloomed with colorful flowers! The little seed learned that with patience and care, anything can grow.',
        kindchild: 'Once there was a kind child who always shared food with hungry friends. One day the child found a lost puppy and took it home. The whole neighborhood came together to help. Everyone learned that kindness makes the world beautiful. The kind child became everyone\'s best friend.',
        adventure: 'Deep in the forest lived a curious child who loved adventures. One sunny day, the child explored the forest path and discovered a magical waterfall hidden behind tall trees. Beautiful birds sang and colorful butterflies danced around the water. It was the most amazing discovery ever!'
    };

    function initStoryRead() {
        const storySelect = document.getElementById('storySelect');
        const storyText = document.getElementById('storyText');
        const readBtn = document.getElementById('storyRead');
        const pauseBtn = document.getElementById('storyPause');
        const speedSlider = document.getElementById('storySpeed');

        storySelect.onchange = () => {
            const key = storySelect.value;
            storyText.textContent = storyContent[key] || 'Select a story...';
        };

        readBtn.onclick = () => {
            const text = storyText.textContent;
            if (text === 'Select a story...') { alert('Please select a story first'); return; }
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = parseFloat(speedSlider.value);
            u.pitch = 1.2;
            window.speechSynthesis.speak(u);
            playSound('click');
        };

        pauseBtn.onclick = () => window.speechSynthesis.pause();
    }

    // Puzzle Game
    function initPuzzle() {
        const typeSelect = document.getElementById('puzzleType');
        const startBtn = document.getElementById('puzzleStart');
        const board = document.getElementById('puzzleBoard');
        const movesDiv = document.getElementById('puzzleMoves');
        const timeDiv = document.getElementById('puzzleTime');

        let moves = 0, seconds = 0, timer = null;

        startBtn.onclick = () => {
            const type = typeSelect.value;
            moves = 0;
            seconds = 0;
            movesDiv.textContent = moves;
            timeDiv.textContent = seconds;
            board.innerHTML = '';

            if (timer) clearInterval(timer);
            timer = setInterval(() => { seconds++; timeDiv.textContent = seconds; }, 1000);

            if (type === 'memory') {
                const icons = ['üçé', 'üçå', 'üê±', 'üê∂', '‚≠ê', '‚öΩ', 'üéµ', 'üåü'];
                let cards = icons.concat(icons).sort(() => Math.random() - 0.5);
                let first = null, locked = false;
                board.style.gridTemplateColumns = 'repeat(4,80px)';
                cards.forEach(c => {
                    const card = document.createElement('div');
                    card.style.cssText = 'width:80px;height:80px;background:#ddd;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;transition:0.3s';
                    card.dataset.icon = c;
                    card.textContent = '‚ùî';
                    card.onclick = () => {
                        if (locked || card.textContent !== '‚ùî') return;
                        card.textContent = c;
                        if (!first) {
                            first = card;
                        } else {
                            locked = true;
                            moves++;
                            movesDiv.textContent = moves;
                            if (first.dataset.icon === card.dataset.icon) {
                                first.style.opacity = '0.5';
                                card.style.opacity = '0.5';
                                first = null;
                                locked = false;
                            } else {
                                setTimeout(() => {
                                    first.textContent = '‚ùî';
                                    card.textContent = '‚ùî';
                                    first = null;
                                    locked = false;
                                }, 800);
                            }
                        }
                    };
                    board.appendChild(card);
                });
            } else {
                board.innerHTML = '<p style="grid-column:1/-1;text-align:center">Puzzle game loading...</p>';
            }
        };
    }

    // Achievement Badges
    const badges = [
        { id: 'first', name: 'First Steps', emoji: 'üë£', condition: 'Complete 1 activity' },
        { id: 'alpha', name: 'Alphabet Master', emoji: 'üî§', condition: 'Learn all letters' },
        { id: 'number', name: 'Number Whiz', emoji: 'üî¢', condition: 'Count to 100' },
        { id: 'game', name: 'Game Champion', emoji: 'üèÜ', condition: 'Win 5 games' },
        { id: 'star', name: 'Star Collector', emoji: '‚≠ê', condition: 'Earn 50 stars' },
        { id: 'hindi', name: 'Hindi Scholar', emoji: 'üáÆüá≥', condition: 'Learn 10 Hindi words' },
        { id: 'math', name: 'Math Master', emoji: 'üßÆ', condition: 'Solve 20 problems' },
        { id: 'story', name: 'Story Lover', emoji: 'üìö', condition: 'Read 5 stories' },
        { id: 'artist', name: 'Artist', emoji: 'üé®', condition: 'Create 3 drawings' },
        { id: 'voice', name: 'Voice Star', emoji: 'üé§', condition: 'Record 5 times' },
        { id: 'puzzle', name: 'Puzzle Pro', emoji: 'üéÆ', condition: 'Solve 10 puzzles' },
        { id: 'streak', name: 'Streak Champion', emoji: 'üî•', condition: '7-day streak' }
    ];

    function initAchievements() {
        const grid = document.getElementById('badgesGrid');
        const countSpan = document.getElementById('badgeCount');
        const progressBar = document.getElementById('badgeProgressBar');
        grid.innerHTML = '';

        const earned = JSON.parse(localStorage.getItem('earnedBadges') || '[]');
        countSpan.textContent = earned.length;
        progressBar.style.width = (earned.length / badges.length * 100) + '%';

        badges.forEach(b => {
            const badgeEl = document.createElement('div');
            badgeEl.style.cssText = 'text-align:center;padding:10px;border-radius:8px;background:' + (earned.includes(b.id) ? '#fff9e6' : '#f0f0f0');
            badgeEl.innerHTML = `<div style="font-size:40px">${b.emoji}</div><div style="font-size:12px;font-weight:700">${b.name}</div><div style="font-size:10px;color:#666">${b.condition}</div>`;
            grid.appendChild(badgeEl);
        });
    }

    // Daily Challenges
    function initDailyChallenges() {
        const challengesDiv = document.getElementById('dailyChallenges');
        const weeklyDiv = document.getElementById('weeklyProgress');
        const streakSpan = document.getElementById('streakCount');

        const challenges = [
            '‚úÖ Learn 5 new words',
            '‚úÖ Play one game',
            '‚úÖ Practice Hindi',
            '‚úÖ Read a story',
            '‚úÖ Solve a puzzle'
        ];

        challengesDiv.innerHTML = challenges.map(c => `<div style="padding:8px;background:#fff;border-radius:6px;margin:4px 0">${c}</div>`).join('');

        const week = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        weeklyDiv.innerHTML = week.map((d, i) => `<div style="text-align:center;padding:8px;background:${i < 5 ? '#a8e6cf' : '#ffe8e8'};border-radius:6px"><div style="font-weight:700">${d}</div><div>${i < 5 ? '‚úÖ' : '‚≠ï'}</div></div>`).join('');

        const streak = localStorage.getItem('dailyStreak') || 0;
        streakSpan.textContent = streak;
    }

    function updateStars() { document.getElementById('pointsBadge').innerText = 'Stars: ' + getStars(); }

    /* ---------------- Visual Effects ---------------- */
    // Confetti (already exists, enhanced)
    const confCanvas = document.getElementById('confettiCanvas');
    const cctx = confCanvas ? confCanvas.getContext('2d') : null;
    let confetti = [];
    function resizeConf() {
        if (confCanvas) {
            confCanvas.width = window.innerWidth;
            confCanvas.height = window.innerHeight;
        }
    }
    window.addEventListener('resize', resizeConf);
    if (confCanvas) resizeConf();

    function makeConfetti() {
        if (!confCanvas || !cctx) return;
        confetti = [];
        const colors = ['#ffd166', '#ff6b6b', '#6ee7b7', '#9b5cff', '#4d96ff'];
        for (let i = 0; i < 70; i++) {
            confetti.push({
                x: Math.random() * confCanvas.width,
                y: Math.random() * -confCanvas.height,
                r: Math.random() * 8 + 4,
                c: colors[Math.floor(Math.random() * colors.length)],
                vx: (Math.random() - 0.5) * 2,
                vy: Math.random() * 3 + 2,
                rot: Math.random() * 360
            });
        }
        requestAnimationFrame(drawConf);
    }

    function drawConf() {
        if (!cctx || !confCanvas) return;
        cctx.clearRect(0, 0, confCanvas.width, confCanvas.height);
        confetti.forEach(p => {
            cctx.save();
            cctx.translate(p.x, p.y);
            cctx.rotate(p.rot * Math.PI / 180);
            cctx.fillStyle = p.c;
            cctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r * 0.6);
            cctx.restore();
            p.x += p.vx;
            p.y += p.vy;
            p.rot += 2;
        });
        confetti = confetti.filter(p => p.y < confCanvas.height + 50);
        if (confetti.length) requestAnimationFrame(drawConf);
    }

    function showConfetti() {
        makeConfetti();
        setTimeout(() => {
            confetti = [];
            cctx.clearRect(0, 0, confCanvas.width, confCanvas.height);
        }, 1500);
    }

    // Emoji Rain
    function showEmojiRain() {
        const emojis = ['‚≠ê', '‚ù§Ô∏è', 'üåü', 'üí´', '‚ú®'];
        const container = document.getElementById('emojiRain');

        for (let i = 0; i < 25; i++) {
            const drop = document.createElement('div');
            drop.className = 'emoji-drop';
            drop.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            drop.style.left = Math.random() * 100 + 'vw';
            drop.style.animationDuration = (Math.random() * 2 + 1) + 's';
            drop.style.opacity = Math.random() * 0.5 + 0.5;

            container.appendChild(drop);

            setTimeout(() => {
                drop.remove();
            }, 3000);
        }
    }

    // Cartoon GIF (simulated with CSS animation)
    function showCorrectGIF() {
        const gif = document.createElement('div');
        gif.className = 'correct-gif';
        gif.innerHTML = 'üéâ Correct! üéâ';
        gif.style.fontSize = '3rem';
        gif.style.fontWeight = 'bold';
        gif.style.color = '#ff6b6b';
        gif.style.textShadow = '0 0 10px white';

        document.body.appendChild(gif);

        setTimeout(() => {
            gif.remove();
        }, 1500);
    }

    // Mascot functionality
    const mascot = document.getElementById('mascot');
    const mascotMessages = [
        "Great job! Keep learning!",
        "You're doing amazing!",
        "Learning is fun with you!",
        "Wow! You're so smart!",
        "Let's play another game!",
        "You earned stars! Awesome!"
    ];

    function mascotSpeak() {
        const speech = mascot.querySelector('.mascot-speech');
        const randomMsg = mascotMessages[Math.floor(Math.random() * mascotMessages.length)];
        speech.textContent = randomMsg;

        // Show speech bubble
        speech.style.opacity = '1';

        setTimeout(() => {
            speech.style.opacity = '0';
        }, 3000);
    }

    mascot.addEventListener('click', mascotSpeak);

    /* ---------------- Populate UI ---------------- */
    function makeTile(icon, label, onclick, chapterId = null) {
        const d = document.createElement('div');
        d.className = 'tile';
        d.innerHTML = `<div class="emoji">${icon}</div><div class="big">${label}</div>`;
        d.addEventListener('click', () => {
            playSound('click');
            onclick();
            // NEW: Add chapter score when tile is clicked
            if (chapterId) {
                addStars(1, chapterId);
            }
        });
        d.addEventListener('touchend', e => {
            e.preventDefault();
            playSound('click');
            onclick();
            // NEW: Add chapter score when tile is clicked
            if (chapterId) {
                addStars(1, chapterId);
            }
        });
        return d;
    }

    /* Home */
    const homeGrid = document.getElementById('homeGrid');
    homeGrid.appendChild(makeTile('üî§', 'Alphabet', () => switchTab('alphabet', document.querySelector('.tab[data-tab=alphabet]'))));
    homeGrid.appendChild(makeTile('üî¢', 'Numbers', () => switchTab('numbers', document.querySelector('.tab[data-tab=numbers]'))));
    homeGrid.appendChild(makeTile('üé®', 'Colors', () => switchTab('colors', document.querySelector('.tab[data-tab=colors]'))));
    homeGrid.appendChild(makeTile('üî∫', 'Shapes', () => switchTab('shapes', document.querySelector('.tab[data-tab=shapes]'))));
    homeGrid.appendChild(makeTile('üçé', 'Fruits & Veg', () => switchTab('fruits', document.querySelector('.tab[data-tab=fruits]'))));
    homeGrid.appendChild(makeTile('üß†', 'Games', () => switchTab('games', document.querySelector('.tab[data-tab=games]'))));
    homeGrid.appendChild(makeTile('ü¶ì', 'Animals', () => switchTab('animals', document.querySelector('.tab[data-tab=animals]'))));
    homeGrid.appendChild(makeTile('üîÑ', 'Opposites', () => switchTab('opposites', document.querySelector('.tab[data-tab=opposites]'))));
    homeGrid.appendChild(makeTile('ü™î', 'Hindi', () => switchTab('hindi', document.querySelector('.tab[data-tab=hindi]'))));
    // NEW: Add new modules to home
    homeGrid.appendChild(makeTile('üî¨', 'Science', () => switchTab('science', document.querySelector('.tab[data-tab=science]'))));
    homeGrid.appendChild(makeTile('üåç', 'Geography', () => switchTab('geography', document.querySelector('.tab[data-tab=geography]'))));
    homeGrid.appendChild(makeTile('‚è∞', 'Time', () => switchTab('time', document.querySelector('.tab[data-tab=time]'))));

    /* Alphabet */
    const alphabetGrid = document.getElementById('alphabetGrid');
    alphabet.forEach((it, idx) => {
        const label = `${it.L} ‚Äî ${it.words.join(', ')}`;
        const node = makeTile(it.art, label, () => {
            document.getElementById('alphaBig').innerText = `${it.L} ‚Äî ${it.words[0]} ${it.art}`;
            document.getElementById('alphaPhonics').innerText = `Phonics: ${it.phonics} ‚Ä¢ Examples: ${it.words.join(', ')}`;
            speakText(`${it.L}. ${it.words[0]}. ${it.words[1] || ''}`);
            showConfetti();
        }, 'alphabet'); // NEW: Added chapter ID
        alphabetGrid.appendChild(node);
    });

    let alphaIndex = 0;
    function showAlpha() {
        const it = alphabet[alphaIndex];
        document.getElementById('alphaBig').innerText = `${it.L} ‚Äî ${it.words[0]} ${it.art}`;
        document.getElementById('alphaPhonics').innerText = `Phonics: ${it.phonics} ‚Ä¢ Examples: ${it.words.join(', ')}`;
    }

    function alphaPrev() {
        alphaIndex = (alphaIndex - 1 + alphabet.length) % alphabet.length;
        showAlpha();
    }

    function alphaNext() {
        alphaIndex = (alphaIndex + 1) % alphabet.length;
        showAlpha();
    }

    function alphaSpeak() {
        const it = alphabet[alphaIndex];
        speakText(`${it.L}. ${it.words.join(', ')}`);
        addStars(1, 'alphabet'); // NEW: Added chapter ID
    }

    function alphaSpeakSlow() {
        const it = alphabet[alphaIndex];
        speakText(`${it.L}. ${it.words.join(', ')}`, true);
        addStars(1, 'alphabet'); // NEW: Added chapter ID
    }

    /* Numbers */
    const numbersGridLarge = document.getElementById('numbersGridLarge');
    numbers.forEach(n => {
        const node = makeTile(n, 'Number ' + n, () => {
            speakText(String(n));
            showCountPictures(n);
            addStars(1, 'numbers'); // NEW: Added chapter ID
        }, 'numbers'); // NEW: Added chapter ID
        numbersGridLarge.appendChild(node);
    });

    function speakAllNumbers() {
        for (let i = 1; i <= 20; i++) {
            setTimeout(() => speakText(String(i)), i * 350);
        }
    }

    function playCountingSong() {
        speakText('One two buckle my shoe. Three four knock on the door.');
    }

    function showCountPictures(n) {
        const c = document.getElementById('countPictures');
        c.innerHTML = '';
        const max = Math.min(n, 20);
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.flexWrap = 'wrap';
        row.style.gap = '6px';
        for (let i = 0; i < max; i++) {
            const el = document.createElement('div');
            el.className = 'tile';
            el.style.minWidth = '40px';
            el.innerText = 'üçé';
            row.appendChild(el);
        }
        c.appendChild(row);
    }

    /* Colors */
    const colorsGrid = document.getElementById('colorsGrid');
    colors.forEach(c => {
        const node = document.createElement('div');
        node.className = 'tile';
        node.innerHTML = `<div style="height:60px;border-radius:10px;background:${c.hex};margin-bottom:8px"></div><div class="big">${c.name}</div>`;
        node.onclick = () => {
            playSound('click');
            speakText(c.name);
            addStars(1, 'colors'); // NEW: Added chapter ID
            showConfetti();
        };
        colorsGrid.appendChild(node);
    });

    /* Shapes */
    const shapesGrid = document.getElementById('shapesGrid');
    shapes.forEach(s => {
        const node = makeTile(s.art, s.name, () => {
            playSound('click');
            speakText(s.name);
            addStars(1, 'shapes'); // NEW: Added chapter ID
            showConfetti();
        }, 'shapes'); // NEW: Added chapter ID
        shapesGrid.appendChild(node);
    });

    /* Fruits */
    const fruitsGrid = document.getElementById('fruitsGrid');
    fruits.forEach(f => {
        fruitsGrid.appendChild(makeTile(f.art, f.name, () => {
            speakText(f.name);
            addStars(1, 'fruits'); // NEW: Added chapter ID
            showConfetti();
        }, 'fruits')); // NEW: Added chapter ID
    });

    /* Body parts */
    const bodyGrid = document.getElementById('bodyGrid');
    bodyParts.forEach(p => bodyGrid.appendChild(makeTile(p.art, p.name, () => {
        speakText(p.name);
        addStars(1, 'body'); // NEW: Added chapter ID
        showConfetti();
    }, 'body'))); // NEW: Added chapter ID

    /* Vehicles */
    const vehiclesGrid = document.getElementById('vehiclesGrid');
    vehicles.forEach(v => vehiclesGrid.appendChild(makeTile(v.art, v.name, () => {
        speakText(v.name);
        addStars(1, 'vehicles'); // NEW: Added chapter ID
        showConfetti();
    }, 'vehicles'))); // NEW: Added chapter ID

    /* Season/Weather */
    const seasonGrid = document.getElementById('seasonGrid');
    seasons.forEach(s => seasonGrid.appendChild(makeTile(s.art, s.name, () => {
        speakText(s.name);
        addStars(1, 'season'); // NEW: Added chapter ID
        showConfetti();
    }, 'season'))); // NEW: Added chapter ID
    weather.forEach(w => seasonGrid.appendChild(makeTile(w.art, w.name, () => {
        speakText(w.name);
        addStars(1, 'season'); // NEW: Added chapter ID
        showConfetti();
    }, 'season'))); // NEW: Added chapter ID

    /* Classroom */
    const classGrid = document.getElementById('classGrid');
    classroom.forEach(c => classGrid.appendChild(makeTile(c.art, c.name, () => {
        speakText(c.name);
        addStars(1, 'classroom'); // NEW: Added chapter ID
        showConfetti();
    }, 'classroom'))); // NEW: Added chapter ID

    /* Hindi Words */
    const hindiGrid = document.getElementById('hindiGrid');
    hindiWords.forEach(word => {
        const tileEl = document.createElement('div');
        tileEl.className = 'tile';
        tileEl.style.position = 'relative';
        tileEl.style.padding = '15px';
        tileEl.innerHTML = `
            <div class="emoji">${word.art}</div>
            <div class="big" style="margin: 8px 0; font-size: 1rem;">${word.english}</div>
            <div class="hindi-word" style="font-size: 1.3rem; margin: 6px 0;">${word.hindi}</div>
            <div class="mini" style="margin: 4px 0; color: #999; font-style: italic;">${word.pronunciation}</div>
            <div style="display: flex; gap: 6px; margin-top: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="tab" style="padding: 6px 10px; font-size: 0.85rem; background: linear-gradient(90deg, #ff9f43, #ff6b6b);" onclick="speakHindi('${word.hindi}', '${word.pronunciation}'); playSound('click');">üîä Hindi</button>
                <button class="tab" style="padding: 6px 10px; font-size: 0.85rem; background: linear-gradient(90deg, #6ee7b7, #4da6ff);" onclick="speakHindi('${word.hindi}', '${word.pronunciation}', true); playSound('click');">üê¢ Slow</button>
            </div>
        `;

        tileEl.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                playSound('click');
                speakText(`${word.english} is ${word.hindi} in Hindi`);
                addStars(1, 'hindi');
                showConfetti();
            }
        });

        hindiGrid.appendChild(tileEl);
    });

    /* Opposites */
    const oppositesGrid = document.getElementById('oppositesGrid');
    opposites.forEach(pair => {
        oppositesGrid.appendChild(makeTile(pair.arts[0] + pair.arts[1], `${pair.pair[0]} - ${pair.pair[1]}`, () => {
            speakText(`${pair.pair[0]} and ${pair.pair[1]} are opposites`);
            addStars(1, 'opposites'); // NEW: Added chapter ID
            showConfetti();
        }, 'opposites')); // NEW: Added chapter ID
    });

    /* Farm Animals */
    const animalsGrid = document.getElementById('animalsGrid');
    farmAnimals.forEach(animal => {
        animalsGrid.appendChild(makeTile(animal.art, `${animal.name} - ${animal.sound}`, () => {
            speakText(`The ${animal.name} says ${animal.sound}`);
            // Try to play animal sound
            if (animal.sound.toLowerCase().includes('moo')) {
                speakText('Moooooo');
            } else if (animal.sound.toLowerCase().includes('baa')) {
                speakText('Baaaaaa');
            } else if (animal.sound.toLowerCase().includes('oink')) {
                speakText('Oink oink');
            } else if (animal.sound.toLowerCase().includes('cluck')) {
                speakText('Cluck cluck');
            } else if (animal.sound.toLowerCase().includes('quack')) {
                speakText('Quack quack');
            } else if (animal.sound.toLowerCase().includes('neigh')) {
                speakText('Neighhhhh');
            } else if (animal.sound.toLowerCase().includes('bleat')) {
                speakText('Bleat bleat');
            } else if (animal.sound.toLowerCase().includes('cock')) {
                speakText('Cock-a-doodle-doo');
            } else if (animal.sound.toLowerCase().includes('woof')) {
                speakText('Woof woof');
            } else if (animal.sound.toLowerCase().includes('meow')) {
                speakText('Meow meow');
            } else if (animal.sound.toLowerCase().includes('gobble')) {
                speakText('Gobble gobble');
            } else if (animal.sound.toLowerCase().includes('hee')) {
                speakText('Hee-haw');
            } else if (animal.sound.toLowerCase().includes('honk')) {
                speakText('Honk honk');
            } else if (animal.sound.toLowerCase().includes('buzz')) {
                speakText('Buzz buzz');
            } else {
                speakText(animal.sound);
            }
            addStars(1, 'animals'); // NEW: Added chapter ID
            showConfetti();
        }, 'animals')); // NEW: Added chapter ID
    });

    /* Poems & stories with text highlighting */
    const poemGrid = document.getElementById('poemGrid');
    Object.entries(poems).forEach(([k, lines]) => {
        poemGrid.appendChild(makeTile('üéµ', k, () => { showPoem(k, lines); }, 'poems')); // NEW: Added chapter ID
    });

    function showPoem(title, lines) {
        const area = document.getElementById('poemPlayArea');
        area.innerHTML = `<div style="font-weight:900">${title}</div><div class="mini" id="poemLines"></div><div style="margin-top:8px" class="controls"><button class="tab" onclick="playPoem('${title}')">Play</button></div>`;

        // Add highlighting animation
        const poemLines = document.getElementById('poemLines');
        lines.forEach((line, index) => {
            const lineDiv = document.createElement('div');
            lineDiv.innerHTML = line;
            lineDiv.style.marginBottom = '8px';
            poemLines.appendChild(lineDiv);
        });

        playPoem(title);
    }

    function playPoem(title) {
        const lines = poems[title];
        if (!lines) return;

        const lineDivs = document.querySelectorAll('#poemLines div');

        // Reset all lines
        lineDivs.forEach(div => {
            div.innerHTML = div.textContent; // Remove any existing spans
        });

        // Play line by line with highlighting
        let i = 0;
        function nextLine() {
            if (i >= lines.length) return;

            // Highlight current line
            const currentDiv = lineDivs[i];
            const words = currentDiv.textContent.split(' ');
            currentDiv.innerHTML = words.map(word =>
                `<span class="highlight-text">${word}</span>`
            ).join(' ');

            speakText(lines[i]);
            i++;
            setTimeout(nextLine, 2500);
        }
        nextLine();
        addStars(1, 'poems'); // NEW: Added chapter ID
    }

    /* Stories */
    const storiesList = document.getElementById('storiesList');
    stories.forEach(s => {
        const div = document.createElement('div');
        div.className = 'panel tile';
        div.style.display = 'flex';
        div.style.gap = '10px';
        div.style.alignItems = 'center';
        div.innerHTML = `<div style="font-size:36px">üìñ</div><div><div style="font-weight:900">${s.title}</div><div class="mini">${s.text}</div><div style="margin-top:8px"><button class="tab" onclick="speakText('${s.text.replace(/'/g, '')}')">Read</button></div></div>`;
        storiesList.appendChild(div);
    });

    /* ---------------- NEW GAMES IMPLEMENTATION ---------------- */

    // Balloon Pop Quiz
    function startBalloonGame() {
        const container = document.getElementById('balloonContainer');
        container.innerHTML = '';

        const targetLetter = alphabet[Math.floor(Math.random() * alphabet.length)].L;
        const balloons = [];

        // Create balloons with random letters
        for (let i = 0; i < 8; i++) {
            const balloon = document.createElement('div');
            balloon.className = 'balloon';

            if (i === 0) {
                balloon.innerText = targetLetter;
                balloon.dataset.correct = true;
            } else {
                // Get a random letter that's not the target
                let randomLetter;
                do {
                    randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)].L;
                } while (randomLetter === targetLetter);
                balloon.innerText = randomLetter;
            }

            balloon.addEventListener('click', function () {
                if (this.dataset.correct) {
                    playSound('correct');
                    this.classList.add('balloon-pop');
                    showCorrectGIF();
                    addStars(2, 'games'); // NEW: Added chapter ID
                    document.getElementById('balloonScore').innerText =
                        'Score: ' + (parseInt(document.getElementById('balloonScore').innerText.split(':')[1]) + 1);
                    setTimeout(startBalloonGame, 1000);
                } else {
                    playSound('wrong');
                    this.style.background = '#ccc';
                    speakText('Try again');
                }
            });

            balloons.push(balloon);
        }

        // Shuffle and add to container
        shuffle(balloons).forEach(balloon => container.appendChild(balloon));

        speakText(`Pop the balloon with letter ${targetLetter}`);
    }

    // Odd One Out Game
    function startOddOneOut() {
        const container = document.getElementById('oddOneContainer');
        container.innerHTML = '';

        const categories = [
            { name: 'Fruits', items: ['üçé', 'üçå', 'üçä', 'üöó'], odd: 'üöó' },
            { name: 'Animals', items: ['üê±', 'üê∂', 'üêò', 'üìö'], odd: 'üìö' },
            { name: 'Shapes', items: ['üî∫', 'üü•', 'üü¢', 'üê¶'], odd: 'üê¶' },
            { name: 'Vehicles', items: ['üöó', 'üöå', '‚úàÔ∏è', 'üçé'], odd: 'üçé' }
        ];

        const category = categories[Math.floor(Math.random() * categories.length)];
        const items = shuffle(category.items);

        items.forEach(item => {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.style.fontSize = '2rem';
            tile.innerHTML = `<div>${item}</div>`;

            tile.addEventListener('click', function () {
                if (item === category.odd) {
                    playSound('correct');
                    showCorrectGIF();
                    addStars(2, 'games'); // NEW: Added chapter ID
                    document.getElementById('oddOneScore').innerText =
                        'Score: ' + (parseInt(document.getElementById('oddOneScore').innerText.split(':')[1]) + 1);
                    speakText('Correct! The ' + item + ' is different');
                    setTimeout(startOddOneOut, 1500);
                } else {
                    playSound('wrong');
                    speakText('Try again');
                }
            });

            container.appendChild(tile);
        });

        speakText(`Find the one that doesn't belong`);
    }

    // Jigsaw Puzzle
    function startJigsaw() {
        const container = document.getElementById('jigsawContainer');
        container.innerHTML = '';

        const pieces = 9;
        const pieceSize = 100;

        for (let i = 0; i < pieces; i++) {
            const piece = document.createElement('div');
            piece.className = 'jigsaw-piece';
            piece.style.width = pieceSize + 'px';
            piece.style.height = pieceSize + 'px';

            // Simple color-based jigsaw
            const colors = ['#ff6b6b', '#4da6ff', '#2ecc71', '#ffd166', '#9b59b6', '#ff9f43', '#1abc9c', '#e74c3c', '#3498db'];
            piece.style.backgroundColor = colors[i];
            piece.innerText = i + 1;
            piece.style.display = 'flex';
            piece.style.alignItems = 'center';
            piece.style.justifyContent = 'center';
            piece.style.color = 'white';
            piece.style.fontWeight = 'bold';

            container.appendChild(piece);
        }

        document.getElementById('jigsawStatus').innerText = 'Put in order 1-9';
    }

    // Fast Flash Quiz
    let flashTimer;
    let flashScore = 0;

    function startFlashQuiz() {
        const questionEl = document.getElementById('flashQuizQuestion');
        const optionsEl = document.getElementById('flashQuizOptions');
        const timerEl = document.getElementById('flashTimer');

        optionsEl.innerHTML = '';
        flashScore = 0;

        let timeLeft = 10;
        timerEl.innerText = `Time: ${timeLeft}s`;

        flashTimer = setInterval(() => {
            timeLeft--;
            timerEl.innerText = `Time: ${timeLeft}s`;

            if (timeLeft <= 0) {
                clearInterval(flashTimer);
                questionEl.innerText = 'Time\'s up!';
                speakText(`Game over! You scored ${flashScore} points`);
                return;
            }
        }, 1000);

        generateFlashQuestion();
    }

    function generateFlashQuestion() {
        const questionEl = document.getElementById('flashQuizQuestion');
        const optionsEl = document.getElementById('flashQuizOptions');

        const category = Math.random() > 0.5 ? 'letter' : 'number';

        if (category === 'letter') {
            const letter = alphabet[Math.floor(Math.random() * alphabet.length)];
            questionEl.innerText = `Find: ${letter.words[0]}`;

            const options = shuffle([
                { correct: true, art: letter.art },
                { correct: false, art: alphabet[Math.floor(Math.random() * alphabet.length)].art },
                { correct: false, art: alphabet[Math.floor(Math.random() * alphabet.length)].art },
                { correct: false, art: alphabet[Math.floor(Math.random() * alphabet.length)].art }
            ]);

            optionsEl.innerHTML = '';
            options.forEach(option => {
                const btn = document.createElement('div');
                btn.className = 'tile';
                btn.style.fontSize = '2rem';
                btn.innerHTML = `<div>${option.art}</div>`;

                btn.addEventListener('click', function () {
                    if (option.correct) {
                        playSound('correct');
                        flashScore++;
                        showCorrectGIF();
                        addStars(1, 'games'); // NEW: Added chapter ID
                        generateFlashQuestion();
                    } else {
                        playSound('wrong');
                    }
                });

                optionsEl.appendChild(btn);
            });
        } else {
            const number = Math.floor(Math.random() * 10) + 1;
            questionEl.innerText = `Find: ${number}`;

            const options = shuffle([
                { correct: true, number: number },
                { correct: false, number: (number % 10) + 1 },
                { correct: false, number: Math.max(1, number - 1) },
                { correct: false, number: (number + 2) % 10 || 1 }
            ]);

            optionsEl.innerHTML = '';
            options.forEach(option => {
                const btn = document.createElement('div');
                btn.className = 'tile';
                btn.innerHTML = `<div class="big">${option.number}</div>`;

                btn.addEventListener('click', function () {
                    if (option.correct) {
                        playSound('correct');
                        flashScore++;
                        showCorrectGIF();
                        addStars(1, 'games'); // NEW: Added chapter ID
                        generateFlashQuestion();
                    } else {
                        playSound('wrong');
                    }
                });

                optionsEl.appendChild(btn);
            });
        }
    }

    // Simon Memory Game
    let simonSequence = [];
    let userSequence = [];
    let simonLevel = 1;
    let isSimonPlaying = false;

    function startSimon() {
        simonSequence = [];
        userSequence = [];
        simonLevel = 1;
        document.getElementById('simonLevel').innerText = 'Level: 1';
        nextSimonRound();
    }

    function nextSimonRound() {
        isSimonPlaying = true;
        userSequence = [];

        // Add one more color to sequence
        const colors = ['red', 'blue', 'green', 'yellow'];
        simonSequence.push(colors[Math.floor(Math.random() * colors.length)]);

        // Play the sequence
        playSimonSequence();
    }

    function playSimonSequence() {
        let i = 0;
        const interval = setInterval(() => {
            if (i >= simonSequence.length) {
                clearInterval(interval);
                isSimonPlaying = false;
                return;
            }

            const color = simonSequence[i];
            lightUpSimonButton(color);
            i++;
        }, 800);
    }

    function lightUpSimonButton(color) {
        const button = document.querySelector(`.simon-button[data-color="${color}"]`);
        button.classList.add('active');

        // Play sound based on color
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        const frequencies = { red: 261.63, blue: 329.63, green: 392.00, yellow: 523.25 };
        oscillator.frequency.setValueAtTime(frequencies[color], audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);

        setTimeout(() => {
            button.classList.remove('active');
        }, 500);
    }

    // Add click handlers to Simon buttons
    document.querySelectorAll('.simon-button').forEach(button => {
        button.addEventListener('click', function () {
            if (isSimonPlaying) return;

            const color = this.dataset.color;
            userSequence.push(color);
            lightUpSimonButton(color);

            // Check if user sequence matches
            for (let i = 0; i < userSequence.length; i++) {
                if (userSequence[i] !== simonSequence[i]) {
                    // Game over
                    playSound('wrong');
                    speakText(`Game over! You reached level ${simonLevel}`);
                    return;
                }
            }

            // If sequences match so far
            if (userSequence.length === simonSequence.length) {
                playSound('correct');
                showCorrectGIF();
                addStars(simonLevel, 'games'); // NEW: Added chapter ID
                simonLevel++;
                document.getElementById('simonLevel').innerText = `Level: ${simonLevel}`;
                setTimeout(nextSimonRound, 1000);
            }
        });
    });

    /* ---------------- REWARDS SYSTEM ---------------- */

    // Progress Badges
    function renderProgressBadges() {
        const container = document.getElementById('progressBadges');
        container.innerHTML = '';

        progressBadges.forEach(badge => {
            const badgeEl = document.createElement('div');
            badgeEl.className = 'progress-badge';
            badgeEl.innerHTML = `
                    <div style="font-size: 2rem">${badge.art}</div>
                    <div>${badge.name}</div>
                    <div style="font-size: 0.8em">${badge.description}</div>
                `;
            container.appendChild(badgeEl);
        });
    }

    // Reward Wheel
    function setupRewardWheel() {
        const wheel = document.getElementById('rewardWheel');
        const result = document.getElementById('wheelResult');

        wheel.addEventListener('click', function () {
            // Check if already spun today
            const lastSpin = localStorage.getItem('kids_last_spin');
            const today = new Date().toDateString();

            if (lastSpin === today) {
                result.innerText = 'Come back tomorrow for another spin!';
                return;
            }

            // Spin the wheel
            const spinDegrees = 1800 + Math.floor(Math.random() * 360);
            wheel.style.transform = `rotate(${spinDegrees}deg)`;

            // Calculate reward based on final position
            setTimeout(() => {
                const normalizedDegrees = spinDegrees % 360;
                let reward = 0;

                if (normalizedDegrees < 60) reward = 5;
                else if (normalizedDegrees < 120) reward = 10;
                else if (normalizedDegrees < 180) reward = 15;
                else if (normalizedDegrees < 240) reward = 20;
                else if (normalizedDegrees < 300) reward = 25;
                else reward = 30;

                addStars(reward);
                result.innerText = `You won ${reward} stars!`;
                localStorage.setItem('kids_last_spin', today);
            }, 3000);
        });
    }

    // Wallpaper Collection
    function renderWallpaperCollection() {
        const container = document.getElementById('wallpaperCollection');
        container.innerHTML = '';

        wallpapers.forEach(wallpaper => {
            const wallpaperEl = document.createElement('div');
            wallpaperEl.className = 'wallpaper-item';
            wallpaperEl.innerHTML = `
                    <div class="wallpaper-preview" style="background: linear-gradient(45deg, #${Math.floor(Math.random() * 16777215).toString(16)}, #${Math.floor(Math.random() * 16777215).toString(16)})">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2rem;">
                            ${wallpaper.art}
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 5px;">
                        <div>${wallpaper.name}</div>
                        <div class="mini">${wallpaper.cost} ‚≠ê</div>
                    </div>
                `;

            wallpaperEl.addEventListener('click', function () {
                if (getStars() >= wallpaper.cost) {
                    addStars(-wallpaper.cost);
                    this.classList.add('unlocked');
                    this.classList.remove('locked');
                    speakText(`You unlocked the ${wallpaper.name} wallpaper!`);
                } else {
                    speakText(`You need ${wallpaper.cost} stars to unlock this`);
                }
            });

            container.appendChild(wallpaperEl);
        });
    }

    /* ---------------- EXISTING GAMES IMPLEMENTATION ---------------- */
    /* Utility shuffle */
    function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]] } return a; }
    function shuffleCopy(a) { return shuffle(a.slice()); }

    /* Memory match */
    let matchCards = [], matchState = { first: null, second: null, found: 0 };
    function startMatch() {
        const items = shuffleCopy(alphabet).slice(0, 8).map(a => ({ id: a.L, text: a.words[0], art: a.art }));
        const cards = [];
        items.forEach(it => { cards.push({ id: it.id, type: 'word', text: it.text }); cards.push({ id: it.id, type: 'art', text: it.art }); });
        matchCards = shuffleCopy(cards);
        const board = document.getElementById('matchBoard'); board.innerHTML = '';
        matchCards.forEach((c, idx) => {
            const b = document.createElement('div'); b.className = 'tile'; b.style.minHeight = '60px'; b.dataset.idx = idx; b.innerHTML = '<div class="mini">?</div>';
            b.addEventListener('click', () => revealCard(b, c, idx));
            board.appendChild(b);
        });
        matchState = { first: null, second: null, found: 0 };
        document.getElementById('matchScore').innerText = '';
    }

    function revealCard(el, c, idx) {
        if (el.classList.contains('matched') || matchState.second) return;
        el.innerHTML = `<div style="font-weight:900">${c.text}</div>`;
        if (!matchState.first) { matchState.first = { el, c, idx }; return; }
        matchState.second = { el, c, idx };
        if (matchState.first.c.id === matchState.second.c.id && matchState.first.c.type !== matchState.second.c.type) {
            matchState.first.el.classList.add('matched'); matchState.second.el.classList.add('matched'); matchState.found++;
            document.getElementById('matchScore').innerText = `Found ${matchState.found}`;
            playSound('correct');
            speakText('Great match!'); addStars(2, 'games'); showConfetti(); // NEW: Added chapter ID
            matchState.first = null; matchState.second = null;
        } else {
            playSound('wrong');
            speakText('Try again'); setTimeout(() => { matchState.first.el.innerHTML = '<div class="mini">?</div>'; matchState.second.el.innerHTML = '<div class="mini">?</div>'; matchState.first = null; matchState.second = null; }, 700);
        }
    }

    /* Drag & Drop word to picture */
    let dragPairs = [];
    function startDragDrop() {
        const pool = document.getElementById('dragPool'), targets = document.getElementById('dragTargets');
        pool.innerHTML = ''; targets.innerHTML = '';
        const items = shuffleCopy(fruits).slice(0, 4);
        dragPairs = items.map(it => ({ id: it.name, name: it.name, art: it.art }));
        items.forEach(it => {
            const t = document.createElement('div'); t.className = 'tile'; t.innerHTML = `<div style="font-size:36px">${it.art}</div><div class="mini">${it.name}</div>`; t.dataset.id = it.name;
            t.addEventListener('dragover', e => e.preventDefault()); t.addEventListener('drop', e => { e.preventDefault(); const pid = e.dataTransfer.getData('text'); handleDrop(pid, t); });
            targets.appendChild(t);
        });
        const names = shuffleCopy(items.map(i => i.name));
        names.forEach(n => {
            const el = document.createElement('div'); el.className = 'draggable'; el.draggable = true; el.innerText = n;
            el.addEventListener('dragstart', e => e.dataTransfer.setData('text', n));
            pool.appendChild(el);
        });
        document.getElementById('dragScore').innerText = '0';
    }

    function handleDrop(name, target) {
        const match = dragPairs.find(p => p.name === name && p.id === target.dataset.id);
        if (match) {
            target.style.border = '3px solid #6ee7b7';
            target.innerHTML = `<div style="font-size:36px">${match.art}</div><div class="mini">‚úî ${match.name}</div>`;
            playSound('correct');
            addStars(2, 'games'); // NEW: Added chapter ID
            document.getElementById('dragScore').innerText = Number(document.getElementById('dragScore').innerText || 0) + 1;
            speakText('Correct!');
            showConfetti();
        } else {
            playSound('wrong');
            speakText('Try again');
            target.style.border = '3px solid #ff9fa6';
            if (navigator.vibrate) navigator.vibrate(80);
        }
    }

    /* Spelling game */
    let spellWord = '', userSpelling = '';
    function startSpelling() {
        const pool = shuffleCopy(alphabet.map(a => a.words[0])).slice(0, 8);
        spellWord = pool[Math.floor(Math.random() * pool.length)].toUpperCase();
        userSpelling = '';
        document.getElementById('spellWord').innerText = '_ '.repeat(spellWord.length);
        const letters = shuffleCopy(spellWord.split('').concat(shuffleCopy('ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('')).slice(0, 6))).slice(0, Math.min(12, spellWord.length + 6));
        const lettersEl = document.getElementById('spellLetters'); lettersEl.innerHTML = '';
        letters.forEach(ch => { const b = document.createElement('div'); b.className = 'draggable'; b.innerText = ch; b.addEventListener('click', () => pickLetter(ch)); lettersEl.appendChild(b); });
        document.getElementById('spellScore').innerText = '';
    }

    function pickLetter(ch) {
        userSpelling += ch;
        document.getElementById('spellWord').innerText = userSpelling.split('').join(' ');
        if (userSpelling.length === spellWord.length) {
            if (userSpelling === spellWord) {
                playSound('correct');
                speakText('Great!');
                addStars(3, 'games'); // NEW: Added chapter ID
                document.getElementById('spellScore').innerText = '1';
                showConfetti();
            } else {
                playSound('wrong');
                speakText('Not quite');
                document.getElementById('spellScore').innerText = '0';
            }
            setTimeout(() => startSpelling(), 900);
        }
    }

    /* Puzzle (simple shuffle pieces) */
    let puzzlePieces = [];
    function startPuzzle() {
        const area = document.getElementById('puzzleArea'); area.innerHTML = '';
        const imgEmojis = ['üçé', 'üê±', 'üöó', 'üåü', 'üçå', 'üê∂', '‚úàÔ∏è', '‚öΩ', 'üéà'];
        puzzlePieces = shuffleCopy(imgEmojis).slice(0, 9);
        puzzlePieces.forEach((p, idx) => {
            const d = document.createElement('div'); d.className = 'tile'; d.style.minHeight = '80px'; d.style.fontSize = '28px'; d.innerText = p;
            d.addEventListener('click', () => { /* simple click to remove to simulate puzzle */ d.style.opacity = 0.6; });
            area.appendChild(d);
        });
        document.getElementById('puzzleStatus').innerText = '';
    }

    /* Find-the-object */
    let currentFindTarget = '';
    function startFind() {
        const area = document.getElementById('findArea'); area.innerHTML = '';
        const pool = shuffleCopy(alphabet).slice(0, 6);
        const target = pool[Math.floor(Math.random() * pool.length)];
        currentFindTarget = target.words[0];
        pool.forEach(p => {
            const d = document.createElement('div'); d.className = 'tile'; d.style.minHeight = '80px'; d.innerHTML = `<div style="font-size:32px">${p.art}</div><div class="mini">${p.words[0]}</div>`;
            d.addEventListener('click', () => {
                if (p.words[0] === currentFindTarget) {
                    playSound('correct');
                    speakText('Yes!');
                    addStars(2, 'games'); // NEW: Added chapter ID
                    document.getElementById('findStatus').innerText = 'Found!';
                    showConfetti();
                } else {
                    playSound('wrong');
                    speakText('Try again');
                    document.getElementById('findStatus').innerText = 'Not this one';
                }
            });
            area.appendChild(d);
        });
        speakText('Find: ' + currentFindTarget);
    }

    /* Quick Quiz */
    let qScore = 0;
    function generateQuiz() {
        const optsEl = document.getElementById('quizOptions'); optsEl.innerHTML = '';
        const type = Math.random() > 0.5 ? 'animal' : 'word';
        if (type === 'animal') {
            const pick = shuffleCopy(alphabet)[Math.floor(Math.random() * alphabet.length)];
            document.getElementById('quizQ').innerText = `Tap the word: ${pick.words[0]}`;
            const pool = shuffleCopy(alphabet.map(a => a.words[0])).slice(0, 4);
            if (!pool.includes(pick.words[0])) pool[0] = pick.words[0];
            pool.forEach(c => {
                const b = document.createElement('div');
                b.className = 'quiz-option';
                b.innerText = c;
                b.addEventListener('click', () => {
                    if (c === pick.words[0]) {
                        b.classList.add('correct');
                        playSound('correct');
                        speakText('Correct');
                        qScore++;
                        addStars(2, 'games'); // NEW: Added chapter ID
                    } else {
                        b.classList.add('wrong');
                        playSound('wrong');
                        speakText('Try again');
                    }
                    document.getElementById('quizScore').innerText = 'Score:' + qScore;
                    setTimeout(generateQuiz, 900);
                });
                optsEl.appendChild(b);
            });
        } else {
            const pool = Object.keys(basicWordsFull || {}).length ? [].concat(...Object.values(basicWordsFull)) : alphabet.map(a => a.words[0]);
            const correct = shuffleCopy(pool)[0];
            document.getElementById('quizQ').innerText = `Tap the word: ${correct}`;
            const choices = shuffleCopy(pool).slice(0, 4);
            if (!choices.includes(correct)) choices[0] = correct;
            choices.forEach(c => {
                const b = document.createElement('div');
                b.className = 'quiz-option';
                b.innerText = c;
                b.addEventListener('click', () => {
                    if (c === correct) {
                        b.classList.add('correct');
                        playSound('correct');
                        speakText('Correct');
                        qScore++;
                        addStars(2, 'games'); // NEW: Added chapter ID
                    } else {
                        b.classList.add('wrong');
                        playSound('wrong');
                        speakText('Try again');
                    }
                    document.getElementById('quizScore').innerText = 'Score:' + qScore;
                    setTimeout(generateQuiz, 900);
                });
                optsEl.appendChild(b);
            });
        }
    }

    /* ---------------- Trace Canvas ---------------- */
    const traceCanvas = document.getElementById('traceCanvas'), tctx = traceCanvas.getContext('2d');
    let tracing = false, curLetter = 'A';
    function drawTemplate(L) {
        tctx.clearRect(0, 0, traceCanvas.width, traceCanvas.height);
        tctx.fillStyle = '#fff'; tctx.fillRect(0, 0, traceCanvas.width, traceCanvas.height);
        tctx.font = '220px Comic Sans MS, Arial'; tctx.textAlign = 'center'; tctx.textBaseline = 'middle';
        tctx.fillStyle = 'rgba(0,0,0,0.06)'; tctx.fillText(L, traceCanvas.width / 2, traceCanvas.height / 2 + 20);
    }

    traceCanvas.addEventListener('pointerdown', e => { tracing = true; const p = getPos(e); tctx.beginPath(); tctx.moveTo(p.x, p.y); });
    traceCanvas.addEventListener('pointermove', e => { if (!tracing) return; const p = getPos(e); tctx.lineTo(p.x, p.y); tctx.strokeStyle = '#ff6b6b'; tctx.lineWidth = 14; tctx.lineCap = 'round'; tctx.stroke(); });
    traceCanvas.addEventListener('pointerup', () => { tracing = false; addStars(1, 'trace'); }); // NEW: Added chapter ID
    traceCanvas.addEventListener('pointerleave', () => { tracing = false; });

    function getPos(e) { const r = traceCanvas.getBoundingClientRect(); return { x: (e.clientX || e.touches?.[0]?.clientX) - r.left, y: (e.clientY || e.touches?.[0]?.clientY) - r.top }; }

    function populateTraceButtons() {
        const container = document.getElementById('traceButtons');
        container.innerHTML = '';
        alphabet.forEach(a => {
            const b = document.createElement('div');
            b.className = 'tile';
            b.style.padding = '8px';
            b.style.minWidth = '36px';
            b.innerText = a.L;
            b.addEventListener('click', () => {
                curLetter = a.L;
                drawTemplate(a.L);
                speakText(a.L + ' for ' + a.words[0]);
            });
            container.appendChild(b);
        });
    }

    function clearTrace() { drawTemplate(curLetter); }
    function saveTrace() { const link = document.createElement('a'); link.download = `trace-${curLetter}.png`; link.href = traceCanvas.toDataURL('image/png'); link.click(); }

    /* ---------------- Sticker store ---------------- */
    function renderStore() {
        const c = document.getElementById('storeItems');
        c.innerHTML = '';
        stickers.forEach(s => {
            const d = document.createElement('div');
            d.className = 'tile';
            d.style.width = '120px';
            d.innerHTML = `<div class="sticker">${s.art}</div><div style="font-weight:900">${s.name}</div><div class="mini">${s.cost} ‚≠ê</div><div style="margin-top:6px"><button class="tab" onclick="buySticker('${s.id}')">Buy</button></div>`;
            c.appendChild(d);
        });
        updateInventory();
    }

    function buySticker(id) {
        const s = stickers.find(x => x.id === id);
        const stars = getStars();
        if (stars >= s.cost) {
            // Update user's stars
            if (currentUser && users[currentUser]) {
                users[currentUser].stars = stars - s.cost;
                saveUsers();
            }

            const inv = JSON.parse(localStorage.getItem('kids_stickers') || '[]');
            inv.push(s);
            localStorage.setItem('kids_stickers', JSON.stringify(inv));
            updateInventory();
            alert('Bought ' + s.name);
            updateStars();
        } else alert('Not enough stars');
    }

    function updateInventory() {
        const inv = JSON.parse(localStorage.getItem('kids_stickers') || '[]');
        document.getElementById('inventory').innerText = 'Your stickers: ' + (inv.map(i => i.art).join(' ') || '(none)');
        updateStars();
    }

    /* ---------------- Utilities & Init ---------------- */

    /* small extra: basicWordsFull used by quiz when needed */
    const basicWordsFull = {
        Fruits: fruits.map(f => f.name),
        Colors: colors.map(c => c.name),
        Shapes: shapes.map(s => s.name),
        BodyParts: bodyParts.map(b => b.name),
        Vehicles: vehicles.map(v => v.name),
        Classroom: classroom.map(c => c.name)
    };

    /* open math game: simple timed questions */
    function openMathGame() {
        const level = 1; startMathLevel(level);
    }

    function startMathLevel(level) {
        // show prompt modal simple alert-based for this single-file
        let correct = 0, total = 5;
        const timerStart = Date.now();
        for (let i = 0; i < total; i++) {
            const a = Math.floor(Math.random() * 10 * level) + 1, b = Math.floor(Math.random() * 10 * level) + 1;
            const op = ['+', '-', '√ó'][Math.floor(Math.random() * 3)];
            let ans = op === '+' ? a + b : op === '-' ? a - b : a * b;
            const q = `${a} ${op} ${b} = ?`;
            const r = prompt('Math question: ' + q);
            if (r === null) break;
            if (Number(r) === ans) {
                correct++;
                addStars(1, 'numbers'); // NEW: Added chapter ID
                showConfetti();
            }
        }
        alert(`Level ${level} done. Score ${correct}/${total}. Time ${(Date.now() - timerStart) / 1000}s`);
    }

    /* quick helpers */
    // Helper removed: avoid infinite recursion. Use the main startSpelling function only.

    // NEW: Apply Seasonal Themes
    function applySeasonalTheme() {
        const now = new Date();
        const month = now.getMonth();
        const themes = {
            0: { name: 'Winter', colors: ['#e3f2fd', '#bbdefb'], emoji: '‚õÑ' },
            1: { name: 'Valentine', colors: ['#fce4ec', '#f8bbd9'], emoji: '‚ù§Ô∏è' },
            4: { name: 'Spring', colors: ['#e8f5e8', '#c8e6c9'], emoji: 'üå∑' },
            9: { name: 'Halloween', colors: ['#fff3e0', '#ffcc80'], emoji: 'üéÉ' },
            11: { name: 'Christmas', colors: ['#ffebee', '#ffcdd2'], emoji: 'üéÑ' }
        };

        const theme = themes[month] || { name: 'Default', colors: ['#ffdede', '#fff7d6'], emoji: 'üåü' };

        document.documentElement.style.setProperty('--bg1', theme.colors[0]);
        document.documentElement.style.setProperty('--bg2', theme.colors[1]);

        // Add seasonal message
        const header = document.querySelector('header h1');
        if (header && !header.innerHTML.includes(theme.emoji)) {
            header.innerHTML = `üåü Kids Learning Adventure ${theme.emoji} ‚Äî Full Edition`;
        }
    }

    // NEW: Create Story Builder
    function createStoryBuilder() {
        return `
                <div class="story-builder">
                    <h3>‚úçÔ∏è Create Your Own Story!</h3>
                    <div class="story-parts">
                        <select id="characterSelect">
                            <option value="üê±">Friendly Cat</option>
                            <option value="üê∂">Happy Dog</option>
                            <option value="ü¶Ñ">Magic Unicorn</option>
                            <option value="üêª">Cuddly Bear</option>
                        </select>
                        <select id="actionSelect">
                            <option value="went to">went to</option>
                            <option value="found a">found a</option>
                            <option value="helped a">helped a</option>
                            <option value="discovered a">discovered a</option>
                        </select>
                        <select id="locationSelect">
                            <option value="the enchanted forest">the enchanted forest</option>
                            <option value="a candy castle">a candy castle</option>
                            <option value="space school">space school</option>
                            <option value="the rainbow mountain">the rainbow mountain</option>
                        </select>
                    </div>
                    <div style="text-align:center; margin:15px 0;">
                        <button class="login-btn" onclick="generateStory()" style="width:auto; padding:10px 20px;">Create Story! ‚ú®</button>
                    </div>
                    <div id="customStoryOutput" class="story-output" style="background:#f9f9f9; padding:15px; border-radius:10px; min-height:100px;"></div>
                </div>
            `;
    }

    // NEW: Generate Story Function
    function generateStory() {
        const character = document.getElementById('characterSelect').value;
        const action = document.getElementById('actionSelect').value;
        const location = document.getElementById('locationSelect').value;

        const storyTemplates = [
            `Once upon a time, ${character} ${action} ${location}. It was the most amazing adventure ever!`,
            `One sunny day, ${character} decided to ${action} ${location}. What a wonderful surprise awaited there!`,
            `In a land far away, ${character} ${action} ${location}. Everyone lived happily ever after.`,
            `${character} woke up one morning and ${action} ${location}. It was the beginning of a fantastic journey!`
        ];

        const randomStory = storyTemplates[Math.floor(Math.random() * storyTemplates.length)];

        document.getElementById('customStoryOutput').innerHTML = `
                <div style="font-size:1.2rem; line-height:1.5; text-align:center;">
                    ${randomStory}
                </div>
                <div style="text-align:center; margin-top:15px;">
                    <button class="tab" onclick="speakText('${randomStory.replace(/'/g, "\\'")}')">Read Aloud üîä</button>
                </div>
            `;

        addStars(2, 'stories');
    }

    // NEW: Create Music Studio
    function createMusicStudio() {
        return `
                <div class="music-studio">
                    <h3>üéµ Music Maker</h3>
                    <div class="instrument-selector" style="margin:15px 0;">
                        <button class="tab" data-instrument="piano" onclick="selectInstrument('piano')">üéπ Piano</button>
                        <button class="tab" data-instrument="drums" onclick="selectInstrument('drums')">ü•Å Drums</button>
                        <button class="tab" data-instrument="xylophone" onclick="selectInstrument('xylophone')">üéµ Xylophone</button>
                    </div>
                    <div class="music-keys" id="musicKeys"></div>
                    <div class="rhythm-game" style="margin-top:20px;">
                        <h4>Follow the Rhythm!</h4>
                        <div class="rhythm-pattern" id="rhythmPattern" style="font-size:2rem; text-align:center; margin:10px 0;"></div>
                        <div style="text-align:center;">
                            <button class="tab" onclick="startRhythmGame()">Play Pattern</button>
                            <button class="tab" onclick="followRhythmGame()">I'll Follow!</button>
                        </div>
                    </div>
                </div>
            `;
    }

    // NEW: Select Instrument
    function selectInstrument(instrument) {
        const keysContainer = document.getElementById('musicKeys');
        keysContainer.innerHTML = '';

        let keys = [];

        if (instrument === 'piano') {
            keys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        } else if (instrument === 'xylophone') {
            keys = ['C', 'D', 'E', 'F', 'G', 'A', 'B', 'C2'];
        } else if (instrument === 'drums') {
            keys = ['Bass', 'Snare', 'Hi-Hat', 'Cymbal', 'Tom'];
        }

        keys.forEach(key => {
            const keyElement = document.createElement('div');
            keyElement.className = 'music-key';
            keyElement.textContent = key;
            keyElement.addEventListener('click', () => playSound(instrument, key));
            keysContainer.appendChild(keyElement);
        });
    }

    // NEW: Play Sound Function (FIXED: AudioContext singleton + event null check)
    window.audioContext = null;
    function playSound(instrument, note, eventElement = null) {
        try {
            if (!window.audioContext) {
                window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const audioContext = window.audioContext;

            // Resume if suspended
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Different frequencies for different notes
            const frequencies = {
                'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23,
                'G': 392.00, 'A': 440.00, 'B': 493.88, 'C2': 523.25
            };

            if (instrument === 'piano' || instrument === 'xylophone') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequencies[note] || 440, audioContext.currentTime);
            } else if (instrument === 'drums') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
            }

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);

            // Visual feedback (safe with null check)
            const element = eventElement || (typeof event !== 'undefined' ? event.target : null);
            if (element && element.classList) {
                element.classList.add('playing');
                setTimeout(() => {
                    if (element.classList) element.classList.remove('playing');
                }, 200);
            }
        } catch (e) {
            console.warn('Audio playback error:', e);
        }
    }

    // NEW: Rhythm Game
    function startRhythmGame() {
        const patterns = [
            ['C', 'C', 'G', 'G'],
            ['C', 'D', 'E', 'C'],
            ['E', 'F', 'G', 'G'],
            ['G', 'A', 'G', 'F']
        ];

        const pattern = patterns[Math.floor(Math.random() * patterns.length)];
        document.getElementById('rhythmPattern').textContent = pattern.join(' ‚Ä¢ ');

        // Play the pattern
        let i = 0;
        function playNextNote() {
            if (i < pattern.length) {
                speakText(pattern[i]);
                i++;
                setTimeout(playNextNote, 800);
            }
        }
        playNextNote();
    }

    function followRhythmGame() {
        speakText("Great! Now try to play the pattern yourself!");
        addStars(2, 'games');
    }

    // NEW: Create Emotions Center
    function createEmotionsCenter() {
        return `
                <div class="emotions-center">
                    <h3>üòä Feelings & Friends</h3>
                    <div class="emotion-characters">
                        <div class="emotion-character" data-emotion="happy" onclick="exploreEmotion('happy')">
                            <div class="character-face">üòä</div>
                            <div>Happy</div>
                        </div>
                        <div class="emotion-character" data-emotion="sad" onclick="exploreEmotion('sad')">
                            <div class="character-face">üò¢</div>
                            <div>Sad</div>
                        </div>
                        <div class="emotion-character" data-emotion="excited" onclick="exploreEmotion('excited')">
                            <div class="character-face">üòÉ</div>
                            <div>Excited</div>
                        </div>
                        <div class="emotion-character" data-emotion="calm" onclick="exploreEmotion('calm')">
                            <div class="character-face">üòå</div>
                            <div>Calm</div>
                        </div>
                    </div>
                    <div class="emotion-stories" style="margin-top:20px;">
                        <h4>How would you feel?</h4>
                        <div class="scenario" style="background:#f0f0f0; padding:15px; border-radius:10px; margin:10px 0;">
                            "Your friend shares their toy with you..."
                        </div>
                        <div class="emotion-options" id="emotionOptions" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;"></div>
                    </div>
                    <div id="emotionFeedback" style="margin-top:15px; text-align:center;"></div>
                </div>
            `;
    }

    // NEW: Explore Emotion
    function exploreEmotion(emotion) {
        const emotionMessages = {
            happy: "Happiness feels warm and joyful! Smile and share your happiness with others!",
            sad: "It's okay to feel sad sometimes. Talking to someone can help you feel better.",
            excited: "Excitement is like butterflies in your tummy! It means something fun is happening!",
            calm: "Feeling calm is peaceful and quiet. Take deep breaths to stay calm."
        };

        speakText(emotionMessages[emotion]);
        document.getElementById('emotionFeedback').innerHTML = `
                <div class="panel" style="background:#e8f5e9;">
                    <div class="big">${emotionMessages[emotion]}</div>
                </div>
            `;

        // Set up emotion scenario
        setupEmotionScenario();
    }

    // NEW: Setup Emotion Scenario
    function setupEmotionScenario() {
        const scenarios = [
            {
                scenario: "Your friend shares their toy with you...",
                options: ["üòä Happy", "üò¢ Sad", "üò† Angry"],
                correct: "üòä Happy"
            },
            {
                scenario: "You can't find your favorite book...",
                options: ["üòä Happy", "üò¢ Sad", "üòÉ Excited"],
                correct: "üò¢ Sad"
            },
            {
                scenario: "It's your birthday today!",
                options: ["üòå Calm", "üòÉ Excited", "üò¢ Sad"],
                correct: "üòÉ Excited"
            }
        ];

        const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];

        document.querySelector('.scenario').textContent = `"${randomScenario.scenario}"`;

        const optionsContainer = document.getElementById('emotionOptions');
        optionsContainer.innerHTML = '';

        randomScenario.options.forEach(option => {
            const optionBtn = document.createElement('button');
            optionBtn.className = 'tab';
            optionBtn.textContent = option;
            optionBtn.onclick = () => checkEmotionAnswer(option, randomScenario.correct);
            optionsContainer.appendChild(optionBtn);
        });
    }

    // NEW: Check Emotion Answer
    function checkEmotionAnswer(selected, correct) {
        if (selected === correct) {
            speakText("That's right! Good job understanding feelings!");
            document.getElementById('emotionFeedback').innerHTML = `
                    <div class="panel" style="background:#e8f5e9;">
                        <div class="big">That's right! Good job understanding feelings! üåü</div>
                    </div>
                `;
            addStars(2, 'games');
            showConfetti();
        } else {
            speakText("Think about how you would feel in that situation. Try again!");
            document.getElementById('emotionFeedback').innerHTML = `
                    <div class="panel" style="background:#ffebee;">
                        <div class="big">Think about how you would feel in that situation. Try again!</div>
                    </div>
                `;
        }
    }

    // NEW: Create Real World Challenges
    function createRealWorldChallenges() {
        return `
                <div class="real-world-challenges">
                    <h3>üåç Learning Adventures in Your Home!</h3>
                    <div class="challenge-list">
                        <div class="challenge">
                            <h4>üîç Shape Hunt</h4>
                            <p>Find 3 circle-shaped objects in your room!</p>
                            <button class="tab" onclick="startShapeHunt()">Start Hunt!</button>
                        </div>
                        <div class="challenge">
                            <h4>üé® Color Collection</h4>
                            <p>Gather 5 red items and take their picture!</p>
                            <button class="tab" onclick="startColorCollection()">Start Collection!</button>
                        </div>
                        <div class="challenge">
                            <h4>üìè Measurement Fun</h4>
                            <p>Measure 3 objects using your hands as rulers!</p>
                            <button class="tab" onclick="startMeasurementGame()">Start Measuring!</button>
                        </div>
                        <div class="challenge">
                            <h4>üî¢ Counting Walk</h4>
                            <p>Count how many windows you can see from your room!</p>
                            <button class="tab" onclick="startCountingWalk()">Start Counting!</button>
                        </div>
                    </div>
                    <div id="challengeResult" style="margin-top:20px;"></div>
                </div>
            `;
    }

    // NEW: Real World Challenge Functions
    function startShapeHunt() {
        speakText("Let's go on a shape hunt! Find three circle shaped objects in your room. When you find them, come back and tap this button!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#e3f2fd;">
                    <h4>Shape Hunt Started! üïµÔ∏è‚Äç‚ôÄÔ∏è</h4>
                    <p>Find 3 circle-shaped objects in your room!</p>
                    <p>Examples: plate, clock, bottle cap</p>
                    <button class="tab" onclick="completeShapeHunt()">I Found Them! üéâ</button>
                </div>
            `;
    }

    function completeShapeHunt() {
        speakText("Wow! You're a great shape hunter! You found all the circles!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#e8f5e9;">
                    <h4>üéâ Shape Hunt Complete!</h4>
                    <p>You're a shape detective! Great job finding circles in your home!</p>
                </div>
            `;
        addStars(3, 'shapes');
        showConfetti();
    }

    function startColorCollection() {
        speakText("Let's collect red items! Find 5 red things around your home. When you're done, come back and tell me!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#ffebee;">
                    <h4>Color Collection Started! üé®</h4>
                    <p>Find 5 red items in your home!</p>
                    <p>Examples: red toy, book cover, clothing</p>
                    <button class="tab" onclick="completeColorCollection()">I Collected Them! üéâ</button>
                </div>
            `;
    }

    function completeColorCollection() {
        speakText("Amazing! You found so many red things! You're a color expert!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#e8f5e9;">
                    <h4>üéâ Color Collection Complete!</h4>
                    <p>You're a color expert! Great job finding red items in your home!</p>
                </div>
            `;
        addStars(3, 'colors');
        showConfetti();
    }

    function startMeasurementGame() {
        speakText("Let's measure things with your hands! Choose 3 objects and count how many hands long they are!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#fff3e0;">
                    <h4>Measurement Fun! üìè</h4>
                    <p>Measure 3 objects using your hands as rulers!</p>
                    <p>Examples: table, book, pillow</p>
                    <button class="tab" onclick="completeMeasurementGame()">I Measured Them! üéâ</button>
                </div>
            `;
    }

    function completeMeasurementGame() {
        speakText("Fantastic! You're learning about measurement! Knowing how to measure things is very useful!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#e8f5e9;">
                    <h4>üéâ Measurement Complete!</h4>
                    <p>You're learning about size and measurement! Great job!</p>
                </div>
            `;
        addStars(3, 'numbers');
        showConfetti();
    }

    function startCountingWalk() {
        speakText("Let's count windows! Look around your room and count how many windows you can see!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#e8f5e9;">
                    <h4>Counting Walk! üî¢</h4>
                    <p>Count how many windows you can see from your room!</p>
                    <button class="tab" onclick="completeCountingWalk()">I Counted Them! üéâ</button>
                </div>
            `;
    }

    function completeCountingWalk() {
        speakText("Excellent counting! You're getting really good at numbers!");
        document.getElementById('challengeResult').innerHTML = `
                <div class="panel" style="background:#e8f5e9;">
                    <h4>üéâ Counting Complete!</h4>
                    <p>You're becoming a counting expert! Great job!</p>
                </div>
            `;
        addStars(3, 'numbers');
        showConfetti();
    }

    // NEW: Virtual Pet Class
    class LearningPet {
        constructor() {
            this.level = 1;
            this.happiness = 100;
            this.energy = 100;
            this.outfit = 'default';
            this.name = 'Buddy';
        }

        feed() {
            this.energy = Math.min(100, this.energy + 20);
            this.updatePetDisplay();
            speakText("Yum! Thank you for the food!");
        }

        playGame() {
            this.happiness = Math.min(100, this.happiness + 15);
            this.energy = Math.max(0, this.energy - 10);
            this.updatePetDisplay();
            speakText("Wheee! That was fun!");
        }

        levelUp() {
            this.level++;
            showConfetti();
            speakText(`Wow! ${this.name} reached level ${this.level}!`);
            this.updatePetDisplay();
        }

        getPetEmoji() {
            if (this.happiness > 80) return 'üòä';
            if (this.happiness > 50) return 'üòê';
            return 'üò¢';
        }

        updatePetDisplay() {
            const petDisplay = document.getElementById('petDisplay');
            if (petDisplay) {
                petDisplay.innerHTML = this.getPetHTML();
            }
        }

        getPetHTML() {
            return `
                    <div class="virtual-pet">
                        <div class="pet-display level-${this.level}">
                            <div class="pet-face">${this.getPetEmoji()}</div>
                            <div class="pet-name">${this.name}</div>
                            <div class="pet-stats">
                                <div class="stat">‚ù§Ô∏è ${this.happiness}%</div>
                                <div class="stat">‚ö° ${this.energy}%</div>
                                <div class="stat">‚≠ê Level ${this.level}</div>
                            </div>
                        </div>
                        <div class="pet-actions">
                            <button class="tab" onclick="learningPet.feed()">üçé Feed</button>
                            <button class="tab" onclick="learningPet.playGame()">üéæ Play</button>
                            <button class="tab" onclick="learningPet.levelUp()">üéØ Level Up</button>
                        </div>
                    </div>
                `;
        }
    }

    // NEW: Create Features Showcase
    function createFeaturesShowcase() {
        return `
            <div class="features-showcase">
                <h3 style="text-align: center; color: #ff6b6b; margin-bottom: 20px;">‚ú® Welcome to Kids Learning Adventure! ‚ú®</h3>
                
                <div style="background: linear-gradient(135deg, #ffdede, #fff7d6); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <p style="font-size: 1.1rem; text-align: center; color: #333;">
                        Your complete learning platform with <strong>offline support</strong>, <strong>database integration</strong>, and <strong>professional code structure</strong>! üöÄ
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div class="panel" style="background: linear-gradient(135deg, #ff9da0, #ffc7ce); border-left: 5px solid #ff6b6b;">
                        <h4>üéì User Accounts</h4>
                        <p>Register with character emoji. Personalize your learning!</p>
                        <button class="tab" onclick="alert('Account features are active!')">Try It ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #a0e7d6, #c0f0e8); border-left: 5px solid #6ee7b7;">
                        <h4>üî§ Alphabet Learning</h4>
                        <p>Learn A-Z with phonics and example words!</p>
                        <button class="tab" onclick="switchTab('alphabet', document.querySelector('.tab[data-tab=alphabet]'))">Try It ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #ffd8a0, #ffe8c0); border-left: 5px solid #ff9f43;">
                        <h4>üî¢ Numbers & Counting</h4>
                        <p>Count 1-100 with pictures and songs!</p>
                        <button class="tab" onclick="switchTab('numbers', document.querySelector('.tab[data-tab=numbers]'))">Try It ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #a0c0ff, #c0d8ff); border-left: 5px solid #4da6ff;">
                        <h4>üé® Colors & Shapes</h4>
                        <p>Explore colors and shapes visually!</p>
                        <button class="tab" onclick="switchTab('colors', document.querySelector('.tab[data-tab=colors]'))">Colors</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #d0a0ff, #e0c0ff); border-left: 5px solid #9b59b6;">
                        <h4>üéµ Music & Games</h4>
                        <p>Simon Memory game, music maker & more!</p>
                        <button class="tab" onclick="switchTab('games', document.querySelector('.tab[data-tab=games]'))">Games</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #ffe0a0, #fff0c0); border-left: 5px solid #f39c12;">
                        <h4>üáÆüá≥ Hindi Language</h4>
                        <p>20+ Hindi words with audio (hi-IN TTS)!</p>
                        <button class="tab" onclick="switchTab('hindi', document.querySelector('.tab[data-tab=hindi]'))">Hindi ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #a0ffa0, #c0ffc0); border-left: 5px solid #2ecc71;">
                        <h4>üß† Memory & Patterns</h4>
                        <p>Simon game, patterns & puzzles!</p>
                        <button class="tab" onclick="switchTab('games', document.querySelector('.tab[data-tab=games]'))">Play ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #ffa0d0, #ffc0e0); border-left: 5px solid #e74c3c;">
                        <h4>üìä Parent Dashboard</h4>
                        <p>Track progress with analytics!</p>
                        <button class="tab" onclick="switchTab('parent', document.querySelector('.tab[data-tab=parent]'))">Dashboard ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #b0e0ff, #d0e8ff); border-left: 5px solid #3498db;">
                        <h4>‚öôÔ∏è Accessibility</h4>
                        <p>Dyslexia fonts, colorblind mode!</p>
                        <button class="tab" onclick="switchTab('settings', document.querySelector('.tab[data-tab=settings]'))">Settings ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #d0ffa0, #e0ffc0); border-left: 5px solid #27ae60;">
                        <h4>üåç Learning Modules</h4>
                        <p>Science, Geography, Time & Money!</p>
                        <button class="tab" onclick="switchTab('science', document.querySelector('.tab[data-tab=science]'))">Explore ‚Üí</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #ffc0a0, #ffe0c0); border-left: 5px solid #ff8c42;">
                        <h4>üíæ Offline Support</h4>
                        <p>Works offline with sync!</p>
                        <button class="tab" onclick="alert('‚úÖ Offline mode active!')">Learn More</button>
                    </div>
                    <div class="panel" style="background: linear-gradient(135deg, #e0a0ff, #f0c0ff); border-left: 5px solid #a855f7;">
                        <h4>üèÜ Rewards System</h4>
                        <p>Earn stars & unlock rewards!</p>
                        <button class="tab" onclick="switchTab('rewards', document.querySelector('.tab[data-tab=rewards]'))">Rewards ‚Üí</button>
                    </div>
                </div>

                <div style="background: #f0f0f0; padding: 20px; border-radius: 15px; margin-top: 30px; text-align: center;">
                    <h3 style="color: #333; margin-top: 0;">üöÄ Technology Stack</h3>
                    <p style="color: #666;">
                        <strong>Frontend:</strong> HTML5 + CSS3 + Vanilla JavaScript | <strong>Backend:</strong> Django REST API | <strong>Status:</strong> ‚úÖ Production-Ready
                    </p>
                </div>

                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #2ecc71; text-align: center;">
                    <h4 style="color: #2ecc71; margin: 0;">‚ú® Key Highlights</h4>
                    <p style="color: #333; margin: 10px 0;">‚úÖ 20+ Modules | ‚úÖ 6+ Games | ‚úÖ Hindi Audio | ‚úÖ Analytics | ‚úÖ Offline | ‚úÖ Accessible | ‚úÖ Parent Controls</p>
                </div>
            </div>
        `;
    }

    // NEW: Create virtual pet instance
    let learningPet = new LearningPet();

    // ========== SPELLING QUIZ ==========
    function initSpelling() {
        const spellingQuizzes = [
            { correct: 'cat', wrong: ['catt', 'cta', 'caht'] },
            { correct: 'dog', wrong: ['dgo', 'og', 'dod'] },
            { correct: 'apple', wrong: ['aple', 'apel', 'appel'] },
            { correct: 'book', wrong: ['bok', 'boo', 'boook'] },
            { correct: 'tree', wrong: ['tre', 'tere', 'tere'] }
        ];

        const quiz = spellingQuizzes[Math.floor(Math.random() * spellingQuizzes.length)];
        const options = [quiz.correct, ...quiz.wrong].sort(() => Math.random() - 0.5);

        let html = `<div style="text-align:center;font-size:1.5rem;margin:20px;color:#ff6b6b;font-weight:700">Listen:</div>`;
        html += `<div style="text-align:center;margin:20px"><button class="tab" onclick="speakText('${quiz.correct}')">üîä Hear Word</button></div>`;
        html += `<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:10px">`;

        options.forEach(opt => {
            html += `<button class="tile" onclick="${opt === quiz.correct ? `speakText('Correct! ${opt}'); addStars(5, 'spelling')` : `speakText('Try again'); shakeElement(event.target)`}" style="padding:20px;font-size:1.2rem;cursor:pointer;transition:all 0.3s;border:3px solid #ddd;border-radius:10px">
                ${opt}
            </button>`;
        });

        html += `</div>`;
        document.getElementById('spellingQuiz').innerHTML = html;
    }

    // ========== WORD MATCHING ==========
    function initWordMatch() {
        const pairs = [
            { emoji: 'üêï', word: 'dog' },
            { emoji: 'üêà', word: 'cat' },
            { emoji: 'üçé', word: 'apple' },
            { emoji: 'üìö', word: 'book' },
            { emoji: 'üå≥', word: 'tree' }
        ];

        const currentPair = pairs[Math.floor(Math.random() * pairs.length)];
        let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">`;
        html += `<div style="text-align:center"><div style="font-size:5rem;margin:20px">${currentPair.emoji}</div><p style="color:#666">Which word?</p></div>`;

        const shuffled = [...pairs].sort(() => Math.random() - 0.5);
        html += `<div style="display:grid;gap:10px">`;
        shuffled.forEach(p => {
            html += `<button class="tab" onclick="${p.word === currentPair.word ? `speakText('Correct! It is ' + '${p.word}'); addStars(5, 'wordmatch')` : `speakText('Try again')`}" style="padding:15px;font-size:1.1rem;cursor:pointer">${p.word}</button>`;
        });
        html += `</div></div>`;

        document.getElementById('wordmatchGame').innerHTML = html;
    }

    // ========== TRUE OR FALSE ==========
    function initTrueFalse() {
        const statements = [
            { text: 'A cat is a dog', answer: false },
            { text: 'An apple is a fruit', answer: true },
            { text: 'A tree can fly', answer: false },
            { text: 'A book has words', answer: true },
            { text: 'Fish can swim', answer: true },
            { text: 'The sun is cold', answer: false },
            { text: 'Dogs bark', answer: true }
        ];

        const statement = statements[Math.floor(Math.random() * statements.length)];
        speakText(statement.text);

        let html = `<div style="font-size:1.5rem;margin:30px;color:#333;font-weight:700;text-align:center">"${statement.text}"</div>`;
        html += `<div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap">`;
        html += `<button class="tile" onclick="${statement.answer === true ? `speakText('Correct!'); addStars(5, 'truefalse')` : `speakText('Try again')`}" style="padding:20px 30px;font-size:1.3rem;background:#6ee7b7;color:#333;border:3px solid #27ae60;border-radius:10px;cursor:pointer">‚úì True</button>`;
        html += `<button class="tile" onclick="${statement.answer === false ? `speakText('Correct!'); addStars(5, 'truefalse')` : `speakText('Try again')`}" style="padding:20px 30px;font-size:1.3rem;background:#ff6b6b;color:white;border:3px solid #c92a2a;border-radius:10px;cursor:pointer">‚úó False</button>`;
        html += `</div>`;

        document.getElementById('truefalseGame').innerHTML = html;
    }

    // ========== COUNTING GAME ==========
    function initCounting() {
        const items = [
            { count: 3, emoji: 'üçé' },
            { count: 5, emoji: 'üåü' },
            { count: 2, emoji: 'üêï' },
            { count: 4, emoji: 'üéà' },
            { count: 6, emoji: 'üê†' },
            { count: 3, emoji: 'üéÅ' }
        ];

        const item = items[Math.floor(Math.random() * items.length)];
        let html = `<div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin:20px">`;

        for (let i = 0; i < item.count; i++) {
            html += `<span style="font-size:3rem">${item.emoji}</span>`;
        }

        html += `</div><p style="text-align:center;font-size:1.2rem;color:#666;font-weight:700">How many ${item.emoji}?</p>`;
        html += `<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;max-width:300px;margin:20px auto">`;

        for (let n = 1; n <= 6; n++) {
            html += `<button class="tile" onclick="${n === item.count ? `speakText('Correct!'); addStars(5, 'counting')` : `speakText('Try again')`}" style="padding:15px;font-size:1.2rem;cursor:pointer;border-radius:8px">${n}</button>`;
        }

        html += `</div>`;
        document.getElementById('countingGame').innerHTML = html;
    }

    // ========== PHONICS PRACTICE ==========
    function initPhonics() {
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        const sounds = {
            'A': { word: 'Apple', hint: 'Say like "AYY"' },
            'B': { word: 'Ball', hint: 'Say like "BEE"' },
            'C': { word: 'Cat', hint: 'Say like "SEE"' },
            'D': { word: 'Dog', hint: 'Say like "DEE"' },
            'E': { word: 'Elephant', hint: 'Say like "EHH"' },
            'F': { word: 'Fish', hint: 'Say like "EFF"' },
            'G': { word: 'Giraffe', hint: 'Say like "JEE"' },
            'H': { word: 'Hat', hint: 'Say like "AYCH"' },
            'I': { word: 'Ice cream', hint: 'Say like "EYE"' },
            'J': { word: 'Jellyfish', hint: 'Say like "JAY"' },
            'K': { word: 'Kite', hint: 'Say like "KAY"' },
            'L': { word: 'Lion', hint: 'Say like "ELL"' },
            'M': { word: 'Monkey', hint: 'Say like "EMM"' },
            'N': { word: 'Nest', hint: 'Say like "ENN"' },
            'O': { word: 'Orange', hint: 'Say like "OH"' },
            'P': { word: 'Pig', hint: 'Say like "PEE"' },
            'Q': { word: 'Queen', hint: 'Say like "KYOO"' },
            'R': { word: 'Rabbit', hint: 'Say like "AHR"' },
            'S': { word: 'Sun', hint: 'Say like "ESS"' },
            'T': { word: 'Tiger', hint: 'Say like "TEE"' },
            'U': { word: 'Umbrella', hint: 'Say like "OOO"' },
            'V': { word: 'Violin', hint: 'Say like "VEE"' },
            'W': { word: 'Watch', hint: 'Say like "DOUBLE-YOO"' },
            'X': { word: 'Xylophone', hint: 'Say like "ZEX"' },
            'Y': { word: 'Yo-yo', hint: 'Say like "WHY"' },
            'Z': { word: 'Zebra', hint: 'Say like "ZEE"' }
        };

        // Enhanced header with instructions
        let html = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                <h3 style="margin: 0 0 5px 0;">üî§ Phonics Learning</h3>
                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Click any letter to hear its sound and see pronunciation tips</p>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(70px, 1fr));gap:10px">
        `;

        letters.forEach(letter => {
            const sound = sounds[letter];
            html += `
                <div style="text-align: center; cursor: pointer; transition: all 0.3s;" 
                     onmouseover="this.style.transform='scale(1.1)'" 
                     onmouseout="this.style.transform='scale(1)'">
                    <button class="tile" onclick="PronunciationModule.playPronunciation('${letter}', 'alphabet')" 
                        title="${sound.word} - ${sound.hint}"
                        style="padding:12px; font-size:1.2rem; font-weight:700; cursor:pointer; 
                        transition:all 0.3s; border:3px solid #ffd166; border-radius:10px; 
                        background: linear-gradient(135deg, #fffacd, #ffd166); width: 100%; 
                        box-shadow: 0 4px 8px rgba(255, 209, 102, 0.3);">
                        ${letter}
                    </button>
                    <div style="font-size: 0.75rem; color: #666; margin-top: 5px; font-weight: 600;">
                        ${sound.word}
                    </div>
                    <div style="font-size: 0.7rem; color: #999; margin-top: 2px;">
                        üí° ${sound.hint}
                    </div>
                </div>
            `;
        });
        html += `</div>`;

        document.getElementById('phonicsGame').innerHTML = html;
    }

    // ========== SHAPE SORTING ==========
    function initShapeSorting() {
        let html = `<div style="grid-column:1/-1;text-align:center;font-weight:700;color:#ff6b6b;margin-bottom:10px">Click to sort shapes to correct category</div>`;
        html += `<div style="border:3px dashed #ff6b6b;padding:20px;text-align:center;min-height:120px;border-radius:10px"><h4 style="margin:0 0 10px 0">üî¥ Circles</h4><div id="circleTarget" style="min-height:60px"></div></div>`;
        html += `<div style="border:3px dashed #ffd166;padding:20px;text-align:center;min-height:120px;border-radius:10px"><h4 style="margin:0 0 10px 0">üü© Squares</h4><div id="squareTarget" style="min-height:60px"></div></div>`;

        html += `<div style="grid-column:1/-1;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:20px 0">`;
        html += `<button class="tile" onclick="moveToCategory(this, 'circle')" style="font-size:2rem;cursor:pointer;border:3px solid #999;border-radius:8px;padding:10px 15px">üî¥</button>`;
        html += `<button class="tile" onclick="moveToCategory(this, 'square')" style="font-size:2rem;cursor:pointer;border:3px solid #999;border-radius:8px;padding:10px 15px">üü©</button>`;
        html += `<button class="tile" onclick="moveToCategory(this, 'circle')" style="font-size:2rem;cursor:pointer;border:3px solid #999;border-radius:8px;padding:10px 15px">‚≠ï</button>`;
        html += `<button class="tile" onclick="moveToCategory(this, 'square')" style="font-size:2rem;cursor:pointer;border:3px solid #999;border-radius:8px;padding:10px 15px">‚¨ú</button>`;
        html += `</div>`;

        document.getElementById('shapeSortGame').innerHTML = html;
    }

    function moveToCategory(btn, category) {
        const target = category === 'circle' ? document.getElementById('circleTarget') : document.getElementById('squareTarget');
        const clone = btn.cloneNode(true);
        clone.style.margin = '5px';
        clone.style.cursor = 'default';
        target.appendChild(clone);
        btn.style.opacity = '0.3';
        speakText('Good!');

        if (target.children.length === 2) {
            addStars(5, 'shapesort');
            speakText('Great job sorting!');
        }
    }

    // ========== SPOT THE DIFFERENCE ==========
    function initSpotDifference() {
        let html = `<div style="grid-column:1/-1;text-align:center;font-weight:700;color:#ff6b6b;margin-bottom:10px">üîç Find what's different!</div>`;
        html += `<div style="text-align:center;padding:15px;border:3px solid #ff6b6b;border-radius:10px;background:#ffe6e6">
            <div style="font-size:2.5rem">üê∂üçéüåü</div>
            <p style="color:#666;margin:5px 0">Left</p>
        </div>`;
        html += `<div style="text-align:center;padding:15px;border:3px solid #ffd166;border-radius:10px;background:#fffacd">
            <div style="font-size:2.5rem">üê∂üçé‚≠ê</div>
            <p style="color:#666;margin:5px 0">Right</p>
        </div>`;
        html += `<div style="grid-column:1/-1;text-align:center;color:#666;margin-top:10px"><small>(Hint: The star is different!)</small></div>`;

        document.getElementById('spotDiffGame').innerHTML = html;
    }

    // Helper function to add stars
    function addStars(amount, source) {
        if (!currentUser || !users[currentUser]) return;
        users[currentUser].stars = (users[currentUser].stars || 0) + amount;
        const badge = document.getElementById('pointsBadge');
        if (badge) badge.textContent = `Stars: ${users[currentUser].stars}`;
        saveUsers();
        showConfetti();
    }

    // Initialize all new games when user switches to them
    function initializeNewGames() {
        const currentTab = document.querySelector('.panel:not([style*="display: none"])');
        if (!currentTab) return;

        const id = currentTab.id;
        if (id === 'spelling') initSpelling();
        else if (id === 'wordmatch') initWordMatch();
        else if (id === 'truefals') initTrueFalse();
        else if (id === 'counting') initCounting();
        else if (id === 'shapes_sort') initShapeSorting();
        else if (id === 'spotdiff') initSpotDifference();
    }

</script>
<script src="{% static 'main/error_fixes.js' %}"></script>
<script src="{% static 'main/add_new_features.js' %}"></script>
<script src="{% static 'main/enhanced_learning.js' %}"></script>
<script src="{% static 'main/interactive_features.js' %}"></script>
{% endblock %}